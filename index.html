<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#1e3a5f">
    <title>CC & LUCIA | Central Kitchen Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary-color: #1e3a5f;
            --primary-light: #2c5282;
            --accent-color: #ff6b35;
            --accent-hover: #e85d2c;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-dark: #1e293b;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --gradient-primary: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            --gradient-dark: linear-gradient(135deg, #1e3a5f 0%, #2c5282 100%);
            --gradient-success: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --sync-color: #8b5cf6;
            --prep-color: #06b6d4;
            --prep-gradient: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            --ai-color: #ec4899;
            --ai-gradient: linear-gradient(135deg, #ec4899 0%, #be185d 100%);
            --ar-color: #8b5cf6;

        }

        [data-bs-theme="dark"] {
            --primary-color: #3b82f6;
            --primary-light: #60a5fa;
            --accent-color: #f97316;
            --accent-hover: #ea580c;
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-dark: #f1f5f9;
            --text-muted: #94a3b8;
            --border-color: #334155;
            --gradient-primary: linear-gradient(135deg, #f97316 0%, #fb923c 100%);
            --gradient-dark: linear-gradient(135deg, #020617 0%, #0f172a 100%);
        }

        * {
            transition: background-color 0.3s ease, color 0.2s ease, border-color 0.3s ease;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-dark);
            overflow-x: hidden;
        }

        /* ===== GLASSMORPHISM EFFECTS (WEEK 1) ===== */
        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        [data-bs-theme="dark"] .glass-card {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-modal .modal-content {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        [data-bs-theme="dark"] .glass-modal .modal-content {
            background: rgba(30, 41, 59, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-header {
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.9) 0%, rgba(247, 147, 30, 0.9) 100%);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
        }

        .glass-sidebar {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.3);
        }

        [data-bs-theme="dark"] .glass-sidebar {
            background: rgba(15, 23, 42, 0.85);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* ===== ANIMATIONS (WEEK 1) ===== */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 107, 53, 0.4); }
            50% { box-shadow: 0 0 40px rgba(255, 107, 53, 0.8); }
        }

        @keyframes slide-up {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes scale-in {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .animate-float { animation: float 3s ease-in-out infinite; }
        .animate-pulse-glow { animation: pulse-glow 2s ease-in-out infinite; }
        .animate-slide-up { animation: slide-up 0.5s ease-out; }
        .animate-scale-in { animation: scale-in 0.3s ease-out; }

        .shimmer-effect {
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
        }

        /* Hover animations */
        .hover-lift {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .hover-lift:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .hover-scale {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .hover-scale:hover {
            transform: scale(1.05);
        }

        .hover-glow:hover {
            box-shadow: 0 0 30px rgba(255, 107, 53, 0.5);
        }

        /* Card entrance animations */
        .card-entrance {
            opacity: 0;
            animation: slide-up 0.5s ease-out forwards;
        }

        .card-entrance:nth-child(1) { animation-delay: 0.1s; }
        .card-entrance:nth-child(2) { animation-delay: 0.2s; }
        .card-entrance:nth-child(3) { animation-delay: 0.3s; }
        .card-entrance:nth-child(4) { animation-delay: 0.4s; }

        /* ===== SPARKLINE CHARTS (WEEK 2) ===== */
        .sparkline-container {
            position: relative;
            height: 40px;
            width: 100%;
            margin-top: 10px;
        }

        .stat-trend {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.8rem;
            margin-top: 8px;
        }

        .trend-up { color: var(--success-color); }
        .trend-down { color: var(--danger-color); }

        /* ===== KDS FULL-SCREEN MODE (WEEK 3) ===== */
        #kds-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            z-index: 10000;
            display: none;
            overflow: hidden;
        }

        #kds-fullscreen.active {
            display: flex;
            flex-direction: column;
        }

        .kds-header {
            background: linear-gradient(135deg, #1e3a5f 0%, #2c5282 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .kds-clock {
            font-size: 2.5rem;
            font-weight: 800;
            font-family: 'Courier New', monospace;
        }

        .kds-content {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            padding: 20px;
            overflow-y: auto;
            background: #0a0a0a;
        }

        .kds-column {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            min-height: 100%;
        }

        .kds-column-header {
            font-size: 1.5rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            padding-bottom: 15px;
            margin-bottom: 15px;
            border-bottom: 3px solid;
        }

        .kds-pending .kds-column-header { color: #f59e0b; border-color: #f59e0b; }
        .kds-progress .kds-column-header { color: #06b6d4; border-color: #06b6d4; }
        .kds-completed .kds-column-header { color: #10b981; border-color: #10b981; }

        .kds-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid;
        }

        .kds-card:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }

        .kds-card.pending { border-left-color: #f59e0b; }
        .kds-card.in-progress { border-left-color: #06b6d4; }
        .kds-card.completed { border-left-color: #10b981; opacity: 0.6; }

        .kds-card-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: white;
            margin-bottom: 8px;
        }

        .kds-card-details {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1rem;
        }

        .kds-card-time {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.85rem;
            margin-top: 10px;
        }

        .kds-exit-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10001;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            display: none;
        }

        #kds-fullscreen.active .kds-exit-btn {
            display: block;
        }

        /* ===== AI PREP PREDICTIONS (MONTH 2) ===== */
        .ai-prediction-card {
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.1) 0%, rgba(190, 24, 93, 0.1) 100%);
            border: 2px solid var(--ai-color);
            border-radius: 16px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .ai-prediction-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(236, 72, 153, 0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .ai-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--ai-gradient);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
        }

        .ai-confidence {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }

        .confidence-bar {
            flex: 1;
            height: 8px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: var(--ai-gradient);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .prediction-factor {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            margin-top: 8px;
            font-size: 0.85rem;
        }

        /* ===== AR STOCK SCANNING (MONTH 2) ===== */
        .ar-scanner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            display: none;
        }

        .ar-scanner-overlay.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .ar-viewfinder {
            position: relative;
            width: 80vw;
            max-width: 600px;
            height: 60vh;
            border: 3px solid var(--ar-color);
            border-radius: 20px;
            overflow: hidden;
        }

        .ar-viewfinder::before,
        .ar-viewfinder::after {
            content: '';
            position: absolute;
            width: 40px;
            height: 40px;
            border: 4px solid var(--ar-color);
        }

        .ar-viewfinder::before {
            top: 10px;
            left: 10px;
            border-right: none;
            border-bottom: none;
        }

        .ar-viewfinder::after {
            bottom: 10px;
            right: 10px;
            border-left: none;
            border-top: none;
        }

        .ar-scan-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, transparent, var(--ar-color), transparent);
            animation: scan-line 2s ease-in-out infinite;
        }

        @keyframes scan-line {
            0%, 100% { top: 0; }
            50% { top: 100%; }
        }

        .ar-info-panel {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(139, 92, 246, 0.9);
            backdrop-filter: blur(10px);
            padding: 20px 30px;
            border-radius: 16px;
            color: white;
            min-width: 300px;
            text-align: center;
        }

        .ar-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(139, 92, 246, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
        }



        /* ===== EXISTING STYLES (ENHANCED) ===== */
        .theme-toggle-sidebar {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 50px;
            padding: 10px 16px;
            cursor: pointer;
            color: var(--text-dark);
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 12px;
            font-size: 0.9rem;
        }

        .theme-toggle-sidebar:hover {
            border-color: var(--accent-color);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .user-profile-sidebar {
            background: var(--card-bg);
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-dark);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 12px;
            width: 100%;
        }

        .sync-status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

        .sync-status-indicator.synced {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .sync-status-indicator.syncing {
            background: rgba(139, 92, 246, 0.1);
            color: var(--sync-color);
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        .sync-status-indicator.error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .sync-status-indicator.offline {
            background: rgba(148, 163, 184, 0.1);
            color: var(--text-muted);
            border: 1px solid var(--border-color);
        }

        .sync-pulse {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse-sync 2s infinite;
        }

        @keyframes pulse-sync {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .sync-config-card {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .sync-config-card input {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
        }

        .sync-config-card input::placeholder { color: rgba(255,255,255,0.6); }
        .sync-config-card input:focus {
            background: rgba(255,255,255,0.3);
            border-color: white;
            color: white;
            box-shadow: 0 0 0 0.25rem rgba(255,255,255,0.2);
        }

        #qrcode-display img, #qrcode-display canvas {
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        #qr-reader {
            border-radius: 12px;
            overflow: hidden;
        }
        
        #qr-reader video {
            border-radius: 12px;
        }

        #auth-section {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient-dark);
            position: relative;
            overflow: hidden;
        }

        [data-bs-theme="dark"] #auth-section {
            background: linear-gradient(135deg, #020617 0%, #0f172a 100%);
        }
        
        #auth-section::before {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,107,53,0.1) 0%, transparent 70%);
            animation: pulse 15s ease-in-out infinite;
        }

        .auth-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            padding: 2.5rem;
            border-radius: 20px;
            width: 100%;
            max-width: 480px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
            position: relative;
            z-index: 1;
        }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border-color);
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .auth-tab.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
        }

        .verification-alert {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border-left: 4px solid #3b82f6;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }

        [data-bs-theme="dark"] .verification-alert {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            border-left-color: #60a5fa;
        }

        .role-card {
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--card-bg);
        }

        .role-card:hover {
            border-color: var(--accent-color);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255,107,53,0.2);
        }

        .role-card.selected {
            border-color: var(--accent-color);
            background: rgba(255,107,53,0.1);
        }

        .role-icon {
            font-size: 2rem;
            color: var(--accent-color);
            margin-bottom: 0.5rem;
        }

        .sidebar {
            height: 100vh;
            background: var(--card-bg);
            box-shadow: 4px 0 24px rgba(0,0,0,0.08);
            position: fixed;
            top: 0;
            left: 0;
            width: 260px;
            padding-top: 20px;
            z-index: 1000;
            border-right: 1px solid var(--border-color);
            transition: background-color 0.3s;
            overflow-y: auto;
        }

        .main-content {
            margin-left: 260px;
            padding: 30px;
            min-height: 100vh;
        }

        .nav-link {
            color: var(--text-muted);
            padding: 16px 28px;
            font-weight: 600;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            cursor: pointer;
            text-decoration: none;
            margin: 4px 12px;
            border-radius: 12px;
        }

        .nav-link i { 
            margin-right: 12px; 
            width: 24px; 
            text-align: center;
            font-size: 1.1rem;
        }
        
        .nav-link:hover { 
            background-color: rgba(255,107,53,0.1); 
            color: var(--accent-color);
            transform: translateX(4px);
        }
        
        .nav-link.active {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4);
        }

        .nav-link.active.prep-link {
            background: var(--prep-gradient);
            box-shadow: 0 4px 12px rgba(6, 182, 212, 0.4);
        }

        .nav-link.active.ai-link {
            background: var(--ai-gradient);
            box-shadow: 0 4px 12px rgba(236, 72, 153, 0.4);
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 24px;
            border: none;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.03);
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        
        .stat-card:hover { 
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
        }
        
        .stat-card.border-accent { border-left-color: var(--accent-color); }
        .stat-card.border-success { border-left-color: var(--success-color); }
        .stat-card.border-primary { border-left-color: var(--primary-color); }
        .stat-card.border-warning { border-left-color: var(--warning-color); }
        .stat-card.border-danger { border-left-color: var(--danger-color); }
        .stat-card.border-prep { border-left-color: var(--prep-color); }
        .stat-card.border-ai { border-left-color: var(--ai-color); }

        .stock-alert-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
            font-size: 0.85rem;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        .stock-alert-item:last-child { border-bottom: none; }
        .stock-alert-critical { color: var(--danger-color); font-weight: 600; }
        .stock-alert-warning { color: var(--warning-color); font-weight: 600; }

        .status-pill {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        
        .status-pending { background-color: #fef3c7; color: #92400e; }
        .status-delivered { background-color: #d1fae5; color: #065f46; }
        .status-low { background-color: #fee2e2; color: #991b1b; }
        .status-out { background-color: #dbeafe; color: #1e40af; }
        .status-prep-planned { background-color: #cffafe; color: #155e75; }
        .status-prep-progress { background-color: #fef3c7; color: #92400e; }
        .status-prep-completed { background-color: #d1fae5; color: #065f46; }

        [data-bs-theme="dark"] .status-pending { background-color: #451a03; color: #fbbf24; }
        [data-bs-theme="dark"] .status-delivered { background-color: #064e3b; color: #34d399; }
        [data-bs-theme="dark"] .status-low { background-color: #450a0a; color: #f87171; }
        [data-bs-theme="dark"] .status-out { background-color: #1e3a8a; color: #60a5fa; }

        .tax-week-badge {
            background: var(--gradient-primary);
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            font-weight: 800;
            font-size: 1rem;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
            display: inline-block;
        }

        .brand-header { 
            padding: 0 24px 24px; 
            border-bottom: 2px solid var(--border-color); 
            margin-bottom: 24px; 
        }
        
        .brand-title {
            font-size: 1.75rem;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
        }

        #toast-container {
            position: fixed;
            top: 80px;
            right: 24px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .toast-item {
            background: var(--card-bg);
            border-left: 4px solid var(--success-color);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            border-radius: 12px;
            padding: 16px 20px;
            min-width: 320px;
            animation: slideIn 0.3s ease;
            color: var(--text-dark);
            border: 1px solid var(--border-color);
        }
        
        .toast-item.error { border-left-color: var(--danger-color); }
        .toast-item.warning { border-left-color: var(--warning-color); }
        .toast-item.info { border-left-color: var(--sync-color); }
        .toast-item.prep { border-left-color: var(--prep-color); }
        .toast-item.ai { border-left-color: var(--ai-color); }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .product-card {
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            background: var(--card-bg);
            color: var(--text-dark);
        }
        
        .product-card:hover {
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            transform: translateY(-4px);
            border-color: var(--accent-color);
        }
        
        .product-card:hover .edit-hint {
            opacity: 1;
            transform: scale(1);
        }
        
        .edit-hint {
            opacity: 0;
            transition: all 0.3s ease;
            transform: scale(0.8);
            background: var(--gradient-primary);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .table { color: var(--text-dark); }
        .table-light { background-color: var(--bg-color); color: var(--text-dark); }

        [data-bs-theme="dark"] .table-light { background-color: #334155; color: #f1f5f9; }
        [data-bs-theme="dark"] .table-hover tbody tr:hover { background-color: rgba(255,255,255,0.05); color: var(--text-dark); }

        .weekly-table-container {
            overflow-x: auto;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            background: var(--card-bg);
        }
        
        .weekly-table-container th {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
            white-space: nowrap;
            position: sticky;
            top: 0;
            min-width: 80px;
        }
        
        .current-week {
            background-color: rgba(255, 107, 53, 0.2) !important;
            font-weight: 700;
            color: var(--accent-hover);
        }

        .expenditure-card {
            background: var(--gradient-dark);
            color: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 15px -3px rgba(30, 58, 95, 0.3);
        }
        
        .expenditure-amount {
            font-size: 2rem;
            font-weight: 800;
            color: #fbbf24;
        }

        .gp-calculator {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 16px;
            padding: 24px;
        }
        
        .gp-calculator input {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            font-weight: 600;
        }
        
        .gp-calculator input::placeholder { color: rgba(255,255,255,0.6); }
        .gp-calculator input:focus {
            background: rgba(255,255,255,0.3);
            border-color: white;
            color: white;
            box-shadow: 0 0 0 0.25rem rgba(255,255,255,0.2);
        }

        .spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        .confetti { animation: confetti-fall linear forwards; }

        @keyframes confetti-fall {
            0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        @media (max-width: 768px) {
            .sidebar { width: 200px; }
            .main-content { margin-left: 200px; padding: 20px; }
            .kds-content { grid-template-columns: 1fr; }
        }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--accent-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-hover); }

        .hidden { display: none !important; }
        
        .activity-log-item {
            padding: 12px;
            border-left: 3px solid var(--accent-color);
            margin-bottom: 8px;
            background: var(--bg-color);
            border-radius: 0 8px 8px 0;
            font-size: 0.9rem;
        }
        
        .activity-log-item.login { border-left-color: var(--success-color); }
        .activity-log-item.logout { border-left-color: var(--warning-color); }
        .activity-log-item.order { border-left-color: var(--accent-color); }
        .activity-log-item.prep { border-left-color: var(--prep-color); }
        .activity-log-item.ai { border-left-color: var(--ai-color); }
        
        .sidebar-btn {
            width: 100%;
            padding: 10px 16px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 8px;
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .sidebar-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .analytics-tab-content { animation: fadeIn 0.3s ease-in; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .category-header {
            background: var(--bg-color) !important;
            color: var(--primary-color) !important;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .buyer-input {
            max-width: 80px;
            display: inline-block;
            text-align: center;
            font-weight: 600;
        }

        .meat-input {
            max-width: 100px;
            display: inline-block;
            text-align: right;
        }

        .week-spending-card {
            background: var(--card-bg);
            border-radius: 16px;
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .week-spending-card:hover {
            border-color: var(--accent-color);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .week-spending-card.current-week {
            border-color: var(--accent-color);
            background: linear-gradient(135deg, rgba(255,107,53,0.1) 0%, rgba(247,147,30,0.1) 100%);
        }

        .order-item-card {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .order-item-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .order-item-card.max-reached {
            opacity: 0.6;
            border-color: var(--danger-color);
        }

        .sync-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }
        
        .alert-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
        }
        
        .alert-badge.critical { background: rgba(239, 68, 68, 0.1); color: var(--danger-color); }
        .alert-badge.warning { background: rgba(245, 158, 11, 0.1); color: var(--warning-color); }

        /* Prep Sheets Specific Styles */
        .prep-card {
            background: var(--card-bg);
            border-radius: 16px;
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .prep-card:hover {
            border-color: var(--prep-color);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(6, 182, 212, 0.15);
        }

        .prep-card.completed {
            border-color: var(--success-color);
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(5, 150, 105, 0.05) 100%);
        }

        .prep-card.in-progress {
            border-color: var(--warning-color);
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.05) 0%, rgba(217, 119, 6, 0.05) 100%);
        }

        .prep-header {
            background: var(--prep-gradient);
            color: white;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
        }

        .prep-day-card {
            background: var(--card-bg);
            border-radius: 12px;
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .prep-day-card:hover {
            border-color: var(--prep-color);
            transform: translateY(-2px);
        }

        .prep-day-card.active {
            border-color: var(--prep-color);
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.1) 0%, rgba(8, 145, 178, 0.1) 100%);
        }

        .prep-day-card.has-prep {
            border-color: var(--success-color);
        }

        .prep-item-row {
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .prep-item-row:hover {
            background: var(--bg-color);
            border-left-color: var(--prep-color);
        }

        .prep-item-row.completed {
            background: rgba(16, 185, 129, 0.05);
            border-left-color: var(--success-color);
        }

        .prep-progress-bar {
            height: 8px;
            border-radius: 4px;
            background: var(--border-color);
            overflow: hidden;
        }

        .prep-progress-fill {
            height: 100%;
            border-radius: 4px;
            background: var(--prep-gradient);
            transition: width 0.3s ease;
        }

        .prep-progress-fill.completed {
            background: var(--gradient-success);
        }

        .prep-template-card {
            background: var(--card-bg);
            border-radius: 12px;
            border: 2px dashed var(--border-color);
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .prep-template-card:hover {
            border-color: var(--prep-color);
            border-style: solid;
            background: rgba(6, 182, 212, 0.05);
        }

        .prep-stats-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid var(--prep-color);
        }

        .prep-batch-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            background: rgba(6, 182, 212, 0.1);
            color: var(--prep-color);
        }

        .prep-week-view {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 12px;
        }

        @media (max-width: 1200px) { .prep-week-view { grid-template-columns: repeat(4, 1fr); } }
        @media (max-width: 768px) { .prep-week-view { grid-template-columns: repeat(2, 1fr); } }

        .day-column {
            background: var(--card-bg);
            border-radius: 12px;
            border: 2px solid var(--border-color);
            min-height: 200px;
            transition: all 0.3s ease;
        }

        .day-column:hover { border-color: var(--prep-color); }

        .day-column.today {
            border-color: var(--accent-color);
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.2);
        }

        .day-header {
            padding: 12px;
            border-bottom: 2px solid var(--border-color);
            font-weight: 700;
            text-align: center;
        }

        .day-column.today .day-header {
            background: var(--gradient-primary);
            color: white;
            border-radius: 10px 10px 0 0;
        }

        .prep-item-pill {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            margin: 8px;
            background: var(--bg-color);
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .prep-item-pill:hover {
            background: rgba(6, 182, 212, 0.1);
            transform: translateX(4px);
        }

        .prep-item-pill.completed {
            background: rgba(16, 185, 129, 0.1);
            text-decoration: line-through;
            opacity: 0.7;
        }

        .prep-item-pill .qty-badge {
            background: var(--prep-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .prep-item-pill.completed .qty-badge {
            background: var(--success-color);
        }

        /* Feature badge in sidebar */
        .feature-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.65rem;
            font-weight: 700;
            margin-left: auto;
        }

        .feature-badge.new {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .feature-badge.beta {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }

        .feature-badge.ai {
            background: var(--ai-gradient);
            color: white;
        }

        /* ===== MOBILE RESPONSIVE STYLES ===== */
        
        /* Mobile Sidebar Toggle */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--gradient-primary);
            color: white;
            border: none;
            box-shadow: 0 4px 20px rgba(255, 107, 53, 0.4);
            z-index: 1050;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .mobile-menu-toggle:active {
            transform: scale(0.95);
        }
        
        /* Mobile Bottom Navigation */
        .mobile-bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border-top: 1px solid var(--border-color);
            z-index: 1040;
            padding: 8px 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .mobile-bottom-nav .nav-item {
            flex: 1;
            text-align: center;
            padding: 8px 4px;
            color: var(--text-muted);
            font-size: 0.7rem;
            text-decoration: none;
            transition: all 0.2s ease;
        }
        
        .mobile-bottom-nav .nav-item i {
            display: block;
            font-size: 1.3rem;
            margin-bottom: 4px;
        }
        
        .mobile-bottom-nav .nav-item.active {
            color: var(--accent-color);
        }
        
        /* Mobile Cards */
        .mobile-card {
            border-radius: 16px;
            margin-bottom: 16px;
        }
        
        .mobile-stat-card {
            padding: 16px;
            text-align: center;
        }
        
        .mobile-stat-card h3 {
            font-size: 1.5rem;
        }
        
        .mobile-stat-card h6 {
            font-size: 0.7rem;
        }
        
        /* Mobile Tables */
        .mobile-table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .mobile-table {
            min-width: 600px;
        }
        
        /* Mobile Forms */
        .mobile-form .form-control,
        .mobile-form .form-select {
            font-size: 16px; /* Prevents zoom on iOS */
            padding: 12px 16px;
        }
        
        /* Mobile Modals */
        @media (max-width: 576px) {
            .modal-dialog {
                margin: 0.5rem;
            }
            
            .modal-dialog.modal-lg,
            .modal-dialog.modal-xl {
                max-width: calc(100% - 1rem);
            }
            
            .glass-modal .modal-content {
                border-radius: 16px;
            }
        }
        
        /* Mobile Buttons */
        .mobile-btn {
            padding: 12px 20px;
            font-size: 1rem;
            min-height: 48px;
        }
        
        .mobile-btn-icon {
            width: 48px;
            height: 48px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Mobile Typography */
        .mobile-h2 {
            font-size: 1.5rem;
        }
        
        .mobile-h5 {
            font-size: 1rem;
        }
        
        .mobile-small {
            font-size: 0.8rem;
        }
        
        /* Mobile Alerts */
        .mobile-alert {
            padding: 12px 16px;
            font-size: 0.9rem;
        }
        
        /* Mobile Sidebar Overlay */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1030;
            backdrop-filter: blur(4px);
        }
        
        .sidebar-overlay.active {
            display: block;
        }
        
        /* Mobile Page Padding */
        .mobile-page-content {
            padding-bottom: 80px; /* Space for bottom nav */
        }
        
        /* Mobile Grid */
        .mobile-row {
            margin-left: -8px;
            margin-right: -8px;
        }
        
        .mobile-col {
            padding-left: 8px;
            padding-right: 8px;
        }
        
        /* Mobile Scroll */
        .mobile-scroll-x {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .mobile-scroll-x::-webkit-scrollbar {
            display: none;
        }
        
        /* Mobile Touch Targets */
        .mobile-touch-target {
            min-height: 44px;
            min-width: 44px;
        }
        
        /* Mobile Status Bar Safe Area */
        @supports (padding-top: env(safe-area-inset-top)) {
            .mobile-safe-area {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
                padding-left: env(safe-area-inset-left);
                padding-right: env(safe-area-inset-right);
            }
        }

        /* ===== RESPONSIVE BREAKPOINTS ===== */
        
        /* Large devices (desktops, 992px and up) */
        @media (min-width: 992px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                width: 280px;
                z-index: 1000;
            }
            
            .main-content {
                margin-left: 280px;
            }
        }
        
        /* Medium devices (tablets, 768px to 991px) */
        @media (max-width: 991px) {
            .sidebar {
                position: fixed;
                left: -280px;
                top: 0;
                bottom: 0;
                width: 280px;
                z-index: 1040;
                transition: left 0.3s ease;
            }
            
            .sidebar.active {
                left: 0;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .mobile-menu-toggle {
                display: flex;
            }
            
            .stat-card h3 {
                font-size: 1.5rem;
            }
            
            .stat-card h6 {
                font-size: 0.7rem;
            }
        }
        
        /* Small devices (landscape phones, 576px to 767px) */
        @media (max-width: 767px) {
            .container-fluid {
                padding: 12px;
            }
            
            .page-section {
                padding: 12px;
            }
            
            .card {
                margin-bottom: 12px;
            }
            
            .card-header {
                padding: 12px 16px;
            }
            
            .card-body {
                padding: 16px;
            }
            
            .table {
                font-size: 0.85rem;
            }
            
            .table th,
            .table td {
                padding: 8px 12px;
            }
            
            .btn {
                padding: 10px 16px;
                font-size: 0.9rem;
            }
            
            .btn-sm {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
            
            .form-control,
            .form-select {
                font-size: 16px;
                padding: 12px;
            }
            
            h2 {
                font-size: 1.5rem;
            }
            
            h3 {
                font-size: 1.25rem;
            }
            
            h5 {
                font-size: 1rem;
            }
            
            .alert {
                padding: 12px 16px;
                font-size: 0.9rem;
            }
            
            .badge {
                font-size: 0.75rem;
                padding: 4px 8px;
            }
            
            .nav-pills .nav-link {
                padding: 8px 16px;
                font-size: 0.85rem;
            }
            
            .kpi-card {
                padding: 16px;
            }
            
            .kpi-card h3 {
                font-size: 1.5rem;
            }
            
            .kpi-card h6 {
                font-size: 0.7rem;
            }
        }
        
        /* Extra small devices (portrait phones, less than 576px) */
        @media (max-width: 575px) {
            .container-fluid {
                padding: 8px;
            }
            
            .page-section {
                padding: 8px;
            }
            
            .row {
                margin-left: -4px;
                margin-right: -4px;
            }
            
            .col,
            .col-1, .col-2, .col-3, .col-4, .col-5, .col-6,
            .col-7, .col-8, .col-9, .col-10, .col-11, .col-12,
            .col-md-1, .col-md-2, .col-md-3, .col-md-4, .col-md-5, .col-md-6,
            .col-md-7, .col-md-8, .col-md-9, .col-md-10, .col-md-11, .col-md-12,
            .col-lg-1, .col-lg-2, .col-lg-3, .col-lg-4, .col-lg-5, .col-lg-6,
            .col-lg-7, .col-lg-8, .col-lg-9, .col-lg-10, .col-lg-11, .col-lg-12 {
                padding-left: 4px;
                padding-right: 4px;
            }
            
            .card {
                border-radius: 12px;
                margin-bottom: 8px;
            }
            
            .card-header {
                padding: 12px;
            }
            
            .card-header h5 {
                font-size: 0.95rem;
            }
            
            .card-header small {
                font-size: 0.75rem;
            }
            
            .card-body {
                padding: 12px;
            }
            
            .table {
                font-size: 0.8rem;
            }
            
            .table th,
            .table td {
                padding: 6px 8px;
            }
            
            .btn {
                padding: 10px 14px;
                font-size: 0.85rem;
                width: 100%;
                margin-bottom: 8px;
            }
            
            .btn:last-child {
                margin-bottom: 0;
            }
            
            .btn-group {
                display: flex;
                flex-direction: column;
            }
            
            .btn-group .btn {
                border-radius: 8px !important;
                margin-bottom: 8px;
            }
            
            .d-flex.gap-2 {
                flex-direction: column;
                gap: 8px !important;
            }
            
            .d-flex.gap-2 .btn {
                width: 100%;
                margin: 0;
            }
            
            .form-control,
            .form-select {
                font-size: 16px;
                padding: 14px 12px;
            }
            
            h2 {
                font-size: 1.25rem;
            }
            
            h3 {
                font-size: 1.1rem;
            }
            
            h5 {
                font-size: 0.95rem;
            }
            
            .alert {
                padding: 12px;
                font-size: 0.85rem;
            }
            
            .modal-dialog {
                margin: 0.5rem;
            }
            
            .modal-content {
                border-radius: 16px;
            }
            
            .modal-header {
                padding: 16px;
            }
            
            .modal-body {
                padding: 16px;
            }
            
            .modal-footer {
                padding: 16px;
                flex-direction: column;
            }
            
            .modal-footer .btn {
                width: 100%;
                margin: 0 0 8px 0 !important;
            }
            
            .modal-footer .btn:last-child {
                margin-bottom: 0 !important;
            }
            
            .nav-pills {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .nav-pills .nav-item {
                flex: 1 1 calc(50% - 4px);
            }
            
            .nav-pills .nav-link {
                padding: 10px 12px;
                font-size: 0.8rem;
                text-align: center;
            }
            
            .stat-card {
                padding: 16px 12px;
            }
            
            .stat-card h3 {
                font-size: 1.25rem;
            }
            
            .stat-card h6 {
                font-size: 0.65rem;
            }
            
            .kpi-card {
                padding: 12px;
            }
            
            .kpi-card h3 {
                font-size: 1.25rem;
            }
            
            .kpi-card h6 {
                font-size: 0.65rem;
            }
            
            .glass-card {
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            }
            
            .mobile-bottom-nav {
                display: flex;
            }
            
            .page-section {
                padding-bottom: 80px;
            }
            
            /* Touch-friendly table scrolling */
            .table-responsive {
                border-radius: 8px;
                border: 1px solid var(--border-color);
            }
            
            /* Compact sidebar for mobile */
            .sidebar {
                width: 260px;
            }
            
            /* Full-width action buttons */
            .card-header .d-flex {
                flex-direction: column;
                gap: 12px;
            }
            
            .card-header .d-flex > * {
                width: 100%;
            }
            
            /* Mobile-friendly form layouts */
            .row .col-md-6,
            .row .col-md-4,
            .row .col-md-3 {
                margin-bottom: 12px;
            }
            
            /* Mobile alerts */
            .alert .d-flex {
                flex-direction: column;
                gap: 8px;
            }
            
            .alert .d-flex > div:first-child {
                align-self: flex-start;
            }
            
            /* Mobile charts */
            canvas {
                max-height: 200px !important;
            }
            
            /* Mobile toast notifications */
            .toast {
                width: calc(100% - 32px);
                margin: 8px 16px;
            }
            
            /* Mobile search */
            .input-group {
                flex-direction: column;
            }
            
            .input-group > * {
                width: 100% !important;
                border-radius: 8px !important;
                margin-bottom: 8px;
            }
            
            .input-group > *:last-child {
                margin-bottom: 0;
            }
            
            /* Mobile tabs */
            .nav-tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
            }
            
            .nav-tabs::-webkit-scrollbar {
                display: none;
            }
            
            .nav-tabs .nav-link {
                white-space: nowrap;
                padding: 10px 16px;
            }
        }
        
        /* Landscape mode optimizations */
        @media (max-height: 500px) and (orientation: landscape) {
            .mobile-bottom-nav {
                display: none;
            }
            
            .page-section {
                padding-bottom: 20px;
            }
            
            .modal-dialog {
                margin: 0.5rem auto;
                max-width: 90%;
            }
        }
        
        /* High DPI / Retina displays */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .glass-card {
                backdrop-filter: blur(30px);
                -webkit-backdrop-filter: blur(30px);
            }
        }
        
        /* Dark mode mobile adjustments */
        @media (max-width: 575px) {
            [data-bs-theme="dark"] .mobile-bottom-nav {
                background: rgba(15, 23, 42, 0.95);
                border-top-color: rgba(255, 255, 255, 0.1);
            }
        }
        
        /* Print styles */
        @media print {
            .sidebar,
            .mobile-menu-toggle,
            .mobile-bottom-nav,
            .sidebar-overlay {
                display: none !important;
            }
            
            .main-content {
                margin-left: 0 !important;
            }
            
            .card {
                break-inside: avoid;
            }
        }
    </style>
<base target="_blank">
<base target="_blank">
<base target="_blank">
<base target="_blank">
</head>
<body>

    <div id="toast-container"></div>
    <div class="spinner-overlay" id="loading">
        <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- KDS Full-Screen Mode (Week 3) -->
    <div id="kds-fullscreen">
        <button class="kds-exit-btn" onclick="exitKDSMode()">
            <i class="fas fa-times me-2"></i>Exit KDS
        </button>
        <div class="kds-header">
            <div>
                <h2 class="mb-0 fw-bold"><i class="fas fa-utensils me-2"></i>KDS - Kitchen Display System</h2>
                <small class="opacity-75">Real-time prep order management</small>
            </div>
            <div class="kds-clock" id="kds-clock">00:00</div>
        </div>
        <div class="kds-content">
            <div class="kds-column kds-pending">
                <div class="kds-column-header"><i class="fas fa-clock me-2"></i>Pending</div>
                <div id="kds-pending-items"></div>
            </div>
            <div class="kds-column kds-progress">
                <div class="kds-column-header"><i class="fas fa-spinner me-2"></i>In Progress</div>
                <div id="kds-progress-items"></div>
            </div>
            <div class="kds-column kds-completed">
                <div class="kds-column-header"><i class="fas fa-check me-2"></i>Completed</div>
                <div id="kds-completed-items"></div>
            </div>
        </div>
    </div>

    <!-- AR Scanner Overlay (Month 2) -->
    <div class="ar-scanner-overlay" id="ar-scanner">
        <div class="ar-viewfinder">
            <div id="ar-qr-reader" style="width: 100%; height: 100%;"></div>
            <div class="ar-scan-line"></div>
        </div>
        <div class="ar-info-panel">
            <div class="ar-badge mb-2"><i class="fas fa-cube me-2"></i>AR Stock Scanner</div>
            <div id="ar-scan-status">Point camera at QR code</div>
        </div>
        <button class="btn btn-danger btn-lg mt-4" onclick="closeARScanner()">
            <i class="fas fa-times me-2"></i>Close Scanner
        </button>
    </div>

    <!-- QR Scanner Modal -->
    <div class="modal fade" id="qrScannerModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0" style="border-radius: 20px; background: var(--card-bg); color: var(--text-dark);">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold" style="color: var(--primary-color);"><i class="fas fa-qrcode me-2"></i>Scan Stock QR Code</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="stopQrScanner()"></button>
                </div>
                <div class="modal-body text-center">
                    <div id="qr-reader" style="width: 100%; border-radius: 12px; overflow: hidden;"></div>
                    <div id="qr-result" class="mt-3 p-3 rounded-3 bg-light hidden" style="background: var(--bg-color) !important;">
                        <h6 class="fw-bold mb-2">Item Found:</h6>
                        <div id="qr-item-details"></div>
                        <div class="mt-3 d-flex gap-2 justify-content-center">
                            <button class="btn btn-primary fw-bold" onclick="viewScannedItem()" style="background: var(--gradient-primary); border: none;"><i class="fas fa-edit me-2"></i>Edit Item</button>
                            <button class="btn btn-success fw-bold" onclick="quickAddStock()"><i class="fas fa-plus me-2"></i>Quick Add Stock</button>
                        </div>
                    </div>
                    <div id="qr-error" class="alert alert-danger mt-3 hidden" style="border-radius: 8px;"><i class="fas fa-exclamation-circle me-2"></i>Item not found in database</div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light fw-bold" data-bs-dismiss="modal" onclick="stopQrScanner()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Display Modal -->
    <div class="modal fade" id="qrDisplayModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content border-0" style="border-radius: 20px; background: var(--card-bg); color: var(--text-dark);">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold" style="color: var(--primary-color);">Item QR Code</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <div id="qrcode-display" class="d-flex justify-content-center mb-3"></div>
                    <h6 id="qr-item-name" class="fw-bold mb-1"></h6>
                    <small class="text-muted" id="qr-item-id"></small>
                    <div class="mt-3">
                        <button class="btn btn-outline-primary btn-sm fw-bold w-100" onclick="printQRCode()"><i class="fas fa-print me-2"></i>Print Label</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Prep Item Modal -->
    <div class="modal fade" id="prepItemModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0" style="border-radius: 20px; background: var(--card-bg); color: var(--text-dark);">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold" id="prepItemModalLabel" style="color: var(--prep-color);"><i class="fas fa-utensils me-2"></i>Add Prep Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="prepItemForm">
                        <input type="hidden" id="prep-item-id">
                        <input type="hidden" id="prep-sheet-date">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Product</label>
                            <select class="form-select form-select-lg" id="prep-product-select" onchange="updatePrepItemDetails()"><option value="" selected disabled>Select a product...</option></select>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">Quantity to Prep</label>
                                <div class="input-group input-group-lg">
                                    <input type="number" class="form-control" id="prep-quantity" min="1" value="1">
                                    <span class="input-group-text" id="prep-unit-display">pcs</span>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">Batch Code (Optional)</label>
                                <input type="text" class="form-control form-control-lg" id="prep-batch-code" placeholder="e.g., BATCH001">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Notes</label>
                            <textarea class="form-control" id="prep-notes" rows="2" placeholder="Any special instructions..."></textarea>
                        </div>
                        <div class="alert alert-info" style="border-radius: 8px; background: rgba(6, 182, 212, 0.1); border-color: var(--prep-color); color: var(--text-dark);">
                            <i class="fas fa-info-circle me-2" style="color: var(--prep-color);"></i>
                            <small>Current stock will be automatically deducted when you mark this prep as completed.</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light fw-bold" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary fw-bold px-4" onclick="savePrepItem()" style="background: var(--prep-gradient); border: none;"><i class="fas fa-save me-2"></i>Save Prep Item</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Prep Template Modal -->
    <div class="modal fade" id="prepTemplateModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0" style="border-radius: 20px; background: var(--card-bg); color: var(--text-dark);">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold" style="color: var(--prep-color);"><i class="fas fa-copy me-2"></i>Prep Templates</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <h6 class="fw-bold mb-3">Quick Apply Templates</h6>
                        <div class="row g-3" id="prep-templates-list"></div>
                    </div>
                    <div class="border-top pt-4">
                        <h6 class="fw-bold mb-3">Create New Template</h6>
                        <div class="input-group">
                            <input type="text" class="form-control" id="new-template-name" placeholder="Template name (e.g., Weekend Prep)">
                            <button class="btn btn-primary fw-bold" onclick="createPrepTemplateFromCurrent()" style="background: var(--prep-gradient); border: none;"><i class="fas fa-plus me-2"></i>Create from Current</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Prediction Modal -->
    <div class="modal fade" id="aiPredictionModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 glass-modal" style="border-radius: 20px;">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold" style="color: var(--ai-color);"><i class="fas fa-brain me-2"></i>AI Prep Predictions</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="ai-prediction-card mb-4">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div class="ai-badge"><i class="fas fa-robot"></i>AI Powered</div>
                            <small class="text-muted">Based on 30 days of historical data</small>
                        </div>
                        <p class="mb-3">Our AI analyzes your prep patterns, order history, and seasonal trends to predict optimal prep quantities.</p>
                        <div id="ai-predictions-list"></div>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-lightbulb me-2"></i>
                        <strong>Tip:</strong> AI predictions improve as more data is collected. Current accuracy: <span id="ai-accuracy">85%</span>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light fw-bold" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary fw-bold" onclick="applyAIPredictions()" style="background: var(--ai-gradient); border: none;">
                        <i class="fas fa-magic me-2"></i>Apply All Predictions
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Meat Product Modal -->
    <div class="modal fade" id="addMeatProductModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 glass-modal" style="border-radius: 20px;">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold" style="color: var(--accent-color);"><i class="fas fa-plus me-2"></i>Add Meat Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addMeatProductForm">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Product Name</label>
                            <input type="text" class="form-control form-control-lg" id="meat-product-name" required placeholder="e.g., Ribeye Steak 300g">
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">Meat Category</label>
                                <select class="form-select form-select-lg" id="meat-product-category">
                                    <option value="FILLET">FILLET</option>
                                    <option value="SIRLOIN">SIRLOIN</option>
                                    <option value="RIBEYE">RIBEYE</option>
                                    <option value="RUMP">RUMP</option>
                                    <option value="">Other (no category)</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">Unit</label>
                                <input type="text" class="form-control form-control-lg" id="meat-product-unit" required placeholder="e.g., kg, pc">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">Cost ()</label>
                                <input type="number" class="form-control form-control-lg" id="meat-product-cost" step="0.01" min="0" required placeholder="0.00">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">Min Stock Level</label>
                                <input type="number" class="form-control form-control-lg" id="meat-product-min" min="0" value="10">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Initial Stock</label>
                            <input type="number" class="form-control form-control-lg" id="meat-product-stock" min="0" value="0">
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light fw-bold" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success fw-bold px-4" onclick="addMeatProduct()"><i class="fas fa-plus me-2"></i>Add Product</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Remove Meat Product Modal -->
    <div class="modal fade" id="removeMeatProductModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 glass-modal" style="border-radius: 20px;">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold text-danger"><i class="fas fa-trash me-2"></i>Remove Meat Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning" style="border-radius: 12px;">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Warning:</strong> This will permanently delete the product from inventory.
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Select Product to Remove</label>
                        <select class="form-select form-select-lg" id="remove-meat-product-select">
                            <option value="" selected disabled>Choose a product...</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light fw-bold" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger fw-bold px-4" onclick="removeMeatProduct()"><i class="fas fa-trash me-2"></i>Remove Product</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Buyer Product Modal -->
    <div class="modal fade" id="addBuyerProductModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 glass-modal" style="border-radius: 20px;">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold" style="color: var(--accent-color);"><i class="fas fa-plus me-2"></i>Add Product for Buyers</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addBuyerProductForm">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Product Name</label>
                            <input type="text" class="form-control form-control-lg" id="buyer-product-name" required placeholder="e.g., Chicken Breast">
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">Category</label>
                                <select class="form-select form-select-lg" id="buyer-product-category">
                                    <option value="meat">Meat & Fish</option>
                                    <option value="produce">Produce</option>
                                    <option value="sauces">Sauces</option>
                                    <option value="prepared">Prepared</option>
                                    <option value="desserts">Desserts</option>
                                    <option value="dry">Dry Goods</option>
                                    <option value="nonfood">Non Food</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">Unit</label>
                                <input type="text" class="form-control form-control-lg" id="buyer-product-unit" required placeholder="e.g., kg, pc">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">Cost ()</label>
                                <input type="number" class="form-control form-control-lg" id="buyer-product-cost" step="0.01" min="0" required placeholder="0.00">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">Min Stock Level</label>
                                <input type="number" class="form-control form-control-lg" id="buyer-product-min" min="0" value="10">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Initial Stock</label>
                            <input type="number" class="form-control form-control-lg" id="buyer-product-stock" min="0" value="0">
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light fw-bold" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success fw-bold px-4" onclick="addBuyerProduct()"><i class="fas fa-plus me-2"></i>Add Product</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Remove Buyer Product Modal -->
    <div class="modal fade" id="removeBuyerProductModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 glass-modal" style="border-radius: 20px;">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold text-danger"><i class="fas fa-trash me-2"></i>Remove Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning" style="border-radius: 12px;">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Warning:</strong> This will permanently delete the product from inventory.
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Select Product to Remove</label>
                        <select class="form-select form-select-lg" id="remove-buyer-product-select">
                            <option value="" selected disabled>Choose a product...</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light fw-bold" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger fw-bold px-4" onclick="removeBuyerProduct()"><i class="fas fa-trash me-2"></i>Remove Product</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Ingredient Modal -->
    <div class="modal fade" id="addIngredientModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 glass-modal" style="border-radius: 20px;">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold" style="color: var(--accent-color);"><i class="fas fa-carrot me-2"></i>Add New Ingredient</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addIngredientForm">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Ingredient Name</label>
                            <input type="text" class="form-control form-control-lg" id="ingredient-name" required placeholder="e.g., Chicken Breast">
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">Category</label>
                                <select class="form-select form-select-lg" id="ingredient-category">
                                    <option value="meat">Meat & Fish</option>
                                    <option value="produce">Produce</option>
                                    <option value="dairy">Dairy</option>
                                    <option value="dry">Dry Goods</option>
                                    <option value="spices">Spices</option>
                                    <option value="oils">Oils & Fats</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">Unit</label>
                                <input type="text" class="form-control form-control-lg" id="ingredient-unit" required placeholder="e.g., kg, g, L">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">Unit Cost ()</label>
                                <div class="input-group input-group-lg">
                                    <span class="input-group-text bg-light fw-bold"></span>
                                    <input type="number" class="form-control" id="ingredient-cost" step="0.01" min="0" required placeholder="0.00">
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">Wastage %</label>
                                <div class="input-group input-group-lg">
                                    <input type="number" class="form-control" id="ingredient-wastage" step="0.1" min="0" max="100" value="0" placeholder="0">
                                    <span class="input-group-text bg-light fw-bold">%</span>
                                </div>
                                <small class="text-muted">Trim, peel, cooking loss</small>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Supplier (Optional)</label>
                            <input type="text" class="form-control form-control-lg" id="ingredient-supplier" placeholder="e.g., Sysco, Brakes">
                        </div>
                        
                        <!-- Allergen Section -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold"><i class="fas fa-exclamation-triangle text-warning me-2"></i>Allergens</label>
                            <div class="row g-2">
                                <div class="col-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="allergen-gluten" value="gluten">
                                        <label class="form-check-label" for="allergen-gluten"><i class="fas fa-bread-slice me-1"></i>Gluten</label>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="allergen-dairy" value="dairy">
                                        <label class="form-check-label" for="allergen-dairy"><i class="fas fa-cheese me-1"></i>Dairy</label>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="allergen-eggs" value="eggs">
                                        <label class="form-check-label" for="allergen-eggs"><i class="fas fa-egg me-1"></i>Eggs</label>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="allergen-fish" value="fish">
                                        <label class="form-check-label" for="allergen-fish"><i class="fas fa-fish me-1"></i>Fish</label>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="allergen-shellfish" value="shellfish">
                                        <label class="form-check-label" for="allergen-shellfish"><i class="fas fa-shrimp me-1"></i>Shellfish</label>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="allergen-nuts" value="nuts">
                                        <label class="form-check-label" for="allergen-nuts"><i class="fas fa-seedling me-1"></i>Nuts</label>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="allergen-peanuts" value="peanuts">
                                        <label class="form-check-label" for="allergen-peanuts"><i class="fas fa-leaf me-1"></i>Peanuts</label>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="allergen-soya" value="soya">
                                        <label class="form-check-label" for="allergen-soya"><i class="fas fa-bean me-1"></i>Soya</label>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="allergen-sesame" value="sesame">
                                        <label class="form-check-label" for="allergen-sesame"><i class="fas fa-circle me-1"></i>Sesame</label>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="allergen-sulphites" value="sulphites">
                                        <label class="form-check-label" for="allergen-sulphites"><i class="fas fa-wine-bottle me-1"></i>Sulphites</label>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="allergen-mustard" value="mustard">
                                        <label class="form-check-label" for="allergen-mustard"><i class="fas fa-pepper-hot me-1"></i>Mustard</label>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="allergen-celery" value="celery">
                                        <label class="form-check-label" for="allergen-celery"><i class="fas fa-carrot me-1"></i>Celery</label>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="allergen-lupin" value="lupin">
                                        <label class="form-check-label" for="allergen-lupin"><i class="fas fa-spa me-1"></i>Lupin</label>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="allergen-molluscs" value="molluscs">
                                        <label class="form-check-label" for="allergen-molluscs"><i class="fas fa-water me-1"></i>Molluscs</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-info mb-0" style="border-radius: 12px;">
                            <i class="fas fa-info-circle me-2"></i>
                            <small>Effective cost will be calculated automatically based on wastage percentage.</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-0">
                    <div class="d-flex justify-content-between align-items-center w-100">
                        <small class="text-muted">
                            <a href="javascript:void(0)" onclick="downloadIngredientCSVTemplate()" class="text-decoration-none">
                                <i class="fas fa-download me-1"></i>Download CSV Template
                            </a>
                        </small>
                        <div>
                            <button type="button" class="btn btn-light fw-bold" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary fw-bold px-4" onclick="saveIngredient()" style="background: var(--gradient-primary); border: none;"><i class="fas fa-save me-2"></i>Save Ingredient</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recipe Builder Modal -->
    <div class="modal fade" id="recipeBuilderModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content border-0 glass-modal" style="border-radius: 20px;">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold" style="color: var(--accent-color);"><i class="fas fa-magic me-2"></i>Visual Recipe Builder</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Recipe Name</label>
                                <input type="text" class="form-control form-control-lg" id="recipe-name" placeholder="e.g., Grilled Salmon with Asparagus">
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Category</label>
                                    <select class="form-select" id="recipe-category">
                                        <option value="starter">Starter</option>
                                        <option value="main">Main Course</option>
                                        <option value="dessert">Dessert</option>
                                        <option value="side">Side Dish</option>
                                        <option value="sauce">Sauce</option>
                                        <option value="base">Base/Prep</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Portions</label>
                                    <input type="number" class="form-control" id="recipe-portions" min="1" value="1">
                                </div>
                            </div>
                            
                            <!-- Ingredient Selector -->
                            <div class="card border-0 mb-3" style="border-radius: 12px; background: var(--bg-color);">
                                <div class="card-header bg-transparent py-2" style="border-bottom: 1px solid var(--border-color);">
                                    <h6 class="fw-bold mb-0"><i class="fas fa-plus-circle me-2"></i>Add Ingredients</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row g-2">
                                        <div class="col-md-5">
                                            <select class="form-select" id="recipe-ingredient-select">
                                                <option value="" selected disabled>Select ingredient...</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="recipe-ingredient-qty" placeholder="Qty" step="0.01" min="0">
                                                <span class="input-group-text" id="recipe-ingredient-unit">-</span>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <button class="btn btn-primary w-100 fw-bold" onclick="addIngredientToRecipe()" style="background: var(--gradient-primary); border: none;"><i class="fas fa-plus me-2"></i>Add to Recipe</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Recipe Ingredients List -->
                            <div class="card border-0" style="border-radius: 12px; background: var(--bg-color);">
                                <div class="card-header bg-transparent py-2 d-flex justify-content-between align-items-center" style="border-bottom: 1px solid var(--border-color);">
                                    <h6 class="fw-bold mb-0"><i class="fas fa-list me-2"></i>Recipe Ingredients</h6>
                                    <span class="badge bg-primary" id="recipe-ingredient-count">0 items</span>
                                </div>
                                <div class="card-body p-0">
                                    <div id="recipe-ingredients-list" style="max-height: 250px; overflow-y: auto;">
                                        <div class="text-center text-muted py-4">
                                            <i class="fas fa-hand-pointer fa-2x mb-2 opacity-25"></i>
                                            <p class="mb-0">Select ingredients above to build your recipe</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Live Costing Panel -->
                        <div class="col-md-4">
                            <div class="card border-0 h-100" style="border-radius: 12px; background: linear-gradient(135deg, #1e3a5f 0%, #2c5282 100%); color: white;">
                                <div class="card-header bg-transparent py-3" style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                                    <h6 class="fw-bold mb-0"><i class="fas fa-calculator me-2"></i>Live Costing</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span class="opacity-75">Ingredient Cost</span>
                                            <span class="fw-bold" id="builder-ingredient-cost">0.00</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span class="opacity-75">Wastage Cost</span>
                                            <span class="fw-bold text-warning" id="builder-wastage-cost">0.00</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span class="opacity-75">Labor Cost</span>
                                            <div class="input-group input-group-sm" style="width: 100px;">
                                                <span class="input-group-text bg-light"></span>
                                                <input type="number" class="form-control" id="builder-labor-cost" value="0" step="0.01" onchange="updateBuilderCosting()">
                                            </div>
                                        </div>
                                        <hr style="border-color: rgba(255,255,255,0.2);">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span class="fw-bold">Total Cost</span>
                                            <span class="fw-bold fs-5" id="builder-total-cost">0.00</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-3">
                                            <span class="opacity-75">Cost per Portion</span>
                                            <span class="fw-bold" id="builder-cost-per-portion">0.00</span>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label opacity-75">Target GP %</label>
                                            <div class="input-group input-group-sm">
                                                <input type="number" class="form-control" id="builder-target-gp" value="70" min="0" max="100">
                                                <span class="input-group-text bg-light">%</span>
                                            </div>
                                        </div>
                                        
                                        <div class="p-3 rounded-3 text-center" style="background: rgba(255,255,255,0.1);">
                                            <small class="opacity-75 d-block">Suggested Sell Price</small>
                                            <span class="fw-bold fs-4" id="builder-sell-price">0.00</span>
                                            <div class="mt-2">
                                                <small class="opacity-75">Projected GP: </small>
                                                <span class="fw-bold" id="builder-projected-gp">--</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <div class="d-flex justify-content-between align-items-center w-100">
                        <small class="text-muted">
                            <a href="javascript:void(0)" onclick="downloadRecipeCSVTemplate()" class="text-decoration-none">
                                <i class="fas fa-download me-1"></i>Download CSV Template
                            </a>
                        </small>
                        <div>
                            <button type="button" class="btn btn-light fw-bold" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-success fw-bold px-4" onclick="saveRecipe()"><i class="fas fa-save me-2"></i>Save Recipe</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- A/B Test Modal -->
    <div class="modal fade" id="abTestModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 glass-modal" style="border-radius: 20px;">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold" style="color: var(--ai-color);"><i class="fas fa-flask me-2"></i>Create A/B Test</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Test Name</label>
                        <input type="text" class="form-control form-control-lg" id="ab-test-name" placeholder="e.g., Salmon Recipe Cost Optimization">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Select Base Recipe</label>
                        <select class="form-select form-select-lg" id="ab-base-recipe" onchange="loadRecipeVariants()">
                            <option value="" selected disabled>Choose a recipe...</option>
                        </select>
                    </div>
                    
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <div class="card border-0 h-100" style="border-radius: 12px; background: var(--bg-color); border: 2px solid var(--success-color) !important;">
                                <div class="card-header bg-transparent py-2" style="border-bottom: 1px solid var(--border-color);">
                                    <h6 class="fw-bold mb-0 text-success"><i class="fas fa-a me-2"></i>Variant A (Current)</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-2">
                                        <small class="text-muted">Cost per Portion</small>
                                        <div class="fw-bold fs-5" id="ab-variant-a-cost">0.00</div>
                                    </div>
                                    <div class="mb-2">
                                        <small class="text-muted">Current GP</small>
                                        <div class="fw-bold" id="ab-variant-a-gp">--</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-0 h-100" style="border-radius: 12px; background: var(--bg-color); border: 2px solid var(--ai-color) !important;">
                                <div class="card-header bg-transparent py-2" style="border-bottom: 1px solid var(--border-color);">
                                    <h6 class="fw-bold mb-0" style="color: var(--ai-color);"><i class="fas fa-b me-2"></i>Variant B (New)</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-2">
                                        <small class="text-muted">Cost per Portion</small>
                                        <div class="input-group">
                                            <span class="input-group-text bg-light"></span>
                                            <input type="number" class="form-control" id="ab-variant-b-cost" step="0.01" placeholder="0.00" onchange="calculateABComparison()">
                                        </div>
                                    </div>
                                    <div class="mb-2">
                                        <small class="text-muted">Target GP</small>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="ab-variant-b-gp" value="70" min="0" max="100">
                                            <span class="input-group-text bg-light">%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card border-0 mb-3" style="border-radius: 12px; background: var(--bg-color);">
                        <div class="card-header bg-transparent py-2" style="border-bottom: 1px solid var(--border-color);">
                            <h6 class="fw-bold mb-0"><i class="fas fa-chart-bar me-2"></i>Comparison Results</h6>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-4">
                                    <small class="text-muted d-block">Cost Difference</small>
                                    <span class="fw-bold fs-5" id="ab-cost-diff">--</span>
                                </div>
                                <div class="col-md-4">
                                    <small class="text-muted d-block">GP Improvement</small>
                                    <span class="fw-bold fs-5" id="ab-gp-improvement">--</span>
                                </div>
                                <div class="col-md-4">
                                    <small class="text-muted d-block">Projected Savings</small>
                                    <span class="fw-bold fs-5 text-success" id="ab-projected-savings">--</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Test Notes</label>
                        <textarea class="form-control" id="ab-test-notes" rows="2" placeholder="What changes are you testing?"></textarea>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light fw-bold" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn fw-bold px-4 text-white" onclick="saveABTest()" style="background: var(--ai-gradient); border: none;"><i class="fas fa-flask me-2"></i>Start A/B Test</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ingredient Bulk Import Modal -->
    <div class="modal fade" id="ingredientBulkImportModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 glass-modal" style="border-radius: 20px;">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold" style="color: var(--accent-color);"><i class="fas fa-file-import me-2"></i>Bulk Import Ingredients</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info mb-4" style="border-radius: 12px;">
                        <h6 class="fw-bold"><i class="fas fa-info-circle me-2"></i>CSV Format Requirements:</h6>
                        <p class="mb-2">Your CSV file should have the following columns:</p>
                        <code>name,category,unit,cost,wastage,supplier,allergens</code>
                        <p class="mb-0 mt-2 small">Allergens should be comma-separated (e.g., gluten,dairy,fish)</p>
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label fw-semibold">Upload CSV File</label>
                        <div class="input-group input-group-lg">
                            <input type="file" class="form-control" id="ingredient-csv-upload" accept=".csv" onchange="previewIngredientCSV()">
                            <button onclick="downloadIngredientCSVTemplate()" class="btn btn-outline-primary fw-bold" type="button">
                                <i class="fas fa-download me-2"></i>Template
                            </button>
                        </div>
                    </div>
                    
                    <div id="ingredient-csv-preview-container" class="hidden">
                        <h6 class="fw-bold mb-3">Preview (<span id="ingredient-csv-row-count">0</span> ingredients)</h6>
                        <div class="table-responsive" style="max-height: 300px;">
                            <table class="table table-sm table-hover" id="ingredient-csv-preview-table">
                                <thead class="table-light">
                                    <tr>
                                        <th>Name</th>
                                        <th>Category</th>
                                        <th>Unit</th>
                                        <th>Cost</th>
                                        <th>Wastage</th>
                                        <th>Allergens</th>
                                    </tr>
                                </thead>
                                <tbody id="ingredient-csv-preview-body"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="ingredient-csv-import-status" class="mt-3"></div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light btn-lg fw-bold" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success btn-lg fw-bold px-4 hover-lift" id="import-ingredients-btn" onclick="importIngredientsFromPreview()" disabled>
                        <i class="fas fa-upload me-2"></i>Import Ingredients
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Recipe Bulk Import Modal -->
    <div class="modal fade" id="recipeBulkImportModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 glass-modal" style="border-radius: 20px;">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold" style="color: var(--accent-color);"><i class="fas fa-file-import me-2"></i>Bulk Import Recipes</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info mb-4" style="border-radius: 12px;">
                        <h6 class="fw-bold"><i class="fas fa-info-circle me-2"></i>CSV Format Requirements:</h6>
                        <p class="mb-2">Your CSV file should have the following columns:</p>
                        <code>recipe_name,category,portions,ingredient_name,ingredient_qty,labor_cost,target_gp</code>
                        <p class="mb-0 mt-2 small">Each ingredient is a separate row with the same recipe_name. Ingredients must exist in your database.</p>
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label fw-semibold">Upload CSV File</label>
                        <div class="input-group input-group-lg">
                            <input type="file" class="form-control" id="recipe-csv-upload" accept=".csv" onchange="previewRecipeCSV()">
                            <button onclick="downloadRecipeCSVTemplate()" class="btn btn-outline-primary fw-bold" type="button">
                                <i class="fas fa-download me-2"></i>Template
                            </button>
                        </div>
                    </div>
                    
                    <div id="recipe-csv-preview-container" class="hidden">
                        <h6 class="fw-bold mb-3">Preview (<span id="recipe-csv-row-count">0</span> recipes)</h6>
                        <div class="table-responsive" style="max-height: 300px;">
                            <table class="table table-sm table-hover" id="recipe-csv-preview-table">
                                <thead class="table-light">
                                    <tr>
                                        <th>Recipe Name</th>
                                        <th>Category</th>
                                        <th>Portions</th>
                                        <th>Ingredients</th>
                                        <th>Labor Cost</th>
                                        <th>Target GP</th>
                                    </tr>
                                </thead>
                                <tbody id="recipe-csv-preview-body"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="recipe-csv-import-status" class="mt-3"></div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light btn-lg fw-bold" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success btn-lg fw-bold px-4 hover-lift" id="import-recipes-btn" onclick="importRecipesFromPreview()" disabled>
                        <i class="fas fa-upload me-2"></i>Import Recipes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Auth Section -->
    <div id="auth-section">
        <div class="auth-card animate-scale-in">
            <div class="text-center mb-4">
                <h2 class="fw-bold mb-1" style="color: var(--primary-color);">CC & LUCIA</h2>
                <p class="text-muted mb-2">Central Kitchen Management</p>
                <span class="badge bg-warning text-dark mt-2 px-3 py-2">Tax Year 2025/26</span>
            </div>

            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('login')">Login</button>
                <button class="auth-tab" onclick="switchAuthTab('signup')">Sign Up</button>
            </div>

            <div class="verification-alert" id="verification-alert">
                <i class="fas fa-envelope-open-text me-2"></i>
                <strong>Check your email!</strong> We have sent a verification link to <span id="verification-email"></span>. Please verify before logging in.
            </div>

            <!-- Demo Accounts Notice -->
            <div class="alert alert-info mb-3" style="border-radius: 12px; font-size: 0.85rem;">
                <h6 class="fw-bold mb-2"><i class="fas fa-info-circle me-2"></i>Demo Accounts</h6>
                <div class="row g-2">
                    <div class="col-6">
                        <small><strong>Admin:</strong> admin@cc.com</small><br>
                        <small class="text-muted">Pass: admin123</small>
                    </div>
                    <div class="col-6">
                        <small><strong>Buyer:</strong> buyer@cc.com</small><br>
                        <small class="text-muted">Pass: buyer123</small>
                    </div>
                </div>
            </div>

            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="mb-3">
                    <label class="form-label fw-semibold">Email Address</label>
                    <input type="email" class="form-control form-control-lg" id="login-email" required placeholder="name@company.com">
                </div>
                <div class="mb-3">
                    <label class="form-label fw-semibold">Password</label>
                    <input type="password" class="form-control form-control-lg" id="login-password" required placeholder="">
                </div>
                <button type="submit" class="btn btn-primary w-100 py-3 fw-bold hover-lift" style="background: var(--gradient-primary); border: none;"><i class="fas fa-sign-in-alt me-2"></i> Login System</button>
                <div class="text-center mt-3">
                    <a href="#" onclick="showForgotPassword()" class="text-muted text-decoration-none small">Forgot password?</a>
                </div>
            </form>

            <form id="signupForm" class="hidden" onsubmit="handleSignup(event)">
                <div class="mb-3">
                    <label class="form-label fw-semibold">Full Name</label>
                    <input type="text" class="form-control form-control-lg" id="signup-name" required placeholder="John Smith">
                </div>
                <div class="mb-3">
                    <label class="form-label fw-semibold">Email Address</label>
                    <input type="email" class="form-control form-control-lg" id="signup-email" required placeholder="name@company.com">
                </div>
                <div class="mb-3">
                    <label class="form-label fw-semibold">Password</label>
                    <input type="password" class="form-control form-control-lg" id="signup-password" required placeholder="Min 6 characters" minlength="6">
                </div>
                
                <label class="form-label fw-semibold">Select Role</label>
                <div class="row g-3 mb-4">
                    <div class="col-6">
                        <div class="role-card hover-lift" onclick="selectRole('admin')" id="role-admin">
                            <div class="role-icon"><i class="fas fa-user-shield"></i></div>
                            <div class="fw-bold">Admin</div>
                            <small class="text-muted">Full Access</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="role-card hover-lift" onclick="selectRole('buyer')" id="role-buyer">
                            <div class="role-icon"><i class="fas fa-store"></i></div>
                            <div class="fw-bold">Buyer</div>
                            <small class="text-muted">Restaurant Unit</small>
                        </div>
                    </div>
                </div>
                <input type="hidden" id="selected-role" required>

                <div class="mb-3 hidden" id="unit-selection">
                    <label class="form-label fw-semibold">Select Unit</label>
                    <select class="form-select form-select-lg" id="signup-unit">
                        <option value="" selected disabled>Choose location...</option>
                        <option value="CC YORK">CC YORK</option>
                        <option value="LUCIA YORK">LUCIA YORK</option>
                        <option value="CC MANCHESTER">CC MANCHESTER</option>
                        <option value="CC LEEDS">CC LEEDS</option>
                        <option value="LUCIA BEVERLEY">LUCIA BEVERLEY</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary w-100 py-3 fw-bold hover-lift" style="background: var(--gradient-primary); border: none;"><i class="fas fa-user-plus me-2"></i> Create Account</button>
            </form>

            <form id="forgotForm" class="hidden" onsubmit="handleForgotPassword(event)">
                <div class="mb-3">
                    <label class="form-label fw-semibold">Email Address</label>
                    <input type="email" class="form-control form-control-lg" id="forgot-email" required>
                </div>
                <button type="submit" class="btn btn-primary w-100 py-3 fw-bold mb-3" style="background: var(--gradient-primary); border: none;"><i class="fas fa-paper-plane me-2"></i> Send Reset Link</button>
                <button type="button" class="btn btn-link w-100" onclick="switchAuthTab('login')">Back to Login</button>
            </form>
        </div>
    </div>

    <!-- Main App Layout -->
    <div id="app-layout" class="hidden">
        
        <!-- Mobile Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleMobileSidebar()"></div>
        
        <div class="sidebar d-flex flex-column" id="sidebar">
            <div class="brand-header">
                <h4 class="brand-title mb-0">CC & LUCIA</h4>
                <small class="text-muted" id="user-role-display">Role: --</small>
                <div class="mt-3">
                    <span class="tax-week-badge animate-pulse-glow" id="sidebar-tax-week">Week 1</span>
                </div>
            </div>

            <div id="sync-status-container" class="px-3 mb-2">
                <div class="sync-status-indicator offline" id="sync-status">
                    <div class="sync-pulse"></div>
                    <span id="sync-text">Local Only</span>
                </div>
            </div>

            <div id="admin-menu" class="hidden">
                <small class="text-uppercase text-muted ms-4 mb-2 fw-bold" style="font-size: 0.75rem; letter-spacing: 1px;">Management</small>
                <div class="nav-link active" onclick="showPage('admin-dashboard', this)"><i class="fas fa-chart-line"></i> Dashboard</div>
                <div class="nav-link" onclick="showPage('admin-orders', this)"><i class="fas fa-truck"></i> Unit Orders</div>
                <div class="nav-link prep-link" onclick="showPage('admin-prep-sheets', this)">
                    <i class="fas fa-utensils"></i> Prep Sheets
                    <span id="prep-badge" class="badge bg-info ms-2 hidden">0</span>
                </div>
                <div class="nav-link ai-link" onclick="showPage('admin-ai-predictions', this)">
                    <i class="fas fa-brain"></i> AI Predictions
                </div>
                <div class="nav-link" onclick="showPage('admin-recipes', this)"><i class="fas fa-book-open"></i> Recipes & GP</div>
                <div class="nav-link" onclick="showPage('admin-stock', this)"><i class="fas fa-boxes"></i> Stock</div>
                <div class="nav-link" onclick="showPage('admin-analytics', this)"><i class="fas fa-chart-pie"></i> Analytics</div>
                <div class="nav-link" onclick="showPage('admin-messages', this)">
                    <i class="fas fa-envelope"></i> Messages 
                    <span id="message-badge" class="badge bg-danger ms-2 hidden">0</span>
                </div>
                <div class="nav-link" onclick="showPage('admin-activity', this)"><i class="fas fa-history"></i> Activity Log</div>
                <div class="nav-link" onclick="showPage('admin-sync', this)">
                    <i class="fas fa-cloud"></i> Cloud Sync 
                </div>
                <div class="nav-link" onclick="showPage('admin-menu-cost', this)">
                    <i class="fas fa-calculator"></i> Menu Cost
                </div>

                <small class="text-uppercase text-muted ms-4 mb-2 fw-bold mt-3" style="font-size: 0.75rem; letter-spacing: 1px;">Kitchen</small>
                <div class="nav-link" onclick="enterKDSMode()">
                    <i class="fas fa-expand"></i> KDS Full Screen
                </div>
            </div>

            <div id="rest-menu" class="hidden">
                <small class="text-uppercase text-muted ms-4 mb-2 fw-bold" style="font-size: 0.75rem; letter-spacing: 1px;">Operations</small>
                <div class="nav-link active" onclick="showPage('rest-order', this)"><i class="fas fa-shopping-basket"></i> Place Order</div>
                <div class="nav-link" onclick="showPage('rest-history', this)"><i class="fas fa-history"></i> Order History</div>
                <div class="nav-link" onclick="showPage('rest-stock', this)"><i class="fas fa-boxes"></i> Stock Levels</div>
                <div class="nav-link" onclick="showPage('rest-messages', this)"><i class="fas fa-envelope"></i> Messages</div>
            </div>

            <div class="mt-auto p-4 border-top">
                <div class="user-profile-sidebar hidden hover-lift" id="user-profile">
                    <i class="fas fa-user-circle fa-lg" style="color: var(--accent-color);"></i>
                    <div>
                        <div class="fw-bold small" id="profile-name">User</div>
                        <div class="text-muted" style="font-size: 0.75rem;" id="profile-role">Role</div>
                    </div>
                </div>
                
                <button class="theme-toggle-sidebar hover-lift" onclick="toggleTheme()" title="Toggle Dark Mode">
                    <i class="fas fa-moon" id="theme-icon"></i>
                    <span id="theme-text">Dark Mode</span>
                </button>
                
                <button onclick="exportData()" class="sidebar-btn btn-outline-primary hover-lift"><i class="fas fa-download me-2"></i> Backup Local Data</button>
                <button onclick="logout()" class="sidebar-btn btn-outline-danger hover-lift"><i class="fas fa-sign-out-alt me-2"></i> Logout</button>
            </div>
        </div>

        <div class="main-content">
            
            <!-- Admin Dashboard -->
            <div id="admin-dashboard" class="page-section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="mb-0 fw-bold animate-slide-up">Weekly Overview</h2>
                        <small class="text-muted" id="dashboard-date-range">8 Feb - 14 Feb 2026</small>
                    </div>
                    <div class="d-flex gap-2">
                        <button onclick="syncToSupabase(true)" class="btn btn-primary btn-sm text-white hover-lift" id="quick-sync-btn" style="background: var(--sync-color); border: none;"><i class="fas fa-cloud-upload-alt me-2"></i> Sync to Cloud</button>
                        <button onclick="exportToCSV('orders')" class="btn btn-success btn-sm text-white hover-lift"><i class="fas fa-file-csv me-2"></i> Export Orders</button>
                        <button onclick="exportToCSV('inventory')" class="btn btn-success btn-sm text-white hover-lift"><i class="fas fa-file-csv me-2"></i> Export Stock</button>
                    </div>
                </div>

                <div class="row g-4 mb-4">
                    <div class="col-md-3 card-entrance">
                        <div class="stat-card border-danger hover-lift glass-card">
                            <h6 class="text-muted text-uppercase fw-bold" style="font-size: 0.8rem; letter-spacing: 1px;"><i class="fas fa-bell me-1"></i> Stock Alerts</h6>
                            <div class="d-flex align-items-end gap-2 mb-2">
                                <h3 class="mb-0" id="dash-stock-alerts-count" style="color: var(--danger-color);">0</h3>
                                <small class="text-muted mb-1">items need attention</small>
                            </div>
                            <div class="sparkline-container">
                                <canvas id="sparkline-alerts"></canvas>
                            </div>
                            <div class="stat-trend trend-down">
                                <i class="fas fa-arrow-down"></i>
                                <span>12% vs last week</span>
                            </div>
                            <div id="stock-alerts-details" style="max-height: 80px; overflow-y: auto;"><small class="text-muted">Loading...</small></div>
                            <div class="mt-2 pt-2 border-top" style="border-color: var(--border-color) !important;">
                                <small id="stock-alerts-summary" class="fw-semibold">Checking inventory...</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3 card-entrance">
                        <div class="stat-card border-prep hover-lift glass-card">
                            <h6 class="text-muted text-uppercase fw-bold" style="font-size: 0.8rem; letter-spacing: 1px;"><i class="fas fa-utensils me-1"></i> Today's Prep</h6>
                            <div class="d-flex align-items-end gap-2 mb-2">
                                <h3 class="mb-0" id="dash-prep-count" style="color: var(--prep-color);">0</h3>
                                <small class="text-muted mb-1">items planned</small>
                            </div>
                            <div class="sparkline-container">
                                <canvas id="sparkline-prep"></canvas>
                            </div>
                            <div class="stat-trend trend-up">
                                <i class="fas fa-arrow-up"></i>
                                <span>8% vs yesterday</span>
                            </div>
                            <div id="prep-summary-details" style="max-height: 80px; overflow-y: auto;"><small class="text-muted">Loading...</small></div>
                            <div class="mt-2 pt-2 border-top" style="border-color: var(--border-color) !important;">
                                <small id="prep-completion-summary" class="fw-semibold">0% completed</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3 card-entrance">
                        <div class="stat-card border-success hover-lift glass-card">
                            <h6 class="text-muted text-uppercase fw-bold" style="font-size: 0.8rem; letter-spacing: 1px;">Weekly Net Income</h6>
                            <h3 class="mb-1 text-success" id="dash-net-income">0.00</h3>
                            <div class="sparkline-container">
                                <canvas id="sparkline-income"></canvas>
                            </div>
                            <div class="stat-trend trend-up">
                                <i class="fas fa-arrow-up"></i>
                                <span>5.2% vs last week</span>
                            </div>
                            <small class="text-muted" id="income-trend">From completed invoices</small>
                        </div>
                    </div>
                    <div class="col-md-3 card-entrance">
                        <div class="stat-card border-primary hover-lift glass-card">
                            <h6 class="text-muted text-uppercase fw-bold" style="font-size: 0.8rem; letter-spacing: 1px;">Current GP %</h6>
                            <h3 class="mb-1" style="color: var(--primary-color);" id="dash-gp">--</h3>
                            <div class="sparkline-container">
                                <canvas id="sparkline-gp"></canvas>
                            </div>
                            <div class="stat-trend trend-up">
                                <i class="fas fa-arrow-up"></i>
                                <span>2.1% vs target</span>
                            </div>
                            <small class="fw-semibold" id="gp-target-variance"><i class="fas fa-minus me-1"></i> Target: 72%</small>
                        </div>
                    </div>
                </div>

                <!-- AI Prediction Banner -->
                <div class="ai-prediction-card mb-4 animate-slide-up">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center gap-3">
                            <div class="bg-white bg-opacity-25 rounded-circle p-3">
                                <i class="fas fa-robot fa-2x text-white"></i>
                            </div>
                            <div>
                                <h5 class="fw-bold mb-1 text-white">AI Prep Recommendations Available</h5>
                                <p class="mb-0 text-white opacity-75">Our AI has analyzed your patterns and suggests optimal prep quantities for today.</p>
                            </div>
                        </div>
                        <button class="btn btn-light fw-bold" onclick="openAIPredictionModal()">
                            <i class="fas fa-magic me-2"></i>View Predictions
                        </button>
                    </div>
                </div>

                <!-- Smart Alerts & Insights -->
                <div class="row g-4 mb-4">
                    <!-- Stock & Prep Alerts -->
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm glass-card" style="border-radius: 16px; border-left: 4px solid var(--warning-color) !important;">
                            <div class="card-header bg-transparent py-3" style="border-bottom: 1px solid var(--border-color);">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0 fw-bold"><i class="fas fa-lightbulb me-2" style="color: var(--warning-color);"></i>Smart Alerts</h5>
                                    <span class="badge bg-warning text-dark" id="smart-alerts-count">0 Active</span>
                                </div>
                            </div>
                            <div class="card-body" id="smart-alerts-container">
                                <div class="text-center text-muted py-4">
                                    <i class="fas fa-check-circle fa-2x mb-2 text-success"></i>
                                    <p class="mb-0">No alerts at the moment</p>
                                    <small>Everything looks good!</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Top Products Bought by Buyers -->
                <div class="card border-0 shadow-sm mb-4 glass-card" style="border-radius: 16px;">
                    <div class="card-header bg-transparent py-3 d-flex justify-content-between align-items-center" style="border-radius: 16px 16px 0 0; border-bottom: 1px solid var(--border-color);">
                        <div>
                            <h5 class="mb-0 fw-bold"><i class="fas fa-shopping-cart me-2 text-primary"></i>Top Products by Buyer Volume</h5>
                            <small class="text-muted">Most purchased items across all units this week</small>
                        </div>
                        <button onclick="exportToCSV('buyer-products')" class="btn btn-sm btn-outline-primary fw-semibold hover-lift"><i class="fas fa-file-export me-2"></i> Export</button>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="fw-bold ps-4">Product</th>
                                        <th class="fw-bold text-center">CC York</th>
                                        <th class="fw-bold text-center">Lucia York</th>
                                        <th class="fw-bold text-center">CC Manchester</th>
                                        <th class="fw-bold text-center">CC Leeds</th>
                                        <th class="fw-bold text-center">Lucia Beverley</th>
                                        <th class="fw-bold text-end">Total Qty</th>
                                        <th class="fw-bold text-end">Total Value</th>
                                    </tr>
                                </thead>
                                <tbody id="top-products-table-body">
                                    <tr>
                                        <td colspan="8" class="text-center py-4 text-muted">
                                            <i class="fas fa-spinner fa-spin me-2"></i>Loading buyer data...
                                        </td>
                                    </tr>
                                </tbody>
                                        <td class="text-center">88 pcs</td>
                                        <td class="text-center">75 pcs</td>
                                        <td class="text-end fw-bold">418 pcs</td>
                                        <td class="text-end text-success fw-bold">376.20</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm mb-4 glass-card" style="border-radius: 16px;">
                    <div class="card-header bg-transparent py-3 d-flex justify-content-between align-items-center" style="border-radius: 16px 16px 0 0; border-bottom: 1px solid var(--border-color);">
                        <h5 class="mb-0 fw-bold">Live Delivery Tracker</h5>
                        <span class="badge bg-warning text-dark px-3 py-2" id="pending-count">0 Pending</span>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle" id="delivery-table">
                                <thead class="table-light">
                                    <tr><th>Unit</th><th>Order #</th><th>Delivery Date</th><th>Value</th><th>Tax Week</th><th>Status</th><th>Action</th></tr>
                                </thead>
                                <tbody id="delivery-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm glass-card" style="border-radius: 16px;">
                    <div class="card-header bg-transparent py-3 d-flex justify-content-between align-items-center" style="border-radius: 16px 16px 0 0; border-bottom: 1px solid var(--border-color);">
                        <div>
                            <h5 class="mb-0 fw-bold">Weekly Financial Summary</h5>
                            <small class="text-muted">Connected with Analytics Data</small>
                        </div>
                        <div class="d-flex gap-2 align-items-center">
                            <span class="badge bg-primary">Week <span id="weekly-summary-week">1</span></span>
                            <span class="badge bg-info">52 Weeks</span>
                            <button onclick="exportToCSV('analytics')" class="btn btn-sm btn-outline-primary fw-semibold hover-lift"><i class="fas fa-file-export me-2"></i> Export Full Year</button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="weekly-table-container">
                            <table class="table table-sm table-hover mb-0" id="weekly-summary-table">
                                <thead><tr id="weekly-table-header"><th class="bg-primary text-white" style="position: sticky; left: 0; z-index: 10; min-width: 140px;">Metric</th></tr></thead>
                                <tbody id="weekly-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Prep Sheets -->
            <div id="admin-prep-sheets" class="page-section hidden">
                <div class="prep-header animate-slide-up">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="mb-0 fw-bold"><i class="fas fa-utensils me-2"></i>Prep Sheets</h2>
                            <small class="opacity-75">Daily preparation planning & stock management</small>
                        </div>
                        <div class="d-flex gap-2">
                            <button onclick="openAIPredictionModal()" class="btn btn-light fw-bold hover-lift" style="background: rgba(255,255,255,0.2); color: white;">
                                <i class="fas fa-brain me-2"></i> AI Predictions
                            </button>
                            <button onclick="openPrepTemplateModal()" class="btn btn-light fw-bold hover-lift"><i class="fas fa-copy me-2"></i> Templates</button>
                            <button onclick="openPrepItemModal()" class="btn btn-warning fw-bold text-dark hover-lift"><i class="fas fa-plus me-2"></i> Add Prep Item</button>
                            <button onclick="enterKDSMode()" class="btn btn-dark fw-bold hover-lift"><i class="fas fa-expand me-2"></i> KDS Mode</button>
                        </div>
                    </div>
                </div>

                <div class="row g-4 mb-4">
                    <div class="col-md-3 card-entrance">
                        <div class="prep-stats-card hover-lift">
                            <h6 class="text-muted text-uppercase fw-bold" style="font-size: 0.75rem;">Today's Prep Items</h6>
                            <h3 class="mb-1" style="color: var(--prep-color);" id="prep-today-count">0</h3>
                            <small class="text-muted">items scheduled</small>
                        </div>
                    </div>
                    <div class="col-md-3 card-entrance">
                        <div class="prep-stats-card hover-lift" style="border-left-color: var(--warning-color);">
                            <h6 class="text-muted text-uppercase fw-bold" style="font-size: 0.75rem;">In Progress</h6>
                            <h3 class="mb-1 text-warning" id="prep-progress-count">0</h3>
                            <small class="text-muted">items being prepped</small>
                        </div>
                    </div>
                    <div class="col-md-3 card-entrance">
                        <div class="prep-stats-card hover-lift" style="border-left-color: var(--success-color);">
                            <h6 class="text-muted text-uppercase fw-bold" style="font-size: 0.75rem;">Completed</h6>
                            <h3 class="mb-1 text-success" id="prep-completed-count">0</h3>
                            <small class="text-muted">items finished today</small>
                        </div>
                    </div>
                    <div class="col-md-3 card-entrance">
                        <div class="prep-stats-card hover-lift" style="border-left-color: var(--accent-color);">
                            <h6 class="text-muted text-uppercase fw-bold" style="font-size: 0.75rem;">Stock Impact</h6>
                            <h3 class="mb-1" style="color: var(--accent-color);" id="prep-stock-impact">0.00</h3>
                            <small class="text-muted">value used today</small>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary fw-bold active" id="view-daily-btn" onclick="switchPrepView('daily')"><i class="fas fa-calendar-day me-2"></i>Daily View</button>
                        <button type="button" class="btn btn-outline-primary fw-bold" id="view-weekly-btn" onclick="switchPrepView('weekly')"><i class="fas fa-calendar-week me-2"></i>Week Program</button>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <button onclick="previousPrepDay()" class="btn btn-outline-secondary hover-lift"><i class="fas fa-chevron-left"></i></button>
                        <span class="badge bg-primary px-3 py-2" id="prep-current-date">Today</span>
                        <button onclick="nextPrepDay()" class="btn btn-outline-secondary hover-lift"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>

                <div id="prep-daily-view">
                    <div class="card border-0 shadow-sm glass-card" style="border-radius: 16px;">
                        <div class="card-header bg-transparent py-3 d-flex justify-content-between align-items-center" style="border-radius: 16px 16px 0 0; border-bottom: 1px solid var(--border-color);">
                            <h5 class="mb-0 fw-bold" id="prep-daily-title">Today's Prep Sheet</h5>
                            <div class="d-flex gap-2">
                                <button onclick="markAllPrepCompleted()" class="btn btn-success btn-sm fw-bold hover-lift"><i class="fas fa-check-double me-2"></i> Complete All</button>
                                <button onclick="clearCompletedPrep()" class="btn btn-outline-danger btn-sm fw-bold hover-lift"><i class="fas fa-trash me-2"></i> Clear Completed</button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div id="prep-items-container">
                                <div class="text-center text-muted py-5">
                                    <i class="fas fa-utensils fa-3x mb-3 opacity-25"></i>
                                    <p>No prep items scheduled for this day</p>
                                    <button onclick="openPrepItemModal()" class="btn btn-primary fw-bold hover-lift" style="background: var(--prep-gradient); border: none;"><i class="fas fa-plus me-2"></i>Add First Prep Item</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="prep-weekly-view" class="hidden">
                    <div class="card border-0 shadow-sm glass-card" style="border-radius: 16px;">
                        <div class="card-header bg-transparent py-3" style="border-radius: 16px 16px 0 0; border-bottom: 1px solid var(--border-color);">
                            <h5 class="mb-0 fw-bold">Week Program View</h5>
                            <small class="text-muted">Click on any day to view or edit prep items</small>
                        </div>
                        <div class="card-body">
                            <div class="prep-week-view" id="prep-week-grid"></div>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm mt-4 glass-card" style="border-radius: 16px;">
                    <div class="card-header bg-transparent py-3" style="border-bottom: 1px solid var(--border-color);">
                        <h5 class="mb-0 fw-bold">Recent Prep Activity</h5>
                    </div>
                    <div class="card-body">
                        <div id="prep-activity-log"><div class="text-center text-muted py-3">No recent prep activity</div></div>
                    </div>
                </div>
            </div>

            <!-- Admin AI Predictions -->
            <div id="admin-ai-predictions" class="page-section hidden">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="fw-bold animate-slide-up"><i class="fas fa-brain me-2" style="color: var(--ai-color);"></i>AI Prep Predictions</h2>
                        <small class="text-muted">Smart recommendations based on historical data</small>
                    </div>
                    <div class="ai-badge"><i class="fas fa-robot"></i>AI Powered</div>
                </div>

                <div class="row g-4 mb-4">
                    <div class="col-md-4 card-entrance">
                        <div class="stat-card border-ai hover-lift glass-card">
                            <h6 class="text-muted text-uppercase fw-bold" style="font-size: 0.8rem;">Prediction Accuracy</h6>
                            <h3 class="mb-1" style="color: var(--ai-color);">87%</h3>
                            <small class="text-muted">Based on 30 days of data</small>
                            <div class="confidence-bar mt-2">
                                <div class="confidence-fill" style="width: 87%;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 card-entrance">
                        <div class="stat-card border-success hover-lift glass-card">
                            <h6 class="text-muted text-uppercase fw-bold" style="font-size: 0.8rem;">Cost Savings</h6>
                            <h3 class="mb-1 text-success">1,240</h3>
                            <small class="text-muted">This month vs manual planning</small>
                        </div>
                    </div>
                    <div class="col-md-4 card-entrance">
                        <div class="stat-card border-warning hover-lift glass-card">
                            <h6 class="text-muted text-uppercase fw-bold" style="font-size: 0.8rem;">Wastage Reduction</h6>
                            <h3 class="mb-1" style="color: var(--warning-color);">-23%</h3>
                            <small class="text-muted">Compared to last month</small>
                        </div>
                    </div>
                </div>

                <div class="ai-prediction-card mb-4">
                    <h5 class="fw-bold mb-3"><i class="fas fa-magic me-2"></i>Today's Predictions</h5>
                    <div id="ai-predictions-detail"></div>
                </div>

                <div class="card border-0 shadow-sm glass-card" style="border-radius: 16px;">
                    <div class="card-header bg-transparent py-3" style="border-bottom: 1px solid var(--border-color);">
                        <h5 class="mb-0 fw-bold">How AI Predictions Work</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 text-center">
                                <div class="bg-light rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" style="width: 80px; height: 80px;">
                                    <i class="fas fa-database fa-2x" style="color: var(--ai-color);"></i>
                                </div>
                                <h6 class="fw-bold">Data Collection</h6>
                                <small class="text-muted">Analyzes order history, prep patterns, and stock levels</small>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="bg-light rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" style="width: 80px; height: 80px;">
                                    <i class="fas fa-brain fa-2x" style="color: var(--ai-color);"></i>
                                </div>
                                <h6 class="fw-bold">Pattern Recognition</h6>
                                <small class="text-muted">Identifies trends in daily/weekly demand</small>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="bg-light rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" style="width: 80px; height: 80px;">
                                    <i class="fas fa-calculator fa-2x" style="color: var(--ai-color);"></i>
                                </div>
                                <h6 class="fw-bold">Smart Calculations</h6>
                                <small class="text-muted">Factors in seasonality and special events</small>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="bg-light rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" style="width: 80px; height: 80px;">
                                    <i class="fas fa-check-circle fa-2x" style="color: var(--ai-color);"></i>
                                </div>
                                <h6 class="fw-bold">Recommendations</h6>
                                <small class="text-muted">Provides optimal prep quantities</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>



            <!-- Admin Analytics -->
            <div id="admin-analytics" class="page-section hidden">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="fw-bold">Tax Year Analytics</h2>
                        <small class="text-muted" id="analytics-date-range">8 Feb - 14 Feb 2026</small>
                    </div>
                    <div class="d-flex align-items-center gap-3">
                        <div class="card border-0 shadow-sm px-3 py-2" style="background: var(--gradient-primary); color: white; border-radius: 12px;">
                            <small class="text-uppercase" style="font-size: 0.7rem; opacity: 0.8;">Current Week</small>
                            <span class="fw-bold fs-5" id="analytics-week-display">Week 45</span>
                        </div>
                        <div class="btn-group">
                            <button onclick="previousAnalyticsWeek()" class="btn btn-outline-secondary hover-lift"><i class="fas fa-chevron-left"></i></button>
                            <button onclick="nextAnalyticsWeek()" class="btn btn-outline-secondary hover-lift"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                </div>

                <ul class="nav nav-pills mb-4" id="analyticsTabs" role="tablist" style="background: var(--bg-color); padding: 8px; border-radius: 12px; display: inline-flex;">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active fw-bold px-4" id="weekly-tab-btn" onclick="switchAnalyticsTab('weekly')" type="button" style="border-radius: 8px;"><i class="fas fa-calendar-week me-2"></i>Weekly Summary</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link fw-bold px-4" id="meat-tab-btn" onclick="switchAnalyticsTab('meat')" type="button" style="border-radius: 8px;"><i class="fas fa-drumstick-bite me-2"></i>Meat Analysis</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link fw-bold px-4" id="buyers-tab-btn" onclick="switchAnalyticsTab('buyers')" type="button" style="border-radius: 8px;"><i class="fas fa-store me-2"></i>Buyer Analysis</button>
                    </li>
                </ul>

                <!-- KPI Cards -->
                <div class="row g-4 mb-4">
                    <div class="col-md-3 card-entrance">
                        <div class="stat-card border-accent hover-lift glass-card">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="text-muted text-uppercase fw-bold" style="font-size: 0.8rem;">Net Income</h6>
                                    <h3 class="mb-1" style="color: var(--accent-color);" id="kpi-net-income">0.00</h3>
                                </div>
                                <div class="bg-light p-2 rounded" style="background: rgba(255,107,53,0.1) !important;">
                                    <i class="fas fa-coins" style="color: var(--accent-color);"></i>
                                </div>
                            </div>
                            <small class="text-muted">Meat + Dessert Sales</small>
                        </div>
                    </div>
                    <div class="col-md-3 card-entrance">
                        <div class="stat-card border-danger hover-lift glass-card" style="border-left-color: var(--danger-color) !important;">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="text-muted text-uppercase fw-bold" style="font-size: 0.8rem;">Total Purchases</h6>
                                    <h3 class="mb-1 text-danger" id="kpi-purchases">0.00</h3>
                                </div>
                                <div class="bg-light p-2 rounded" style="background: rgba(239,68,68,0.1) !important;">
                                    <i class="fas fa-shopping-cart text-danger"></i>
                                </div>
                            </div>
                            <small class="text-muted">Weekly purchases</small>
                        </div>
                    </div>
                    <div class="col-md-3 card-entrance">
                        <div class="stat-card border-success hover-lift glass-card">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="text-muted text-uppercase fw-bold" style="font-size: 0.8rem;">Gross Profit</h6>
                                    <h3 class="mb-1 text-success" id="kpi-gp">0.00</h3>
                                </div>
                                <div class="bg-light p-2 rounded" style="background: rgba(16,185,129,0.1) !important;">
                                    <i class="fas fa-chart-line text-success"></i>
                                </div>
                            </div>
                            <small class="text-muted">Net - Purchases - Wastage</small>
                        </div>
                    </div>
                    <div class="col-md-3 card-entrance">
                        <div class="stat-card border-warning hover-lift glass-card">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="text-muted text-uppercase fw-bold" style="font-size: 0.8rem;">Wastage</h6>
                                    <h3 class="mb-1" style="color: var(--warning-color);" id="kpi-wastage">0.00</h3>
                                </div>
                                <div class="bg-light p-2 rounded" style="background: rgba(245,158,11,0.1) !important;">
                                    <i class="fas fa-trash-alt" style="color: var(--warning-color);"></i>
                                </div>
                            </div>
                            <div class="progress mt-2" style="height: 6px; border-radius: 3px;">
                                <div id="wastage-bar" class="progress-bar bg-warning" style="width: 0%; border-radius: 3px;"></div>
                            </div>
                            <small class="text-muted" id="wastage-percent">0% of purchases</small>
                        </div>
                    </div>
                </div>

                <div id="weekly-analytics-content" class="analytics-tab-content">
                    <div class="card border-0 shadow-sm glass-card" style="border-radius: 16px;">
                        <div class="card-header bg-transparent py-3" style="border-bottom: 1px solid var(--border-color);">
                            <h5 class="mb-0 fw-bold">Weekly Data Entry - Tax Week <span id="entry-week-num">45</span></h5>
                            <small class="text-muted" id="entry-analytics-date-range">8 Feb - 14 Feb 2026</small>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">Meat Sales ()</label>
                                        <div class="input-group input-group-lg">
                                            <span class="input-group-text bg-light fw-bold"></span>
                                            <input type="number" id="meat-sales-input" class="form-control" step="0.01" onchange="updateWeeklyData()">
                                        </div>
                                        <small class="text-muted" id="meat-sync-status">Not synced</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">Dessert Sales ()</label>
                                        <div class="input-group input-group-lg">
                                            <span class="input-group-text bg-light fw-bold"></span>
                                            <input type="number" id="dessert-sales-input" class="form-control" step="0.01" onchange="updateWeeklyData()">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">Purchases ()</label>
                                        <div class="input-group input-group-lg">
                                            <span class="input-group-text bg-light fw-bold"></span>
                                            <input type="number" id="purchases-input" class="form-control" step="0.01" onchange="updateWeeklyData()">
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">Wastage ()</label>
                                        <div class="input-group input-group-lg">
                                            <span class="input-group-text bg-light fw-bold"></span>
                                            <input type="number" id="wastage-input" class="form-control" step="0.01" onchange="updateWeeklyData()">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-3 p-4 rounded-3" style="background: var(--bg-color);">
                                <div>
                                    <span class="fw-bold text-muted">Calculated Gross Profit:</span>
                                    <span class="fs-3 ms-2 fw-bold" id="calculated-gp" style="color: var(--success-color);">0.00</span>
                                </div>
                                <div class="d-flex align-items-center gap-3">
                                    <div class="form-check mb-0">
                                        <input class="form-check-input" type="checkbox" id="auto-sync-check" onchange="toggleAutoSync()">
                                        <label class="form-check-label fw-semibold" for="auto-sync-check">Auto-sync invoices</label>
                                    </div>
                                    <button onclick="saveAnalyticsData()" class="btn btn-success btn-lg fw-bold hover-lift"><i class="fas fa-save me-2"></i> Save Week Data</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="meat-analytics-content" class="analytics-tab-content hidden">
                    <div class="card border-0 shadow-sm mb-4 glass-card" style="border-radius: 16px;">
                        <div class="card-header bg-transparent py-3 d-flex justify-content-between align-items-center" style="border-bottom: 1px solid var(--border-color);">
                            <div>
                                <h5 class="mb-0 fw-bold">Meat Cost Analysis - Week <span id="meat-week-display">1</span></h5>
                                <small class="text-muted" id="meat-period-display">Period details</small>
                            </div>
                            <div class="d-flex gap-2">
                                <button onclick="openAddMeatProductModal()" class="btn btn-success fw-bold hover-lift"><i class="fas fa-plus me-2"></i> Add Product</button>
                                <button onclick="openRemoveMeatProductModal()" class="btn btn-outline-danger fw-bold hover-lift"><i class="fas fa-trash me-2"></i> Remove</button>
                                <button onclick="saveMeatData()" class="btn btn-primary fw-bold hover-lift" style="background: var(--gradient-primary); border: none;"><i class="fas fa-save me-2"></i> Save Meat Data</button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="fw-bold ps-4" style="min-width: 150px;">Item</th>
                                            <th class="fw-bold text-end">Price ()</th>
                                            <th class="fw-bold text-end">Amount</th>
                                            <th class="fw-bold text-end">Value ()</th>
                                            <th class="fw-bold text-end">Wastage ()</th>
                                            <th class="fw-bold text-end">Wastage %</th>
                                        </tr>
                                    </thead>
                                    <tbody id="meat-analysis-table-body"></tbody>
                                    <tfoot class="table-group-divider fw-bold" style="background: var(--bg-color);">
                                        <tr class="text-primary">
                                            <td colspan="3" class="ps-4">Total Purchases</td>
                                            <td class="text-end text-success" id="meat-total-purchases">0.00</td>
                                            <td class="text-end text-warning" id="meat-total-wastage">0.00</td>
                                            <td class="text-end" id="meat-total-wastage-percent">0%</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="row g-4" id="meat-category-cards"></div>
                </div>

                <div id="buyers-analytics-content" class="analytics-tab-content hidden">
                    <div class="card border-0 shadow-sm mb-4 glass-card" style="border-radius: 16px;">
                        <div class="card-header bg-transparent py-3 d-flex justify-content-between align-items-center" style="border-bottom: 1px solid var(--border-color);">
                            <div>
                                <h5 class="mb-0 fw-bold">Buyer Purchase Analysis - Week <span id="buyers-week-display">1</span></h5>
                                <small class="text-muted">Track purchases by restaurant unit (Auto-synced from completed invoices)</small>
                            </div>
                            <div class="d-flex gap-2">
                                <div class="sync-status hidden" id="buyers-invoice-sync-box" style="background: var(--card-bg); border: 2px solid var(--border-color); border-radius: 12px; padding: 8px 16px;">
                                    <div class="d-flex align-items-center gap-2">
                                        <i class="fas fa-file-invoice text-success"></i>
                                        <span class="small fw-semibold"><span id="buyers-invoice-count">0</span> orders available</span>
                                        <button onclick="syncBuyersFromInvoices()" class="btn btn-sm btn-success fw-bold"><i class="fas fa-sync me-1"></i> Sync Now</button>
                                    </div>
                                </div>
                                <button onclick="openAddBuyerProductModal()" class="btn btn-success fw-bold hover-lift"><i class="fas fa-plus me-2"></i> Add Product</button>
                                <button onclick="openRemoveBuyerProductModal()" class="btn btn-outline-danger fw-bold hover-lift"><i class="fas fa-trash me-2"></i> Remove</button>
                                <button onclick="saveBuyersData()" class="btn btn-primary fw-bold hover-lift" style="background: var(--gradient-primary); border: none;"><i class="fas fa-save me-2"></i> Save Buyer Data</button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="px-4 py-2 border-bottom" style="background: var(--bg-color); border-color: var(--border-color) !important;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted" id="buyers-data-source">Manual entry</small>
                                    <div class="form-check form-switch mb-0">
                                        <input class="form-check-input" type="checkbox" id="auto-sync-buyers-check" onchange="toggleBuyersAutoSync()">
                                        <label class="form-check-label fw-semibold small" for="auto-sync-buyers-check">Auto-sync from invoices</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="fw-bold ps-4">Product</th>
                                            <th class="fw-bold text-end">Set Price ()</th>
                                            <th class="fw-bold text-end text-primary">CC York</th>
                                            <th class="fw-bold text-end text-info">Lucia York</th>
                                            <th class="fw-bold text-end text-warning">CC Manchester</th>
                                            <th class="fw-bold text-end text-success">CC Leeds</th>
                                            <th class="fw-bold text-end text-danger">Lucia Beverley</th>
                                            <th class="fw-bold text-end">Total Qty</th>
                                            <th class="fw-bold text-end">Total Value</th>
                                        </tr>
                                    </thead>
                                    <tbody id="buyers-analysis-table-body"></tbody>
                                    <tfoot class="table-group-divider fw-bold" style="background: var(--bg-color);">
                                        <tr>
                                            <td class="ps-4" colspan="2">BUYER TOTALS</td>
                                            <td class="text-end text-primary" id="total-cc-york">0</td>
                                            <td class="text-end text-info" id="total-lucia-york">0</td>
                                            <td class="text-end text-warning" id="total-cc-manchester">0</td>
                                            <td class="text-end text-success" id="total-cc-leeds">0</td>
                                            <td class="text-end text-danger" id="total-lucia-beverley">0</td>
                                            <td class="text-end" id="grand-total-qty">0</td>
                                            <td class="text-end text-success" id="grand-total-value">0.00</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="row g-4" id="buyer-summary-cards"></div>
                </div>
            </div>

            <!-- Admin Recipes -->
            <div id="admin-recipes" class="page-section hidden">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="fw-bold">Menu Engineering & GP</h2>
                    <button class="btn btn-primary fw-bold hover-lift" onclick="openAddProductModal()" style="background: var(--gradient-primary); border: none;"><i class="fas fa-plus me-2"></i> New Dish</button>
                </div>

                <div class="row">
                    <div class="col-md-4">
                        <div class="gp-calculator mb-4 hover-lift">
                            <h5 class="fw-bold mb-3"><i class="fas fa-calculator me-2"></i> Quick GP Calculator</h5>
                            <div class="mb-3">
                                <label class="form-label">Cost Price ()</label>
                                <input type="number" id="gp-cost" class="form-control form-control-lg" placeholder="e.g. 4.50" step="0.01" oninput="calculateGP()">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Selling Price (Net VAT) ()</label>
                                <input type="number" id="gp-sell" class="form-control form-control-lg" placeholder="e.g. 15.00" step="0.01" oninput="calculateGP()">
                            </div>
                            <div class="mt-4 text-center p-3 bg-white bg-opacity-25 rounded-3">
                                <div class="small text-uppercase fw-bold mb-1 opacity-75">Gross Profit</div>
                                <h2 class="mb-0 fw-bold" id="gp-result" style="font-size: 3rem;">0%</h2>
                            </div>
                        </div>
                        
                        <div class="card border-0 shadow-sm p-4 hover-lift" style="border-radius: 16px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                            <h6 class="fw-bold mb-2"><i class="fas fa-lightbulb me-2"></i> GP Health Guide</h6>
                            <div class="d-flex justify-content-between align-items-center mb-2"><span>Excellent</span><span class="fw-bold">> 70%</span></div>
                            <div class="progress mb-3" style="height: 8px; background: rgba(255,255,255,0.3);"><div class="progress-bar bg-success" style="width: 100%;"></div></div>
                            <div class="d-flex justify-content-between align-items-center mb-2"><span>Good</span><span class="fw-bold">65% - 70%</span></div>
                            <div class="progress mb-3" style="height: 8px; background: rgba(255,255,255,0.3);"><div class="progress-bar bg-warning" style="width: 75%;"></div></div>
                            <div class="d-flex justify-content-between align-items-center"><span>Needs Work</span><span class="fw-bold">< 65%</span></div>
                            <div class="progress" style="height: 8px; background: rgba(255,255,255,0.3);"><div class="progress-bar bg-danger" style="width: 50%;"></div></div>
                        </div>
                    </div>

                    <div class="col-md-8">
                        <div class="card border-0 shadow-sm glass-card" style="border-radius: 16px;">
                            <div class="card-header bg-transparent py-3" style="border-radius: 16px 16px 0 0; border-bottom: 1px solid var(--border-color);">
                                <h6 class="fw-bold mb-0 text-muted text-uppercase" style="font-size: 0.85rem; letter-spacing: 1px;">Recipe Database</h6>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light">
                                        <tr><th class="fw-bold">Dish Name</th><th class="fw-bold">Category</th><th class="fw-bold">Cost</th><th class="fw-bold">Est. Sell</th><th class="fw-bold">GP %</th><th class="fw-bold">Action</th></tr>
                                    </thead>
                                    <tbody id="recipe-table-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Stock -->
            <div id="admin-stock" class="page-section hidden">
                <h2 class="mb-4 fw-bold">Stock Management</h2>
                
                <div class="row mb-4">
                    <div class="col-md-8">
                        <div class="input-group input-group-lg">
                            <span class="input-group-text bg-light"><i class="fas fa-search text-muted"></i></span>
                            <input type="text" id="stock-search" class="form-control" placeholder="Search inventory..." oninput="filterStock()">
                            <select id="stock-category" class="form-select fw-semibold" style="max-width: 200px; border-left: 2px solid var(--border-color);" onchange="filterStock()">
                                <option value="all">All Categories</option>
                                <option value="meat">Meat & Fish</option>
                                <option value="produce">Produce</option>
                                <option value="sauces">Sauces</option>
                                <option value="prepared">Prepared</option>
                                <option value="desserts">Desserts</option>
                                <option value="dry">Dry Goods</option>
                                <option value="nonfood">Non Food</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <button onclick="openARScanner()" class="btn btn-primary btn-lg me-2 text-white hover-lift" style="background: var(--ar-color); border: none;"><i class="fas fa-cube me-2"></i> AR Scan</button>
                        <button onclick="openQrScanner()" class="btn btn-primary btn-lg me-2 text-white hover-lift" style="background: var(--sync-color); border: none;"><i class="fas fa-camera me-2"></i> Scan QR</button>
                        <button onclick="openBulkImportModal()" class="btn btn-warning btn-lg me-2 text-dark hover-lift"><i class="fas fa-file-import me-2"></i> Bulk Import</button>
                        <button onclick="exportFilteredCSV()" class="btn btn-success btn-lg text-white hover-lift"><i class="fas fa-file-export me-2"></i> Export Filtered</button>
                    </div>
                </div>

                <div class="alert alert-info d-flex justify-content-between align-items-center mb-4" style="border-radius: 12px; border: none; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);">
                    <span class="fw-semibold"><i class="fas fa-info-circle me-2"></i> Manage stock levels and product details. Click any product to edit. Set Max Order to limit buyer quantities (0 = unlimited).</span>
                    <span class="badge bg-warning text-dark px-3 py-2" id="stock-low-count">0 items low</span>
                </div>
                
                <div class="row" id="stock-grid"></div>
            </div>

            <!-- Admin Orders -->
            <div id="admin-orders" class="page-section hidden">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="fw-bold">Unit Orders History</h2>
                    <button onclick="exportToCSV('analytics')" class="btn btn-success text-white hover-lift"><i class="fas fa-file-export me-2"></i> Export Full Analytics</button>
                </div>
                
                <div class="row mb-4" id="expenditure-summary"></div>
                
                <div class="card border-0 shadow-sm mb-4 glass-card" style="border-radius: 16px;">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <label class="form-label fw-bold text-muted">Filter by Tax Week</label>
                                <select id="order-week-filter" class="form-select form-select-lg" onchange="renderAllOrders()"><option value="all">All Weeks (2025/26)</option></select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold text-muted">Filter by Restaurant</label>
                                <select id="order-restaurant-filter" class="form-select form-select-lg" onchange="renderAllOrders()">
                                    <option value="all">All Restaurants</option>
                                    <option value="CC YORK">CC YORK</option>
                                    <option value="LUCIA YORK">LUCIA YORK</option>
                                    <option value="CC MANCHESTER">CC MANCHESTER</option>
                                    <option value="CC LEEDS">CC LEEDS</option>
                                    <option value="LUCIA BEVERLEY">LUCIA BEVERLEY</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold text-muted">Filter by Status</label>
                                <select id="order-status-filter" class="form-select form-select-lg" onchange="renderAllOrders()">
                                    <option value="all">All Statuses</option>
                                    <option value="pending">Pending</option>
                                    <option value="out_for_delivery">Out for Delivery</option>
                                    <option value="completed">Completed</option>
                                </select>
                            </div>
                            <div class="col-md-3 text-end">
                                <div class="expenditure-card mb-0">
                                    <div class="small text-uppercase fw-bold opacity-75">Total Expenditure (Selected)</div>
                                    <div class="expenditure-amount" id="total-expenditure">0.00</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm glass-card" style="border-radius: 16px;">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr><th class="fw-bold">Invoice #</th><th class="fw-bold">Date</th><th class="fw-bold">Unit</th><th class="fw-bold">Items</th><th class="fw-bold">Total</th><th class="fw-bold">Tax Week</th><th class="fw-bold">Status</th><th class="fw-bold">Update</th></tr>
                            </thead>
                            <tbody id="all-orders-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Admin Messages -->
            <div id="admin-messages" class="page-section hidden">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="fw-bold">Messages</h2>
                    <div>
                        <button onclick="deleteAllReadMessages()" class="btn btn-outline-danger btn-sm fw-bold" id="delete-read-btn" style="display:none;"><i class="fas fa-trash me-2"></i> Delete Read</button>
                        <span class="badge bg-primary ms-2 px-3 py-2" id="total-messages-count">0 Total</span>
                    </div>
                </div>
                <div id="messages-container"></div>
            </div>
            
            <!-- Admin Activity Log -->
            <div id="admin-activity" class="page-section hidden">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="fw-bold">Activity Log</h2>
                    <button onclick="clearActivityLog()" class="btn btn-outline-danger btn-sm hover-lift"><i class="fas fa-trash me-2"></i> Clear Log</button>
                </div>
                <div class="card border-0 shadow-sm glass-card" style="border-radius: 16px;">
                    <div class="card-header bg-transparent py-3" style="border-bottom: 1px solid var(--border-color);"><h6 class="fw-bold mb-0">User Login Activity</h6></div>
                    <div class="card-body" id="activity-log-container"><div class="text-center text-muted py-5">No activity recorded yet</div></div>
                </div>
            </div>

            <!-- Admin Cloud Sync (Supabase) -->
            <div id="admin-sync" class="page-section hidden">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="fw-bold">Cloud Synchronization</h2>
                    <span class="badge bg-info text-dark px-3 py-2"><i class="fas fa-server me-1"></i> Supabase</span>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="sync-config-card hover-lift">
                            <h5 class="fw-bold mb-3"><i class="fas fa-cog me-2"></i> Supabase Configuration</h5>
                            <p class="small opacity-75 mb-3">Configure your Supabase credentials to enable cloud synchronization across devices.</p>

                            <div class="mb-3">
                                <label class="form-label fw-semibold">Supabase URL</label>
                                <input type="text" class="form-control" id="supabase-url" placeholder="https://your-project.supabase.co">
                                <small class="opacity-75">Your Supabase project URL</small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-semibold">API Key (anon/public)</label>
                                <input type="password" class="form-control" id="supabase-key" placeholder="eyJhbGciOiJIUzI1NiIs...">
                                <small class="opacity-75">Found in your Supabase Project Settings > API</small>
                            </div>

                            <div class="d-flex gap-2 mt-4">
                                <button onclick="testSupabaseConnection()" class="btn btn-light fw-bold hover-lift"><i class="fas fa-plug me-2"></i> Test Connection</button>
                                <button onclick="saveSupabaseConfig()" class="btn btn-dark fw-bold hover-lift"><i class="fas fa-save me-2"></i> Save Config</button>
                            </div>

                            <div class="mt-4 p-3 bg-light rounded-3">
                                <h6 class="fw-bold mb-2"><i class="fas fa-info-circle me-2"></i>Setup Instructions</h6>
                                <ol class="small mb-0 ps-3">
                                    <li>Create a free account at <a href="https://supabase.com" target="_blank">supabase.com</a></li>
                                    <li>Create a new project</li>
                                    <li>Go to SQL Editor and run:
                                        <code class="d-block bg-dark text-light p-2 rounded mt-1" style="font-size: 0.75rem;">CREATE TABLE sync_data (id INT PRIMARY KEY, data JSONB, updated_at TIMESTAMP);</code>
                                    </li>
                                    <li>Copy your Project URL and anon key from Settings > API</li>
                                </ol>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="sync-status-card hover-lift">
                            <h5 class="fw-bold mb-3"><i class="fas fa-exchange-alt me-2"></i> Sync Controls</h5>

                            <div class="d-flex align-items-center gap-3 mb-4">
                                <div id="admin-sync-status" class="sync-status-indicator offline"></div>
                                <span id="admin-sync-text" class="fw-semibold">Local Only</span>
                            </div>

                            <div class="d-grid gap-2 mb-4">
                                <button onclick="syncToSupabase()" class="btn btn-primary fw-bold hover-lift" style="background: var(--gradient-primary); border: none;">
                                    <i class="fas fa-cloud-upload-alt me-2"></i> Upload to Cloud
                                </button>
                                <button onclick="syncFromSupabase()" class="btn btn-outline-primary fw-bold hover-lift">
                                    <i class="fas fa-cloud-download-alt me-2"></i> Download from Cloud
                                </button>
                                <button onclick="mergeSupabaseData()" class="btn btn-outline-secondary fw-bold hover-lift">
                                    <i class="fas fa-code-branch me-2"></i> Merge Data
                                </button>
                            </div>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="auto-sync-toggle" onchange="toggleAutoSyncSupabase()">
                                    <label class="form-check-label fw-semibold" for="auto-sync-toggle">Auto-sync (every 5 minutes)</label>
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="startup-sync-toggle" onchange="toggleStartupSync()">
                                    <label class="form-check-label fw-semibold" for="startup-sync-toggle">Sync on startup</label>
                                </div>
                            </div>

                            <div class="mt-4 p-3 bg-light rounded-3">
                                <h6 class="fw-bold mb-2"><i class="fas fa-info-circle me-2"></i>Sync Information</h6>
                                <div class="small">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="opacity-75">Last Sync:</span>
                                        <span id="last-sync-time" class="fw-semibold">Never</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span class="opacity-75">Data Size:</span>
                                        <span id="data-size" class="fw-semibold">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card border-0 shadow-sm mt-4" style="border-radius: 16px;">
                            <div class="card-header bg-transparent py-3" style="border-bottom: 1px solid var(--border-color);">
                                <h6 class="fw-bold mb-0"><i class="fas fa-history me-2"></i>Sync Log</h6>
                            </div>
                            <div class="card-body">
                                <div id="sync-log" class="small" style="max-height: 200px; overflow-y: auto;">
                                    <div class="text-muted">No sync activity yet</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Menu Cost -->
            <div id="admin-menu-cost" class="page-section hidden">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="fw-bold animate-slide-up"><i class="fas fa-calculator me-2" style="color: var(--accent-color);"></i>Menu Cost</h2>
                        <small class="text-muted">Recipe costing, ingredients & menu engineering</small>
                    </div>
                    <span class="badge bg-primary px-3 py-2"><i class="fas fa-utensils me-1"></i> Cost Control</span>
                </div>

                <!-- Sub Navigation Tabs -->
                <ul class="nav nav-pills mb-4" id="menuCostTabs" role="tablist" style="background: var(--bg-color); padding: 8px; border-radius: 12px; display: inline-flex;">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active fw-bold px-4" id="ingredients-tab-btn" onclick="switchMenuCostTab('ingredients')" type="button" style="border-radius: 8px;"><i class="fas fa-carrot me-2"></i>Ingredients</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link fw-bold px-4" id="recipe-tab-btn" onclick="switchMenuCostTab('recipe')" type="button" style="border-radius: 8px;"><i class="fas fa-book-open me-2"></i>Recipe</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link fw-bold px-4" id="menu-cost-tab-btn" onclick="switchMenuCostTab('menu-cost')" type="button" style="border-radius: 8px;"><i class="fas fa-chart-pie me-2"></i>Menu Cost</button>
                    </li>
                </ul>

                <!-- Ingredients Tab -->
                <div id="ingredients-content" class="menu-cost-tab-content">
                    <div class="row g-4 mb-4">
                        <div class="col-md-3 card-entrance">
                            <div class="stat-card border-accent hover-lift glass-card">
                                <h6 class="text-muted text-uppercase fw-bold" style="font-size: 0.8rem;"><i class="fas fa-cubes me-1"></i> Total Ingredients</h6>
                                <h3 class="mb-1" style="color: var(--accent-color);" id="total-ingredients-count">0</h3>
                                <small class="text-muted">in database</small>
                            </div>
                        </div>
                        <div class="col-md-3 card-entrance">
                            <div class="stat-card border-warning hover-lift glass-card">
                                <h6 class="text-muted text-uppercase fw-bold" style="font-size: 0.8rem;"><i class="fas fa-exclamation-triangle me-1"></i> Price Alerts</h6>
                                <h3 class="mb-1" style="color: var(--warning-color);" id="price-alerts-count">0</h3>
                                <small class="text-muted">cost increases</small>
                            </div>
                        </div>
                        <div class="col-md-3 card-entrance">
                            <div class="stat-card border-success hover-lift glass-card">
                                <h6 class="text-muted text-uppercase fw-bold" style="font-size: 0.8rem;"><i class="fas fa-sync me-1"></i> Last Updated</h6>
                                <h3 class="mb-1 text-success" id="last-price-update">Today</h3>
                                <small class="text-muted">price refresh</small>
                            </div>
                        </div>
                        <div class="col-md-3 card-entrance">
                            <div class="stat-card border-primary hover-lift glass-card">
                                <h6 class="text-muted text-uppercase fw-bold" style="font-size: 0.8rem;"><i class="fas fa-pound-sign me-1"></i> Avg Cost Change</h6>
                                <h3 class="mb-1" style="color: var(--primary-color);" id="avg-cost-change">+2.3%</h3>
                                <small class="text-muted">vs last month</small>
                            </div>
                        </div>
                    </div>

                    <div class="card border-0 shadow-sm glass-card" style="border-radius: 16px;">
                        <div class="card-header bg-transparent py-3 d-flex justify-content-between align-items-center" style="border-radius: 16px 16px 0 0; border-bottom: 1px solid var(--border-color);">
                            <div>
                                <h5 class="mb-0 fw-bold"><i class="fas fa-carrot me-2"></i>Ingredient Database</h5>
                                <small class="text-muted">Manage all ingredients with real-time pricing</small>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-success fw-bold hover-lift" onclick="openIngredientBulkImportModal()"><i class="fas fa-file-import me-2"></i> Bulk Import</button>
                                <button class="btn btn-primary fw-bold hover-lift" onclick="openAddIngredientModal()" style="background: var(--gradient-primary); border: none;"><i class="fas fa-plus me-2"></i> Add Ingredient</button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="fw-bold ps-4">Ingredient</th>
                                            <th class="fw-bold">Category</th>
                                            <th class="fw-bold text-center"><i class="fas fa-exclamation-triangle text-warning"></i> Allergens</th>
                                            <th class="fw-bold text-end">Unit Cost</th>
                                            <th class="fw-bold text-end">Wastage %</th>
                                            <th class="fw-bold text-end">Effective Cost</th>
                                            <th class="fw-bold text-center">Trend</th>
                                            <th class="fw-bold text-center">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ingredients-table-body">
                                        <tr>
                                            <td colspan="8" class="text-center py-5 text-muted">
                                                <i class="fas fa-carrot fa-3x mb-3 opacity-25"></i>
                                                <p>No ingredients added yet</p>
                                                <button class="btn btn-primary fw-bold" onclick="openAddIngredientModal()" style="background: var(--gradient-primary); border: none;"><i class="fas fa-plus me-2"></i> Add First Ingredient</button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recipe Tab -->
                <div id="recipe-content" class="menu-cost-tab-content hidden">
                    <div class="row g-4 mb-4">
                        <div class="col-md-3 card-entrance">
                            <div class="stat-card border-accent hover-lift glass-card">
                                <h6 class="text-muted text-uppercase fw-bold" style="font-size: 0.8rem;"><i class="fas fa-book me-1"></i> Total Recipes</h6>
                                <h3 class="mb-1" style="color: var(--accent-color);" id="total-recipes-count">0</h3>
                                <small class="text-muted">active recipes</small>
                            </div>
                        </div>
                        <div class="col-md-3 card-entrance">
                            <div class="stat-card border-success hover-lift glass-card">
                                <h6 class="text-muted text-uppercase fw-bold" style="font-size: 0.8rem;"><i class="fas fa-check-circle me-1"></i> Avg Recipe GP</h6>
                                <h3 class="mb-1 text-success" id="avg-recipe-gp">68%</h3>
                                <small class="text-muted">gross profit</small>
                            </div>
                        </div>
                        <div class="col-md-3 card-entrance">
                            <div class="stat-card border-prep hover-lift glass-card">
                                <h6 class="text-muted text-uppercase fw-bold" style="font-size: 0.8rem;"><i class="fas fa-layer-group me-1"></i> Sub-Recipes</h6>
                                <h3 class="mb-1" style="color: var(--prep-color);" id="sub-recipes-count">0</h3>
                                <small class="text-muted">sauces & bases</small>
                            </div>
                        </div>
                        <div class="col-md-3 card-entrance">
                            <div class="stat-card border-ai hover-lift glass-card">
                                <h6 class="text-muted text-uppercase fw-bold" style="font-size: 0.8rem;"><i class="fas fa-flask me-1"></i> A/B Tests</h6>
                                <h3 class="mb-1" style="color: var(--ai-color);" id="ab-tests-count">0</h3>
                                <small class="text-muted">active tests</small>
                            </div>
                        </div>
                    </div>

                    <!-- Visual Recipe Builder -->
                    <div class="card border-0 shadow-sm glass-card mb-4" style="border-radius: 16px; border: 2px solid var(--accent-color) !important;">
                        <div class="card-header bg-transparent py-3" style="border-radius: 16px 16px 0 0; border-bottom: 1px solid var(--border-color);">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-0 fw-bold"><i class="fas fa-magic me-2" style="color: var(--accent-color);"></i>Visual Recipe Builder</h5>
                                    <small class="text-muted">Drag-and-drop recipe creation with live costing</small>
                                </div>
                                <button class="btn btn-primary fw-bold hover-lift" onclick="openRecipeBuilder()" style="background: var(--gradient-primary); border: none;"><i class="fas fa-plus me-2"></i> New Recipe</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="alert alert-info mb-3" style="border-radius: 12px;">
                                        <i class="fas fa-lightbulb me-2"></i>
                                        <strong>Tip:</strong> Drag ingredients from the sidebar to build your recipe. Costs update automatically as you add items.
                                    </div>
                                    <div id="recipe-builder-canvas" class="p-4 rounded-3" style="background: var(--bg-color); min-height: 300px; border: 2px dashed var(--border-color);">
                                        <div class="text-center text-muted py-5">
                                            <i class="fas fa-hand-pointer fa-3x mb-3 opacity-25"></i>
                                            <p>Click "New Recipe" to start building</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card border-0 shadow-sm" style="border-radius: 12px; background: var(--bg-color);">
                                        <div class="card-header bg-transparent py-3" style="border-bottom: 1px solid var(--border-color);">
                                            <h6 class="fw-bold mb-0"><i class="fas fa-calculator me-2"></i>Live Costing</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span class="text-muted">Ingredient Cost</span>
                                                    <span class="fw-bold" id="live-ingredient-cost">0.00</span>
                                                </div>
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span class="text-muted">Wastage Cost</span>
                                                    <span class="fw-bold text-warning" id="live-wastage-cost">0.00</span>
                                                </div>
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span class="text-muted">Labor Cost</span>
                                                    <span class="fw-bold" id="live-labor-cost">0.00</span>
                                                </div>
                                                <hr style="border-color: var(--border-color);">
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span class="fw-bold">Total Recipe Cost</span>
                                                    <span class="fw-bold fs-5" style="color: var(--accent-color);" id="live-total-cost">0.00</span>
                                                </div>
                                                <div class="d-flex justify-content-between">
                                                    <span class="text-muted">Suggested Sell Price</span>
                                                    <span class="fw-bold text-success" id="live-sell-price">0.00</span>
                                                </div>
                                                <div class="mt-3 p-2 rounded-3 text-center" style="background: var(--card-bg);">
                                                    <small class="text-muted d-block">Projected GP</small>
                                                    <span class="fw-bold fs-4" id="live-projected-gp">--</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recipe List -->
                    <div class="card border-0 shadow-sm glass-card" style="border-radius: 16px;">
                        <div class="card-header bg-transparent py-3 d-flex justify-content-between align-items-center" style="border-bottom: 1px solid var(--border-color);">
                            <div>
                                <h5 class="mb-0 fw-bold"><i class="fas fa-list me-2"></i>Recipe Library</h5>
                                <small class="text-muted">All recipes with versioning & A/B testing</small>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-success fw-bold" onclick="openRecipeBulkImportModal()"><i class="fas fa-file-import me-1"></i> Bulk Import</button>
                                <button class="btn btn-outline-primary fw-bold" onclick="filterRecipes('all')"><i class="fas fa-th-large me-1"></i> All</button>
                                <button class="btn btn-outline-success fw-bold" onclick="filterRecipes('star')"><i class="fas fa-star me-1"></i> Stars</button>
                                <button class="btn btn-outline-warning fw-bold" onclick="filterRecipes('puzzle')"><i class="fas fa-puzzle-piece me-1"></i> Puzzles</button>
                                <button class="btn btn-outline-danger fw-bold" onclick="filterRecipes('dog')"><i class="fas fa-dog me-1"></i> Dogs</button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="fw-bold ps-4">Recipe Name</th>
                                            <th class="fw-bold">Category</th>
                                            <th class="fw-bold text-end">Portion Cost</th>
                                            <th class="fw-bold text-end">Sell Price</th>
                                            <th class="fw-bold text-center">GP %</th>
                                            <th class="fw-bold text-center">Version</th>
                                            <th class="fw-bold text-center">A/B Test</th>
                                            <th class="fw-bold text-center">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recipes-table-body">
                                        <tr>
                                            <td colspan="8" class="text-center py-5 text-muted">
                                                <i class="fas fa-book-open fa-3x mb-3 opacity-25"></i>
                                                <p>No recipes created yet</p>
                                                <button class="btn btn-primary fw-bold" onclick="openRecipeBuilder()" style="background: var(--gradient-primary); border: none;"><i class="fas fa-plus me-2"></i> Create First Recipe</button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Menu Cost Tab -->
                <div id="menu-cost-content" class="menu-cost-tab-content hidden">
                    <!-- Menu Engineering Matrix -->
                    <div class="card border-0 shadow-sm glass-card mb-4" style="border-radius: 16px; border: 2px solid var(--primary-color) !important;">
                        <div class="card-header bg-transparent py-3" style="border-radius: 16px 16px 0 0; border-bottom: 1px solid var(--border-color);">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-0 fw-bold"><i class="fas fa-th me-2" style="color: var(--primary-color);"></i>Menu Engineering Matrix</h5>
                                    <small class="text-muted">Auto-categorization based on popularity & profitability</small>
                                </div>
                                <button class="btn btn-primary fw-bold hover-lift" onclick="runAutoCategorization()" style="background: var(--gradient-primary); border: none;"><i class="fas fa-sync me-2"></i> Auto-Categorize</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row g-4">
                                <!-- Stars -->
                                <div class="col-md-6">
                                    <div class="card border-0 h-100" style="border-radius: 12px; background: linear-gradient(135deg, rgba(16,185,129,0.1) 0%, rgba(5,150,105,0.1) 100%); border: 2px solid var(--success-color) !important;">
                                        <div class="card-header bg-transparent py-3" style="border-bottom: 1px solid rgba(16,185,129,0.2);">
                                            <div class="d-flex align-items-center gap-2">
                                                <i class="fas fa-star fa-lg text-success"></i>
                                                <h6 class="fw-bold mb-0 text-success">STARS</h6>
                                                <span class="badge bg-success ms-auto" id="stars-count">0</span>
                                            </div>
                                            <small class="text-muted">High Profit + High Popularity</small>
                                        </div>
                                        <div class="card-body" id="stars-list">
                                            <div class="text-center text-muted py-3">
                                                <small>No items categorized yet</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Puzzles -->
                                <div class="col-md-6">
                                    <div class="card border-0 h-100" style="border-radius: 12px; background: linear-gradient(135deg, rgba(245,158,11,0.1) 0%, rgba(217,119,6,0.1) 100%); border: 2px solid var(--warning-color) !important;">
                                        <div class="card-header bg-transparent py-3" style="border-bottom: 1px solid rgba(245,158,11,0.2);">
                                            <div class="d-flex align-items-center gap-2">
                                                <i class="fas fa-puzzle-piece fa-lg" style="color: var(--warning-color);"></i>
                                                <h6 class="fw-bold mb-0" style="color: var(--warning-color);">PUZZLES</h6>
                                                <span class="badge bg-warning text-dark ms-auto" id="puzzles-count">0</span>
                                            </div>
                                            <small class="text-muted">High Profit + Low Popularity</small>
                                        </div>
                                        <div class="card-body" id="puzzles-list">
                                            <div class="text-center text-muted py-3">
                                                <small>No items categorized yet</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Plow Horses -->
                                <div class="col-md-6">
                                    <div class="card border-0 h-100" style="border-radius: 12px; background: linear-gradient(135deg, rgba(6,182,212,0.1) 0%, rgba(8,145,178,0.1) 100%); border: 2px solid var(--prep-color) !important;">
                                        <div class="card-header bg-transparent py-3" style="border-bottom: 1px solid rgba(6,182,212,0.2);">
                                            <div class="d-flex align-items-center gap-2">
                                                <i class="fas fa-horse fa-lg" style="color: var(--prep-color);"></i>
                                                <h6 class="fw-bold mb-0" style="color: var(--prep-color);">PLOW HORSES</h6>
                                                <span class="badge" style="background: var(--prep-color);" id="plowhorses-count">0</span>
                                            </div>
                                            <small class="text-muted">Low Profit + High Popularity</small>
                                        </div>
                                        <div class="card-body" id="plowhorses-list">
                                            <div class="text-center text-muted py-3">
                                                <small>No items categorized yet</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Dogs -->
                                <div class="col-md-6">
                                    <div class="card border-0 h-100" style="border-radius: 12px; background: linear-gradient(135deg, rgba(239,68,68,0.1) 0%, rgba(220,38,38,0.1) 100%); border: 2px solid var(--danger-color) !important;">
                                        <div class="card-header bg-transparent py-3" style="border-bottom: 1px solid rgba(239,68,68,0.2);">
                                            <div class="d-flex align-items-center gap-2">
                                                <i class="fas fa-dog fa-lg text-danger"></i>
                                                <h6 class="fw-bold mb-0 text-danger">DOGS</h6>
                                                <span class="badge bg-danger ms-auto" id="dogs-count">0</span>
                                            </div>
                                            <small class="text-muted">Low Profit + Low Popularity</small>
                                        </div>
                                        <div class="card-body" id="dogs-list">
                                            <div class="text-center text-muted py-3">
                                                <small>No items categorized yet</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recipe Versioning & A/B Testing -->
                    <div class="card border-0 shadow-sm glass-card" style="border-radius: 16px; border: 2px solid var(--ai-color) !important;">
                        <div class="card-header bg-transparent py-3" style="border-radius: 16px 16px 0 0; border-bottom: 1px solid var(--border-color);">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-0 fw-bold"><i class="fas fa-code-branch me-2" style="color: var(--ai-color);"></i>Recipe Versioning & A/B Testing</h5>
                                    <small class="text-muted">Compare recipe versions and run profitability tests</small>
                                </div>
                                <button class="btn fw-bold hover-lift text-white" onclick="startNewABTest()" style="background: var(--ai-gradient); border: none;"><i class="fas fa-flask me-2"></i> New A/B Test</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <div class="card border-0 h-100" style="border-radius: 12px; background: var(--bg-color);">
                                        <div class="card-header bg-transparent py-3" style="border-bottom: 1px solid var(--border-color);">
                                            <h6 class="fw-bold mb-0"><i class="fas fa-history me-2"></i>Version History</h6>
                                        </div>
                                        <div class="card-body" id="version-history-list">
                                            <div class="text-center text-muted py-4">
                                                <i class="fas fa-code-branch fa-2x mb-2 opacity-25"></i>
                                                <p class="mb-0">No versions yet</p>
                                                <small>Recipe changes are tracked automatically</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card border-0 h-100" style="border-radius: 12px; background: var(--bg-color);">
                                        <div class="card-header bg-transparent py-3" style="border-bottom: 1px solid var(--border-color);">
                                            <h6 class="fw-bold mb-0"><i class="fas fa-flask me-2"></i>Active A/B Tests</h6>
                                        </div>
                                        <div class="card-body" id="active-ab-tests">
                                            <div class="text-center text-muted py-4">
                                                <i class="fas fa-vial fa-2x mb-2 opacity-25"></i>
                                                <p class="mb-0">No active tests</p>
                                                <small>Create a test to compare recipe variants</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Restaurant Order -->
            <div id="rest-order" class="page-section hidden">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 id="rest-title" class="fw-bold">New Order</h2>
                    <div class="d-flex gap-2">
                        <span class="badge bg-warning text-dark p-2 px-3"><i class="fas fa-clock me-1"></i> Cut-off: 10:00 PM</span>
                        <span class="badge bg-info text-dark p-2 px-3" id="rest-tax-week">Week 1</span>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-8">
                        <div class="card border-0 shadow-sm mb-3 glass-card" style="border-radius: 16px;">
                            <div class="card-header bg-transparent py-3" style="border-radius: 16px 16px 0 0; border-bottom: 1px solid var(--border-color);">
                                <div class="input-group input-group-lg">
                                    <span class="input-group-text bg-light border-0"><i class="fas fa-search text-muted"></i></span>
                                    <input type="text" id="order-search" class="form-control border-0 bg-light" placeholder="Search items..." oninput="filterOrderItems()">
                                </div>
                            </div>
                            <div class="card-body" id="order-items-container" style="max-height: 65vh; overflow-y: auto;"></div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="card border-0 shadow-lg sticky-top hover-lift" style="top: 20px; border-radius: 16px; border: 2px solid var(--accent-color) !important; background: var(--card-bg);">
                            <div class="card-body">
                                <h5 class="fw-bold mb-3" style="color: var(--primary-color);"><i class="fas fa-shopping-cart me-2"></i> Order Summary</h5>
                                <hr style="border-color: var(--border-color);">
                                <div id="current-order-items" class="mb-3" style="max-height: 300px; overflow-y: auto;"><p class="text-muted text-center">Cart is empty</p></div>
                                <hr style="border-color: var(--border-color);">
                                <div class="d-flex justify-content-between mb-2"><span class="text-muted">Subtotal</span><span class="fw-bold" id="order-subtotal">0.00</span></div>
                                <div class="d-flex justify-content-between mb-2"><span class="text-muted">VAT (20%)</span><span class="fw-bold" id="order-vat">0.00</span></div>
                                <div class="d-flex justify-content-between mb-3 fs-5 fw-bold"><span>Total</span><span style="color: var(--success-color);" id="order-total">0.00</span></div>
                                <button class="btn w-100 py-3 fw-bold mb-2 hover-lift" onclick="processOrder()" id="submit-order-btn" disabled style="background: var(--gradient-success); border: none; color: white; border-radius: 12px; font-size: 1.1rem;"><i class="fas fa-paper-plane me-2"></i> SUBMIT ORDER</button>
                                <button class="btn btn-outline-danger w-100 py-2 fw-bold hover-lift" onclick="clearOrder()"><i class="fas fa-trash me-2"></i> Clear Cart</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Restaurant History -->
            <div id="rest-history" class="page-section hidden">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="fw-bold">Order History & Weekly Spending</h2>
                    <div class="d-flex gap-2">
                        <span class="badge bg-primary p-2 px-3" id="total-weeks-badge">0 Weeks</span>
                        <span class="badge bg-success p-2 px-3" id="total-spent-badge">0.00 Total</span>
                    </div>
                </div>
                
                <div class="row mb-4" id="weekly-spending-cards"></div>

                <div class="card border-0 shadow-sm glass-card" style="border-radius: 16px;">
                    <div class="card-header bg-transparent py-3" style="border-bottom: 1px solid var(--border-color);">
                        <h5 class="mb-0 fw-bold">Individual Orders</h5>
                        <small class="text-muted">Click on any order to view invoice details</small>
                    </div>
                    <div class="card-body p-0"><div id="rest-orders-list"></div></div>
                </div>
            </div>
            
            <!-- Restaurant Stock View -->
            <div id="rest-stock" class="page-section hidden">
                <h2 class="mb-4 fw-bold">Current Stock Levels</h2>
                <div class="alert alert-warning mb-4" style="border-radius: 12px;"><i class="fas fa-exclamation-triangle me-2"></i><strong>Low Stock Alert:</strong> Items highlighted in red are running low and may not be available for ordering.</div>
                <div id="rest-stock-container"></div>
            </div>

            <!-- Restaurant Messages -->
            <div id="rest-messages" class="page-section hidden">
                <h2 class="mb-4 fw-bold">Messages</h2>
                
                <div class="card border-0 shadow-sm mb-4 glass-card" style="border-radius: 16px;">
                    <div class="card-body p-4">
                        <h5 class="mb-3 fw-bold" style="color: var(--primary-color);">Send Message to Admin</h5>
                        <div class="mb-3"><input type="text" id="msg-subject" class="form-control form-control-lg" placeholder="Subject"></div>
                        <div class="mb-3"><textarea id="msg-body" class="form-control form-control-lg" rows="4" placeholder="Message..." style="resize: none;"></textarea></div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="msg-urgent" style="width: 1.2rem; height: 1.2rem;">
                                <label class="form-check-label fw-bold ms-2" for="msg-urgent" style="color: var(--danger-color);"><i class="fas fa-exclamation-circle me-1"></i> Mark as urgent</label>
                            </div>
                            <button onclick="sendMessage()" class="btn btn-primary btn-lg fw-bold px-5 hover-lift" style="background: var(--gradient-primary); border: none;"><i class="fas fa-paper-plane me-2"></i> Send Message</button>
                        </div>
                    </div>
                </div>

                <div id="rest-messages-list"></div>
            </div>

        </div>
        
        <!-- Mobile Menu Toggle Button -->
        <button class="mobile-menu-toggle" id="mobile-menu-toggle" onclick="toggleMobileSidebar()">
            <i class="fas fa-bars"></i>
        </button>
        
        <!-- Mobile Bottom Navigation -->
        <nav class="mobile-bottom-nav" id="mobile-bottom-nav">
            <a href="javascript:void(0)" class="nav-item active" onclick="showMobilePage('admin-dashboard')">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </a>
            <a href="javascript:void(0)" class="nav-item" onclick="showMobilePage('admin-orders')">
                <i class="fas fa-truck"></i>
                <span>Orders</span>
            </a>
            <a href="javascript:void(0)" class="nav-item" onclick="showMobilePage('admin-stock')">
                <i class="fas fa-boxes"></i>
                <span>Stock</span>
            </a>
            <a href="javascript:void(0)" class="nav-item" onclick="showMobilePage('admin-menu-cost')">
                <i class="fas fa-calculator"></i>
                <span>Menu</span>
            </a>
            <a href="javascript:void(0)" class="nav-item" onclick="showMobilePage('admin-analytics')">
                <i class="fas fa-chart-pie"></i>
                <span>Analytics</span>
            </a>
        </nav>
    </div>

    <!-- Bulk Import Modal -->
    <div class="modal fade" id="bulkImportModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 glass-modal" style="border-radius: 20px;">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold" style="color: var(--primary-color);"><i class="fas fa-file-import me-2"></i>Bulk Import Products</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info mb-4" style="border-radius: 12px;">
                        <h6 class="fw-bold"><i class="fas fa-info-circle me-2"></i>CSV Format Requirements:</h6>
                        <p class="mb-2">Your CSV file should have the following columns:</p>
                        <code>name,category,unit,cost,minStock,stock,maxOrder</code>
                        <p class="mb-0 mt-2 small">Download the template below for the correct format.</p>
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label fw-semibold">Upload CSV File</label>
                        <div class="input-group input-group-lg">
                            <input type="file" class="form-control" id="csv-upload" accept=".csv" onchange="previewCSV()">
                            <button onclick="downloadCSVTemplate()" class="btn btn-outline-primary fw-bold" type="button">
                                <i class="fas fa-download me-2"></i>Template
                            </button>
                        </div>
                    </div>
                    
                    <div id="csv-preview-container" class="hidden">
                        <h6 class="fw-bold mb-3">Preview (<span id="csv-row-count">0</span> products)</h6>
                        <div class="table-responsive" style="max-height: 300px;">
                            <table class="table table-sm table-hover" id="csv-preview-table">
                                <thead class="table-light">
                                    <tr>
                                        <th>Name</th>
                                        <th>Category</th>
                                        <th>Unit</th>
                                        <th>Cost</th>
                                        <th>Min Stock</th>
                                        <th>Stock</th>
                                        <th>Max Order</th>
                                    </tr>
                                </thead>
                                <tbody id="csv-preview-body"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="csv-import-status" class="mt-3"></div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light btn-lg fw-bold" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success btn-lg fw-bold px-4 hover-lift" id="import-csv-btn" onclick="importCSV()" disabled>
                        <i class="fas fa-upload me-2"></i>Import Products
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Edit/Add Modal -->
    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 glass-modal" style="border-radius: 20px;">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold" id="productModalLabel" style="color: var(--primary-color);">Edit Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body pt-4">
                    <form id="productForm">
                        <input type="hidden" id="edit-product-id">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Product Name</label>
                            <input type="text" class="form-control form-control-lg" id="edit-name" required style="background: var(--bg-color); color: var(--text-dark); border-color: var(--border-color);">
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">Category</label>
                                <select class="form-select form-select-lg" id="edit-category" style="background: var(--bg-color); color: var(--text-dark); border-color: var(--border-color);">
                                    <option value="meat">Meat & Fish</option>
                                    <option value="produce">Produce</option>
                                    <option value="sauces">Sauces</option>
                                    <option value="prepared">Prepared</option>
                                    <option value="desserts">Desserts</option>
                                    <option value="dry">Dry Goods</option>
                                    <option value="nonfood">Non Food</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">Unit</label>
                                <input type="text" class="form-control form-control-lg" id="edit-unit" required style="background: var(--bg-color); color: var(--text-dark); border-color: var(--border-color);">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">Cost ()</label>
                                <input type="number" class="form-control form-control-lg" id="edit-cost" step="0.01" min="0" required style="background: var(--bg-color); color: var(--text-dark); border-color: var(--border-color);">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">Min Stock Level</label>
                                <input type="number" class="form-control form-control-lg" id="edit-min" min="0" required style="background: var(--bg-color); color: var(--text-dark); border-color: var(--border-color);">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">Current Stock</label>
                                <input type="number" class="form-control form-control-lg" id="edit-stock" min="0" required style="background: var(--bg-color); color: var(--text-dark); border-color: var(--border-color);">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">Max Order per Buyer (0 = unlimited)</label>
                                <input type="number" class="form-control form-control-lg" id="edit-max" min="0" placeholder="0" style="background: var(--bg-color); color: var(--text-dark); border-color: var(--border-color);">
                                <small class="text-muted">Maximum quantity a buyer can order at once</small>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-light btn-lg fw-bold" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger btn-lg fw-bold" id="delete-product-btn" onclick="deleteProduct()" style="display:none;">Delete</button>
                    <button type="button" class="btn btn-primary btn-lg fw-bold px-4 hover-lift" onclick="saveProduct()" style="background: var(--gradient-primary); border: none;">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Modal -->
    <div class="modal fade" id="invoiceModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 glass-modal" style="border-radius: 20px; overflow: hidden;">
                <div class="modal-body p-0" id="invoice-content"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    // ==================== APP STATE ====================
    let currentUser = null;
    let currentOrder = [];
    let inventory = [];
    let orders = [];
    let messages = [];
    let weeklyData = {};
    let meatData = {};
    let users = []; // Users synced via Supabase for cross-device login
    let buyersData = {};
    let recipes = [];
    let activityLog = [];
    let currentTaxWeek = 1;
    let currentAnalyticsWeek = 45;
    let autoSyncInterval = null;
    let supabaseClient = null;
    let supabaseConfig = null;
    let autoSyncEnabled = false;
    let startupSyncEnabled = false;
    let lastSyncTime = null;
    
    // Prep Sheets State
    let prepSheets = {};
    let prepTemplates = [];
    let currentPrepDate = new Date();
    let currentPrepView = 'daily';

    // AI Predictions State
    let aiPredictions = {};
    let aiAccuracy = 87;



    // Tax Year 2025/26 Week Definitions
    const TAX_YEAR_START = new Date('2025-04-06');
    const TAX_YEAR_END = new Date('2026-04-05');

    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', () => {
        loadAllData();
        currentTaxWeek = getTaxWeek(new Date());
        updateTaxWeekDisplay();
        initInventory();
        initRecipes();
        initPrepTemplates();

        renderStock();
        renderOrderItems();
        renderWeeklyTable();
        renderDeliveryTracker();
        updateDashboardStats();
        updateSyncStatus();
        initSparklines();
        
        // Load saved theme
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-bs-theme', savedTheme);
        updateThemeToggle(savedTheme);
        
        // Check for auto-login (Supabase session first, then localStorage)
        checkAutoLogin();
        
        // Initialize order week filter
        populateOrderWeekFilter();
        
        // Load Supabase config
        loadSupabaseConfig();
        
        // Setup auto-sync if enabled
        if (autoSyncEnabled) {
            startAutoSync();
        }

        // Start KDS clock
        setInterval(updateKDSClock, 1000);
    });

    // ==================== SPARKLINE CHARTS (WEEK 2) ====================
    function initSparklines() {
        // Generate sample trend data
        const alertsData = [5, 3, 4, 6, 4, 3, 5];
        const prepData = [12, 15, 18, 14, 20, 22, 19];
        const incomeData = [1200, 1350, 1280, 1420, 1500, 1380, 1450];
        const gpData = [68, 70, 69, 72, 71, 73, 74];

        createSparkline('sparkline-alerts', alertsData, '#ef4444');
        createSparkline('sparkline-prep', prepData, '#06b6d4');
        createSparkline('sparkline-income', incomeData, '#10b981');
        createSparkline('sparkline-gp', gpData, '#1e3a5f');
    }

    function createSparkline(canvasId, data, color) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        const width = canvas.width = canvas.offsetWidth;
        const height = canvas.height = canvas.offsetHeight;

        const max = Math.max(...data);
        const min = Math.min(...data);
        const range = max - min || 1;

        ctx.beginPath();
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';

        data.forEach((value, index) => {
            const x = (index / (data.length - 1)) * width;
            const y = height - ((value - min) / range) * (height - 10) - 5;

            if (index === 0) {
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
            }
        });

        ctx.stroke();

        // Add gradient fill
        ctx.lineTo(width, height);
        ctx.lineTo(0, height);
        ctx.closePath();

        const gradient = ctx.createLinearGradient(0, 0, 0, height);
        gradient.addColorStop(0, color + '40');
        gradient.addColorStop(1, color + '00');
        ctx.fillStyle = gradient;
        ctx.fill();
    }

    // ==================== KDS FULL-SCREEN MODE (WEEK 3) ====================
    function enterKDSMode() {
        const kdsContainer = document.getElementById('kds-fullscreen');
        kdsContainer.classList.add('active');
        renderKDSContent();
        logActivity('prep', 'Entered KDS full-screen mode');
    }

    function exitKDSMode() {
        const kdsContainer = document.getElementById('kds-fullscreen');
        kdsContainer.classList.remove('active');
    }

    function updateKDSClock() {
        const clock = document.getElementById('kds-clock');
        if (clock) {
            const now = new Date();
            clock.textContent = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }
    }

    function renderKDSContent() {
        const todayKey = getPrepDateKey(new Date());
        const todaySheet = prepSheets[todayKey] || { items: [] };

        const pending = todaySheet.items.filter(i => i.status === 'planned');
        const inProgress = todaySheet.items.filter(i => i.status === 'in-progress');
        const completed = todaySheet.items.filter(i => i.status === 'completed');

        renderKDSColumn('kds-pending-items', pending, 'pending');
        renderKDSColumn('kds-progress-items', inProgress, 'in-progress');
        renderKDSColumn('kds-completed-items', completed, 'completed');
    }

    function renderKDSColumn(containerId, items, status) {
        const container = document.getElementById(containerId);
        if (!container) return;

        if (items.length === 0) {
            container.innerHTML = '<div class="text-center text-muted py-5"><i class="fas fa-inbox fa-2x mb-2 opacity-50"></i><p>No items</p></div>';
            return;
        }

        container.innerHTML = items.map(item => {
            const product = inventory.find(p => p.id === item.productId);
            if (!product) return '';

            return `
                <div class="kds-card ${status}" onclick="updateKDSItemStatus('${item.id}')">
                    <div class="kds-card-title">${product.name}</div>
                    <div class="kds-card-details">
                        <span class="badge bg-primary">${item.quantity} ${product.unit}</span>
                        ${item.batchCode ? `<span class="prep-batch-badge ms-2"><i class="fas fa-barcode"></i>${item.batchCode}</span>` : ''}
                    </div>
                    <div class="kds-card-time">
                        <i class="fas fa-clock me-1"></i>${item.createdAt ? new Date(item.createdAt).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }) : 'Just now'}
                    </div>
                </div>
            `;
        }).join('');
    }

    function updateKDSItemStatus(itemId) {
        const todayKey = getPrepDateKey(new Date());
        const todaySheet = prepSheets[todayKey];
        if (!todaySheet) return;

        const item = todaySheet.items.find(i => i.id === itemId);
        if (!item) return;

        // Cycle through statuses
        if (item.status === 'planned') {
            startPrepItem(itemId);
        } else if (item.status === 'in-progress') {
            completePrepItem(itemId);
        }

        renderKDSContent();
        renderPrepDailyView();
    }

    // ==================== AI PREP PREDICTIONS (MONTH 2) ====================
    function openAIPredictionModal() {
        generateAIPredictions();
        const modal = new bootstrap.Modal(document.getElementById('aiPredictionModal'));
        modal.show();
    }

    function generateAIPredictions() {
        const predictionsList = document.getElementById('ai-predictions-list');
        const predictionsDetail = document.getElementById('ai-predictions-detail');

        // Analyze historical data to generate predictions
        const predictions = [];
        
        inventory.forEach(product => {
            // Simulate AI analysis based on order history
            const productOrders = orders.filter(o => 
                o.items.some(i => i.id === product.id) && 
                o.status === 'completed'
            );

            if (productOrders.length > 0) {
                const avgQuantity = productOrders.reduce((sum, o) => {
                    const item = o.items.find(i => i.id === product.id);
                    return sum + (item ? item.qty : 0);
                }, 0) / productOrders.length;

                const dayOfWeek = new Date().getDay();
                const weekendMultiplier = (dayOfWeek === 0 || dayOfWeek === 6) ? 1.5 : 1;
                const predictedQuantity = Math.ceil(avgQuantity * weekendMultiplier);

                if (predictedQuantity > 0) {
                    predictions.push({
                        product,
                        predictedQuantity,
                        confidence: Math.min(95, 70 + Math.random() * 25),
                        factors: [
                            `Based on ${productOrders.length} historical orders`,
                            weekendMultiplier > 1 ? 'Weekend demand pattern detected' : 'Weekday standard pattern',
                            `Current stock: ${product.stock} ${product.unit}`
                        ]
                    });
                }
            }
        });

        // Sort by confidence
        predictions.sort((a, b) => b.confidence - a.confidence);

        // Render in modal
        if (predictionsList) {
            predictionsList.innerHTML = predictions.slice(0, 5).map(p => `
                <div class="prediction-item mb-3 p-3 rounded-3" style="background: rgba(255,255,255,0.5);">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="fw-bold">${p.product.name}</div>
                        <span class="badge bg-primary">${p.predictedQuantity} ${p.product.unit}</span>
                    </div>
                    <div class="ai-confidence">
                        <small class="text-muted">Confidence:</small>
                        <div class="confidence-bar">
                            <div class="confidence-fill" style="width: ${p.confidence}%;"></div>
                        </div>
                        <small class="fw-bold">${p.confidence.toFixed(0)}%</small>
                    </div>
                    <div class="mt-2">
                        ${p.factors.map(f => `<div class="prediction-factor"><i class="fas fa-check-circle text-success"></i>${f}</div>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        // Render in detail page
        if (predictionsDetail) {
            predictionsDetail.innerHTML = predictions.map(p => `
                <div class="prediction-item mb-3 p-3 rounded-3" style="background: rgba(255,255,255,0.5);">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-bold">${p.product.name}</div>
                            <small class="text-muted">${p.product.category}</small>
                        </div>
                        <div class="text-end">
                            <div class="fw-bold" style="color: var(--ai-color);">${p.predictedQuantity} ${p.product.unit}</div>
                            <small class="text-muted">${p.confidence.toFixed(0)}% confidence</small>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        aiPredictions = predictions;
    }

    function applyAIPredictions() {
        const todayKey = getPrepDateKey(new Date());
        const todaySheet = getPrepSheet(new Date());
        let appliedCount = 0;

        aiPredictions.forEach(prediction => {
            // Check if already exists
            const exists = todaySheet.items.some(i => i.productId === prediction.product.id);
            if (!exists) {
                const newItem = {
                    id: 'prep-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                    productId: prediction.product.id,
                    quantity: prediction.predictedQuantity,
                    batchCode: '',
                    notes: 'AI Generated Prediction',
                    status: 'planned',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                todaySheet.items.push(newItem);
                appliedCount++;
            }
        });

        prepSheets[todayKey] = todaySheet;
        saveAllData();

        bootstrap.Modal.getInstance(document.getElementById('aiPredictionModal')).hide();
        renderPrepDailyView();
        updatePrepStats();
        updateDashboardPrepSummary();
        showToast(`Applied ${appliedCount} AI predictions!`, 'ai');
        logActivity('ai', `Applied ${appliedCount} AI prep predictions`);
    }

    // ==================== AR STOCK SCANNING (MONTH 2) ====================
    let arScanner = null;

    function openARScanner() {
        document.getElementById('ar-scanner').classList.add('active');
        
        setTimeout(() => {
            arScanner = new Html5Qrcode('ar-qr-reader');
            arScanner.start(
                { facingMode: 'environment' },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                onARScanSuccess,
                onARScanFailure
            );
        }, 500);
    }

    function closeARScanner() {
        document.getElementById('ar-scanner').classList.remove('active');
        if (arScanner) {
            arScanner.stop().then(() => {
                arScanner = null;
            }).catch(() => {});
        }
    }

    function onARScanSuccess(decodedText) {
        const product = inventory.find(p => p.id === decodedText);
        const statusEl = document.getElementById('ar-scan-status');
        
        if (product) {
            statusEl.innerHTML = `
                <div class="fw-bold">${product.name}</div>
                <div>Stock: ${product.stock} ${product.unit} | ${product.cost.toFixed(2)}</div>
            `;
            
            // Visual feedback
            setTimeout(() => {
                closeARScanner();
                openEditProductModal(product.id);
            }, 1500);
        } else {
            statusEl.innerHTML = '<span class="text-warning">Product not found</span>';
        }
    }

    function onARScanFailure(error) {}




    // ==================== DATA PERSISTENCE ====================
    function saveAllData() {
        localStorage.setItem('inventory', JSON.stringify(inventory));
        localStorage.setItem('orders', JSON.stringify(orders));
        localStorage.setItem('messages', JSON.stringify(messages));
        localStorage.setItem('weeklyData', JSON.stringify(weeklyData));
        localStorage.setItem('meatData', JSON.stringify(meatData));
        localStorage.setItem('buyersData', JSON.stringify(buyersData));
        localStorage.setItem('recipes', JSON.stringify(recipes));
        localStorage.setItem('activityLog', JSON.stringify(activityLog));
        localStorage.setItem('prepSheets', JSON.stringify(prepSheets));
        localStorage.setItem('prepTemplates', JSON.stringify(prepTemplates));
        localStorage.setItem('supabaseConfig', JSON.stringify(supabaseConfig));
        localStorage.setItem('autoSyncEnabled', autoSyncEnabled);
        localStorage.setItem('startupSyncEnabled', startupSyncEnabled);
        localStorage.setItem('lastSyncTime', lastSyncTime);
        localStorage.setItem('users', JSON.stringify(users));
    }

    function loadAllData() {
        inventory = JSON.parse(localStorage.getItem('inventory')) || [];
        orders = JSON.parse(localStorage.getItem('orders')) || [];
        messages = JSON.parse(localStorage.getItem('messages')) || [];
        weeklyData = JSON.parse(localStorage.getItem('weeklyData')) || {};
        meatData = JSON.parse(localStorage.getItem('meatData')) || {};
        buyersData = JSON.parse(localStorage.getItem('buyersData')) || {};
        recipes = JSON.parse(localStorage.getItem('recipes')) || [];
        activityLog = JSON.parse(localStorage.getItem('activityLog')) || [];
        prepSheets = JSON.parse(localStorage.getItem('prepSheets')) || {};
        prepTemplates = JSON.parse(localStorage.getItem('prepTemplates')) || [];
        supabaseConfig = JSON.parse(localStorage.getItem('supabaseConfig')) || null;
        if (supabaseConfig) initSupabase();
        autoSyncEnabled = localStorage.getItem('autoSyncEnabled') === 'true';
        startupSyncEnabled = localStorage.getItem('startupSyncEnabled') === 'true';
        lastSyncTime = localStorage.getItem('lastSyncTime') || null;
        users = JSON.parse(localStorage.getItem('users')) || [];
    }

    // ==================== PREP SHEETS FEATURE ====================
    
    // Initialize default prep templates
    function initPrepTemplates() {
        if (prepTemplates.length === 0) {
            prepTemplates = [
                {
                    id: 'template-weekday',
                    name: 'Weekday Standard',
                    description: 'Standard weekday prep items',
                    items: [
                        { productId: 'prod-001', quantity: 10, notes: 'Morning prep' },
                        { productId: 'prod-002', quantity: 5, notes: 'Afternoon prep' }
                    ]
                },
                {
                    id: 'template-weekend',
                    name: 'Weekend Heavy',
                    description: 'Higher volume for weekend rush',
                    items: [
                        { productId: 'prod-001', quantity: 20, notes: 'Weekend rush' },
                        { productId: 'prod-002', quantity: 15, notes: 'Extra stock' }
                    ]
                },
                {
                    id: 'template-special',
                    name: 'Special Event',
                    description: 'Extra prep for special occasions',
                    items: [
                        { productId: 'prod-003', quantity: 25, notes: 'Event prep' }
                    ]
                }
            ];
            saveAllData();
        }
    }

    // Get date key for prep sheets
    function getPrepDateKey(date) {
        return date.toISOString().split('T')[0];
    }

    // Get prep sheet for a specific date
    function getPrepSheet(date) {
        const dateKey = getPrepDateKey(date);
        if (!prepSheets[dateKey]) {
            prepSheets[dateKey] = {
                date: dateKey,
                items: [],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
        }
        return prepSheets[dateKey];
    }

    // Switch between daily and weekly prep views
    function switchPrepView(view) {
        currentPrepView = view;
        document.getElementById('view-daily-btn').classList.toggle('active', view === 'daily');
        document.getElementById('view-weekly-btn').classList.toggle('active', view === 'weekly');
        document.getElementById('prep-daily-view').classList.toggle('hidden', view !== 'daily');
        document.getElementById('prep-weekly-view').classList.toggle('hidden', view !== 'weekly');
        
        if (view === 'daily') {
            renderPrepDailyView();
        } else {
            renderPrepWeeklyView();
        }
    }

    // Navigate to previous prep day
    function previousPrepDay() {
        currentPrepDate.setDate(currentPrepDate.getDate() - 1);
        updatePrepDateDisplay();
        renderPrepDailyView();
    }

    // Navigate to next prep day
    function nextPrepDay() {
        currentPrepDate.setDate(currentPrepDate.getDate() + 1);
        updatePrepDateDisplay();
        renderPrepDailyView();
    }

    // Update prep date display
    function updatePrepDateDisplay() {
        const today = new Date();
        const isToday = currentPrepDate.toDateString() === today.toDateString();
        const dateStr = isToday ? 'Today' : currentPrepDate.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' });
        document.getElementById('prep-current-date').textContent = dateStr;
        document.getElementById('prep-daily-title').textContent = isToday ? "Today's Prep Sheet" : `Prep Sheet - ${currentPrepDate.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long' })}`;
    }

    // Render daily prep view
    function renderPrepDailyView() {
        const sheet = getPrepSheet(currentPrepDate);
        const container = document.getElementById('prep-items-container');
        
        if (sheet.items.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-5">
                    <i class="fas fa-utensils fa-3x mb-3 opacity-25"></i>
                    <p>No prep items scheduled for this day</p>
                    <button onclick="openPrepItemModal()" class="btn btn-primary fw-bold hover-lift" style="background: var(--prep-gradient); border: none;">
                        <i class="fas fa-plus me-2"></i>Add First Prep Item
                    </button>
                </div>
            `;
            return;
        }

        let html = '<div class="table-responsive"><table class="table table-hover align-middle mb-0">';
        html += '<thead class="table-light"><tr><th>Product</th><th>Qty</th><th>Batch</th><th>Notes</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
        
        sheet.items.forEach((item, index) => {
            const product = inventory.find(p => p.id === item.productId);
            if (!product) return;
            
            const statusClass = item.status === 'completed' ? 'completed' : item.status === 'in-progress' ? 'in-progress' : '';
            const statusBadge = item.status === 'completed' ? '<span class="status-pill status-prep-completed"><i class="fas fa-check me-1"></i>Completed</span>' : 
                               item.status === 'in-progress' ? '<span class="status-pill status-prep-progress"><i class="fas fa-spinner fa-spin me-1"></i>In Progress</span>' :
                               '<span class="status-pill status-prep-planned"><i class="fas fa-clock me-1"></i>Planned</span>';
            
            html += `
                <tr class="prep-item-row ${statusClass}">
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="bg-light rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                <i class="fas fa-utensils text-muted"></i>
                            </div>
                            <div>
                                <div class="fw-bold">${product.name}</div>
                                <small class="text-muted">${product.category} | ${product.cost.toFixed(2)}</small>
                            </div>
                        </div>
                    </td>
                    <td><span class="badge bg-primary">${item.quantity} ${product.unit}</span></td>
                    <td>${item.batchCode ? `<span class="prep-batch-badge"><i class="fas fa-barcode"></i>${item.batchCode}</span>` : '-'}</td>
                    <td><small class="text-muted">${item.notes || '-'}</small></td>
                    <td>${statusBadge}</td>
                    <td>
                        <div class="btn-group">
                            ${item.status !== 'completed' ? `<button onclick="startPrepItem('${item.id}')" class="btn btn-sm btn-outline-warning" title="Start Prep"><i class="fas fa-play"></i></button>` : ''}
                            ${item.status !== 'completed' ? `<button onclick="completePrepItem('${item.id}')" class="btn btn-sm btn-outline-success" title="Complete"><i class="fas fa-check"></i></button>` : ''}
                            <button onclick="editPrepItem('${item.id}')" class="btn btn-sm btn-outline-primary" title="Edit"><i class="fas fa-edit"></i></button>
                            <button onclick="deletePrepItem('${item.id}')" class="btn btn-sm btn-outline-danger" title="Delete"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        html += '</tbody></table></div>';
        container.innerHTML = html;
        
        updatePrepStats();
    }

    // Render weekly prep view
    function renderPrepWeeklyView() {
        const grid = document.getElementById('prep-week-grid');
        const today = new Date();
        const startOfWeek = new Date(currentPrepDate);
        startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
        
        let html = '';
        const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        
        for (let i = 0; i < 7; i++) {
            const date = new Date(startOfWeek);
            date.setDate(date.getDate() + i);
            const dateKey = getPrepDateKey(date);
            const sheet = prepSheets[dateKey] || { items: [] };
            const isToday = date.toDateString() === today.toDateString();
            const hasPrep = sheet.items.length > 0;
            const completedCount = sheet.items.filter(item => item.status === 'completed').length;
            const totalCount = sheet.items.length;
            const progress = totalCount > 0 ? (completedCount / totalCount * 100) : 0;
            
            html += `
                <div class="day-column ${isToday ? 'today' : ''}" onclick="selectPrepDay('${dateKey}')">
                    <div class="day-header">
                        <div class="fw-bold">${days[i]}</div>
                        <small class="${isToday ? '' : 'text-muted'}">${date.getDate()}</small>
                    </div>
                    <div class="p-2">
                        ${hasPrep ? `
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="fw-bold">${totalCount} items</small>
                                <small class="text-success">${completedCount} done</small>
                            </div>
                            <div class="prep-progress-bar mb-2">
                                <div class="prep-progress-fill ${progress === 100 ? 'completed' : ''}" style="width: ${progress}%"></div>
                            </div>
                            ${sheet.items.slice(0, 3).map(item => {
                                const product = inventory.find(p => p.id === item.productId);
                                return product ? `
                                    <div class="prep-item-pill ${item.status === 'completed' ? 'completed' : ''}">
                                        <span class="small">${product.name}</span>
                                        <span class="qty-badge">${item.quantity}</span>
                                    </div>
                                ` : '';
                            }).join('')}
                            ${sheet.items.length > 3 ? `<small class="text-muted d-block text-center">+${sheet.items.length - 3} more</small>` : ''}
                        ` : `
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-plus-circle mb-2 opacity-50"></i>
                                <small class="d-block">Click to add</small>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }
        
        grid.innerHTML = html;
    }

    // Select a day from weekly view
    function selectPrepDay(dateKey) {
        currentPrepDate = new Date(dateKey);
        switchPrepView('daily');
        updatePrepDateDisplay();
    }

    // Open prep item modal
    function openPrepItemModal(itemId = null) {
        const modal = new bootstrap.Modal(document.getElementById('prepItemModal'));
        const select = document.getElementById('prep-product-select');
        
        // Populate product select
        select.innerHTML = '<option value="" selected disabled>Select a product...</option>';
        inventory.forEach(product => {
            select.innerHTML += `<option value="${product.id}">${product.name} (${product.unit}) - Stock: ${product.stock}</option>`;
        });
        
        if (itemId) {
            const sheet = getPrepSheet(currentPrepDate);
            const item = sheet.items.find(i => i.id === itemId);
            if (item) {
                document.getElementById('prep-item-id').value = itemId;
                document.getElementById('prep-product-select').value = item.productId;
                document.getElementById('prep-quantity').value = item.quantity;
                document.getElementById('prep-batch-code').value = item.batchCode || '';
                document.getElementById('prep-notes').value = item.notes || '';
                document.getElementById('prepItemModalLabel').innerHTML = '<i class="fas fa-edit me-2"></i>Edit Prep Item';
            }
        } else {
            document.getElementById('prep-item-id').value = '';
            document.getElementById('prep-product-select').value = '';
            document.getElementById('prep-quantity').value = 1;
            document.getElementById('prep-batch-code').value = '';
            document.getElementById('prep-notes').value = '';
            document.getElementById('prepItemModalLabel').innerHTML = '<i class="fas fa-utensils me-2"></i>Add Prep Item';
        }
        
        document.getElementById('prep-sheet-date').value = getPrepDateKey(currentPrepDate);
        modal.show();
    }

    // Update prep item details when product changes
    function updatePrepItemDetails() {
        const productId = document.getElementById('prep-product-select').value;
        const product = inventory.find(p => p.id === productId);
        if (product) {
            document.getElementById('prep-unit-display').textContent = product.unit;
        }
    }

    // Save prep item
    function savePrepItem() {
        const itemId = document.getElementById('prep-item-id').value;
        const productId = document.getElementById('prep-product-select').value;
        const quantity = parseInt(document.getElementById('prep-quantity').value);
        const batchCode = document.getElementById('prep-batch-code').value.trim();
        const notes = document.getElementById('prep-notes').value.trim();
        const dateKey = document.getElementById('prep-sheet-date').value;
        
        if (!productId) {
            showToast('Please select a product', 'error');
            return;
        }
        
        if (!quantity || quantity < 1) {
            showToast('Please enter a valid quantity', 'error');
            return;
        }
        
        const product = inventory.find(p => p.id === productId);
        if (!product) {
            showToast('Product not found', 'error');
            return;
        }
        
        const sheet = prepSheets[dateKey] || getPrepSheet(new Date(dateKey));
        
        if (itemId) {
            // Update existing item
            const itemIndex = sheet.items.findIndex(i => i.id === itemId);
            if (itemIndex > -1) {
                sheet.items[itemIndex] = {
                    ...sheet.items[itemIndex],
                    productId,
                    quantity,
                    batchCode,
                    notes,
                    updatedAt: new Date().toISOString()
                };
                logActivity('prep', `Updated prep item: ${product.name} x${quantity}`);
                showToast('Prep item updated successfully', 'success');
            }
        } else {
            // Add new item
            const newItem = {
                id: 'prep-' + Date.now(),
                productId,
                quantity,
                batchCode,
                notes,
                status: 'planned',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            sheet.items.push(newItem);
            logActivity('prep', `Added prep item: ${product.name} x${quantity}`);
            showToast('Prep item added successfully', 'success');
        }
        
        sheet.updatedAt = new Date().toISOString();
        prepSheets[dateKey] = sheet;
        saveAllData();
        
        bootstrap.Modal.getInstance(document.getElementById('prepItemModal')).hide();
        renderPrepDailyView();
        updatePrepStats();
        updateDashboardPrepSummary();
    }

    // Start prep item (mark as in-progress)
    function startPrepItem(itemId) {
        const sheet = getPrepSheet(currentPrepDate);
        const item = sheet.items.find(i => i.id === itemId);
        if (item) {
            item.status = 'in-progress';
            item.startedAt = new Date().toISOString();
            sheet.updatedAt = new Date().toISOString();
            saveAllData();
            renderPrepDailyView();
            updatePrepStats();
            
            const product = inventory.find(p => p.id === item.productId);
            showToast(`Started prepping: ${product?.name || 'Item'}`, 'info');
        }
    }

    // Complete prep item - DEDUCTS STOCK AUTOMATICALLY
    function completePrepItem(itemId) {
        const sheet = getPrepSheet(currentPrepDate);
        const item = sheet.items.find(i => i.id === itemId);
        if (!item) return;
        
        const product = inventory.find(p => p.id === item.productId);
        if (!product) {
            showToast('Product not found in inventory', 'error');
            return;
        }
        
        // Check if enough stock
        if (product.stock < item.quantity) {
            showToast(`Insufficient stock! Only ${product.stock} ${product.unit} available.`, 'error');
            return;
        }
        
        // Deduct stock
        const oldStock = product.stock;
        product.stock -= item.quantity;
        
        // Update prep item status
        item.status = 'completed';
        item.completedAt = new Date().toISOString();
        sheet.updatedAt = new Date().toISOString();
        
        saveAllData();
        renderPrepDailyView();
        renderStock();
        updatePrepStats();
        updateDashboardPrepSummary();
        updateDashboardStockAlerts();
        
        const stockValue = (item.quantity * product.cost).toFixed(2);
        showToast(`Prep completed! Deducted ${item.quantity} ${product.unit} from stock (Value: ${stockValue})`, 'prep');
        logActivity('prep', `Completed prep: ${product.name} x${item.quantity} - Stock: ${oldStock} -> ${product.stock}`);
    }

    // Edit prep item
    function editPrepItem(itemId) {
        openPrepItemModal(itemId);
    }

    // Delete prep item
    function deletePrepItem(itemId) {
        if (!confirm('Are you sure you want to delete this prep item?')) return;
        
        const sheet = getPrepSheet(currentPrepDate);
        const itemIndex = sheet.items.findIndex(i => i.id === itemId);
        if (itemIndex > -1) {
            const item = sheet.items[itemIndex];
            const product = inventory.find(p => p.id === item.productId);
            sheet.items.splice(itemIndex, 1);
            sheet.updatedAt = new Date().toISOString();
            saveAllData();
            renderPrepDailyView();
            updatePrepStats();
            updateDashboardPrepSummary();
            showToast('Prep item deleted', 'success');
            logActivity('prep', `Deleted prep item: ${product?.name || 'Unknown'}`);
        }
    }

    // Mark all prep items as completed
    function markAllPrepCompleted() {
        const sheet = getPrepSheet(currentPrepDate);
        if (sheet.items.length === 0) {
            showToast('No prep items to complete', 'warning');
            return;
        }
        
        const incompleteItems = sheet.items.filter(item => item.status !== 'completed');
        if (incompleteItems.length === 0) {
            showToast('All items are already completed', 'info');
            return;
        }
        
        if (!confirm(`Mark all ${incompleteItems.length} items as completed? This will deduct stock for each item.`)) return;
        
        let completedCount = 0;
        let insufficientStock = [];
        
        incompleteItems.forEach(item => {
            const product = inventory.find(p => p.id === item.productId);
            if (!product) return;
            
            if (product.stock < item.quantity) {
                insufficientStock.push(`${product.name} (need ${item.quantity}, have ${product.stock})`);
                return;
            }
            
            product.stock -= item.quantity;
            item.status = 'completed';
            item.completedAt = new Date().toISOString();
            completedCount++;
        });
        
        sheet.updatedAt = new Date().toISOString();
        saveAllData();
        renderPrepDailyView();
        renderStock();
        updatePrepStats();
        updateDashboardPrepSummary();
        updateDashboardStockAlerts();
        
        if (insufficientStock.length > 0) {
            showToast(`Completed ${completedCount} items. Insufficient stock for: ${insufficientStock.join(', ')}`, 'warning');
        } else {
            showToast(`All ${completedCount} items completed successfully!`, 'success');
        }
        
        logActivity('prep', `Batch completed ${completedCount} prep items`);
    }

    // Clear completed prep items
    function clearCompletedPrep() {
        const sheet = getPrepSheet(currentPrepDate);
        const completedCount = sheet.items.filter(item => item.status === 'completed').length;
        
        if (completedCount === 0) {
            showToast('No completed items to clear', 'info');
            return;
        }
        
        if (!confirm(`Remove ${completedCount} completed items from the list?`)) return;
        
        sheet.items = sheet.items.filter(item => item.status !== 'completed');
        sheet.updatedAt = new Date().toISOString();
        saveAllData();
        renderPrepDailyView();
        updatePrepStats();
        updateDashboardPrepSummary();
        showToast('Completed items cleared', 'success');
    }

    // Update prep statistics
    function updatePrepStats() {
        const today = new Date();
        const todayKey = getPrepDateKey(today);
        const todaySheet = prepSheets[todayKey] || { items: [] };
        
        const totalItems = todaySheet.items.length;
        const inProgress = todaySheet.items.filter(i => i.status === 'in-progress').length;
        const completed = todaySheet.items.filter(i => i.status === 'completed').length;
        
        // Calculate stock impact
        let stockImpact = 0;
        todaySheet.items.filter(i => i.status === 'completed').forEach(item => {
            const product = inventory.find(p => p.id === item.productId);
            if (product) {
                stockImpact += item.quantity * product.cost;
            }
        });
        
        document.getElementById('prep-today-count').textContent = totalItems;
        document.getElementById('prep-progress-count').textContent = inProgress;
        document.getElementById('prep-completed-count').textContent = completed;
        document.getElementById('prep-stock-impact').textContent = '' + stockImpact.toFixed(2);
        
        // Update badge
        const pendingCount = totalItems - completed;
        const badge = document.getElementById('prep-badge');
        if (pendingCount > 0) {
            badge.textContent = pendingCount;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    }

    // Open prep template modal
    function openPrepTemplateModal() {
        const modal = new bootstrap.Modal(document.getElementById('prepTemplateModal'));
        renderPrepTemplates();
        modal.show();
    }

    // Render prep templates
    function renderPrepTemplates() {
        const container = document.getElementById('prep-templates-list');
        
        if (prepTemplates.length === 0) {
            container.innerHTML = '<div class="col-12 text-center text-muted py-3">No templates created yet</div>';
            return;
        }
        
        container.innerHTML = prepTemplates.map(template => `
            <div class="col-md-4">
                <div class="prep-template-card hover-lift" onclick="applyPrepTemplate('${template.id}')">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="fw-bold mb-0">${template.name}</h6>
                        <button onclick="event.stopPropagation(); deletePrepTemplate('${template.id}')" class="btn btn-sm btn-link text-danger p-0">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <small class="text-muted d-block mb-2">${template.description}</small>
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-info">${template.items.length} items</span>
                        <small class="text-muted">Click to apply</small>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // Apply prep template to current day
    function applyPrepTemplate(templateId) {
        const template = prepTemplates.find(t => t.id === templateId);
        if (!template) return;
        
        const sheet = getPrepSheet(currentPrepDate);
        let addedCount = 0;
        
        template.items.forEach(templateItem => {
            const product = inventory.find(p => p.id === templateItem.productId);
            if (product) {
                const newItem = {
                    id: 'prep-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                    productId: templateItem.productId,
                    quantity: templateItem.quantity,
                    batchCode: '',
                    notes: templateItem.notes || '',
                    status: 'planned',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                sheet.items.push(newItem);
                addedCount++;
            }
        });
        
        sheet.updatedAt = new Date().toISOString();
        saveAllData();
        
        bootstrap.Modal.getInstance(document.getElementById('prepTemplateModal')).hide();
        renderPrepDailyView();
        updatePrepStats();
        updateDashboardPrepSummary();
        showToast(`Applied template: ${template.name} (${addedCount} items added)`, 'success');
        logActivity('prep', `Applied template "${template.name}" with ${addedCount} items`);
    }

    // Create prep template from current day's items
    function createPrepTemplateFromCurrent() {
        const name = document.getElementById('new-template-name').value.trim();
        if (!name) {
            showToast('Please enter a template name', 'error');
            return;
        }
        
        const sheet = getPrepSheet(currentPrepDate);
        if (sheet.items.length === 0) {
            showToast('No items to create template from', 'error');
            return;
        }
        
        const newTemplate = {
            id: 'template-' + Date.now(),
            name: name,
            description: `Created from ${currentPrepDate.toLocaleDateString('en-GB')}`,
            items: sheet.items.map(item => ({
                productId: item.productId,
                quantity: item.quantity,
                notes: item.notes
            }))
        };
        
        prepTemplates.push(newTemplate);
        saveAllData();
        
        document.getElementById('new-template-name').value = '';
        renderPrepTemplates();
        showToast('Template created successfully!', 'success');
    }

    // Delete prep template
    function deletePrepTemplate(templateId) {
        if (!confirm('Delete this template?')) return;
        
        prepTemplates = prepTemplates.filter(t => t.id !== templateId);
        saveAllData();
        renderPrepTemplates();
        showToast('Template deleted', 'success');
    }

    // Update dashboard prep summary
    function updateDashboardPrepSummary() {
        const today = new Date();
        const todayKey = getPrepDateKey(today);
        const todaySheet = prepSheets[todayKey] || { items: [] };
        
        const totalItems = todaySheet.items.length;
        const completed = todaySheet.items.filter(i => i.status === 'completed').length;
        const completionPercent = totalItems > 0 ? Math.round((completed / totalItems) * 100) : 0;
        
        document.getElementById('dash-prep-count').textContent = totalItems;
        document.getElementById('prep-completion-summary').textContent = `${completionPercent}% completed (${completed}/${totalItems})`;
        
        // Update details
        const detailsContainer = document.getElementById('prep-summary-details');
        if (totalItems === 0) {
            detailsContainer.innerHTML = '<small class="text-muted">No prep items today</small>';
        } else {
            const inProgress = todaySheet.items.filter(i => i.status === 'in-progress').length;
            const planned = todaySheet.items.filter(i => i.status === 'planned').length;
            detailsContainer.innerHTML = `
                <div class="d-flex gap-2">
                    ${planned > 0 ? `<span class="badge bg-info">${planned} planned</span>` : ''}
                    ${inProgress > 0 ? `<span class="badge bg-warning">${inProgress} in progress</span>` : ''}
                    ${completed > 0 ? `<span class="badge bg-success">${completed} done</span>` : ''}
                </div>
            `;
        }
    }

    // ==================== TAX WEEK FUNCTIONS ====================
    function getTaxWeek(date) {
        const diffTime = date.getTime() - TAX_YEAR_START.getTime();
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        return Math.floor(diffDays / 7) + 1;
    }

    function getTaxWeekDateRange(weekNum) {
        const startDate = new Date(TAX_YEAR_START);
        startDate.setDate(startDate.getDate() + (weekNum - 1) * 7);
        const endDate = new Date(startDate);
        endDate.setDate(endDate.getDate() + 6);
        return { start: startDate, end: endDate };
    }

    function formatDateRange(weekNum) {
        const range = getTaxWeekDateRange(weekNum);
        return `${range.start.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })} - ${range.end.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })}`;
    }

    function updateTaxWeekDisplay() {
        const fixedDateRange = '8 Feb - 14 Feb 2026';
        const fixedWeek = 'Week 45';
        
        document.getElementById('sidebar-tax-week').textContent = `Week ${currentTaxWeek}`;
        document.getElementById('dashboard-date-range').textContent = fixedDateRange;
        document.getElementById('rest-tax-week').textContent = `Week ${currentTaxWeek}`;
        document.getElementById('analytics-week-display').textContent = fixedWeek;
        document.getElementById('entry-week-num').textContent = '45';
        document.getElementById('meat-week-display').textContent = '45';
        document.getElementById('buyers-week-display').textContent = '45';
        document.getElementById('analytics-date-range').textContent = fixedDateRange;
        document.getElementById('meat-period-display').textContent = fixedDateRange;
    }

    // ==================== AUTHENTICATION ====================
    // Users are synced via Supabase for cross-device login
    
    function checkAutoLogin() {
        const savedUser = localStorage.getItem('currentUser');
        if (savedUser) {
            const user = JSON.parse(savedUser);
            if (user.expires && new Date(user.expires) > new Date()) {
                currentUser = user;
                showApp();
                logActivity('login', `Auto-login: ${user.name}`);
            } else {
                localStorage.removeItem('currentUser');
            }
        }
    }
    
    function switchAuthTab(tab) {
        document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        
        document.getElementById('loginForm').classList.add('hidden');
        document.getElementById('signupForm').classList.add('hidden');
        document.getElementById('forgotForm').classList.add('hidden');
        document.getElementById('verification-alert').style.display = 'none';
        
        document.getElementById(tab + 'Form').classList.remove('hidden');
    }

    function selectRole(role) {
        document.querySelectorAll('.role-card').forEach(c => c.classList.remove('selected'));
        document.getElementById('role-' + role).classList.add('selected');
        document.getElementById('selected-role').value = role;
        
        const unitSelection = document.getElementById('unit-selection');
        if (role === 'buyer') {
            unitSelection.classList.remove('hidden');
            document.getElementById('signup-unit').required = true;
        } else {
            unitSelection.classList.add('hidden');
            document.getElementById('signup-unit').required = false;
        }
    }

    function handleLogin(e) {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        
        // Use global users array (synced via Supabase)
        const user = users.find(u => u.email === email && u.password === password);
        
        if (user) {
            currentUser = { ...user, expires: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString() };
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            showApp();
            logActivity('login', `User logged in: ${user.name} (${user.role})`);
            showToast('Welcome back, ' + user.name + '!', 'success');
        } else if (email === 'admin@cc.com' && password === 'admin123') {
            currentUser = { 
                name: 'Admin', 
                email: 'admin@cc.com', 
                role: 'admin',
                expires: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString()
            };
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            showApp();
            logActivity('login', 'Admin logged in');
            showToast('Welcome, Admin!', 'success');
        } else if (email === 'buyer@cc.com' && password === 'buyer123') {
            currentUser = { 
                name: 'Demo Buyer', 
                email: 'buyer@cc.com', 
                role: 'buyer',
                unit: 'CC YORK',
                expires: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString()
            };
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            showApp();
            logActivity('login', 'Demo Buyer logged in (CC YORK)');
            showToast('Welcome, Demo Buyer!', 'success');
        } else {
            showToast('Invalid credentials', 'error');
        }
        
        showLoading(false);
    }

    async function handleSignup(e) {
        e.preventDefault();
        const name = document.getElementById('signup-name').value;
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;
        const role = document.getElementById('selected-role').value;
        const unit = document.getElementById('signup-unit').value;
        
        if (!role) {
            showToast('Please select a role', 'error');
            return;
        }
        
        if (role === 'buyer' && !unit) {
            showToast('Please select a unit', 'error');
            return;
        }
        
        // Check if email already exists (using global users array)
        if (users.find(u => u.email === email)) {
            showToast('Email already registered', 'error');
            return;
        }
        
        // Create new user
        const newUser = { 
            id: Date.now().toString(),
            name, 
            email, 
            password, 
            role, 
            unit, 
            createdAt: new Date().toISOString() 
        };
        users.push(newUser);
        
        // Save to localStorage
        saveAllData();
        
        // Sync to Supabase if configured (for cross-device access)
        if (supabaseClient) {
            try {
                await syncToSupabase(false);
                showToast('Account created and synced to cloud!', 'success');
            } catch (e) {
                console.log('Sync failed:', e);
                showToast('Account created! (Sync pending)', 'success');
            }
        } else {
            showToast('Account created! Please log in.', 'success');
        }
        
        document.getElementById('verification-email').textContent = email;
        document.getElementById('verification-alert').style.display = 'block';
        
        switchAuthTab('login');
    }

    function showForgotPassword() {
        document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
        document.getElementById('loginForm').classList.add('hidden');
        document.getElementById('signupForm').classList.add('hidden');
        document.getElementById('forgotForm').classList.remove('hidden');
    }

    function handleForgotPassword(e) {
        e.preventDefault();
        showToast('Password reset link sent to your email', 'success');
        switchAuthTab('login');
    }

    function logout() {
        logActivity('logout', `User logged out: ${currentUser?.name || 'Unknown'}`);
        
        currentUser = null;
        localStorage.removeItem('currentUser');
        document.getElementById('auth-section').classList.remove('hidden');
        document.getElementById('app-layout').classList.add('hidden');
        showToast('Logged out successfully', 'success');
    }

    function showApp() {
        document.getElementById('auth-section').classList.add('hidden');
        document.getElementById('app-layout').classList.remove('hidden');
        document.getElementById('user-profile').classList.remove('hidden');
        document.getElementById('profile-name').textContent = currentUser.name;
        document.getElementById('profile-role').textContent = currentUser.role === 'admin' ? 'Administrator' : currentUser.unit;
        document.getElementById('user-role-display').textContent = 'Role: ' + (currentUser.role === 'admin' ? 'Administrator' : 'Restaurant Unit');
        
        if (currentUser.role === 'admin') {
            document.getElementById('admin-menu').classList.remove('hidden');
            document.getElementById('rest-menu').classList.add('hidden');
            document.getElementById('rest-title').textContent = 'Central Kitchen Management';
        } else {
            document.getElementById('admin-menu').classList.add('hidden');
            document.getElementById('rest-menu').classList.remove('hidden');
            document.getElementById('rest-title').textContent = currentUser.unit + ' - New Order';
        }
        
        renderMessages();
        renderActivityLog();
        updatePrepStats();
        updateDashboardPrepSummary();
    }

    // ==================== PAGE NAVIGATION ====================
    function showPage(pageId, element) {
        document.querySelectorAll('.page-section').forEach(p => p.classList.add('hidden'));
        document.getElementById(pageId).classList.remove('hidden');
        
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        if (element) element.classList.add('active');
        
        if (pageId === 'admin-stock') renderStock();
        if (pageId === 'admin-orders') renderAllOrders();
        if (pageId === 'admin-messages') renderMessages();
        if (pageId === 'admin-activity') renderActivityLog();
        if (pageId === 'admin-recipes') renderRecipes();
        if (pageId === 'admin-analytics') loadAnalyticsData();
        if (pageId === 'admin-dashboard') {
            updateDashboardStats();
            updateDashboardPrepSummary();
            initSparklines();
            generateSmartAlerts();
        }
        if (pageId === 'admin-prep-sheets') {
            updatePrepDateDisplay();
            renderPrepDailyView();
            updatePrepStats();
        }
        if (pageId === 'admin-ai-predictions') generateAIPredictions();
        if (pageId === 'rest-order') renderOrderItems();
        if (pageId === 'rest-history') renderOrderHistory();
        if (pageId === 'rest-stock') renderRestStock();
        if (pageId === 'rest-messages') renderRestMessages();
        if (pageId === 'admin-sync') updateSyncInfo();
        
        // Close mobile sidebar after navigation
        closeMobileSidebar();
        
        // Update mobile bottom nav active state
        updateMobileBottomNav(pageId);
    }

    // ==================== MOBILE NAVIGATION ====================
    function toggleMobileSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        const toggle = document.getElementById('mobile-menu-toggle');
        
        if (sidebar.classList.contains('active')) {
            closeMobileSidebar();
        } else {
            sidebar.classList.add('active');
            overlay.classList.add('active');
            toggle.innerHTML = '<i class="fas fa-times"></i>';
        }
    }
    
    function closeMobileSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        const toggle = document.getElementById('mobile-menu-toggle');
        
        sidebar.classList.remove('active');
        overlay.classList.remove('active');
        toggle.innerHTML = '<i class="fas fa-bars"></i>';
    }
    
    function showMobilePage(pageId) {
        showPage(pageId, null);
        updateMobileBottomNav(pageId);
    }
    
    function updateMobileBottomNav(pageId) {
        const navItems = document.querySelectorAll('.mobile-bottom-nav .nav-item');
        navItems.forEach(item => {
            item.classList.remove('active');
        });
        
        // Map page IDs to nav items
        const pageMap = {
            'admin-dashboard': 0,
            'admin-orders': 1,
            'admin-stock': 2,
            'admin-menu-cost': 3,
            'admin-analytics': 4
        };
        
        const navIndex = pageMap[pageId];
        if (navIndex !== undefined && navItems[navIndex]) {
            navItems[navIndex].classList.add('active');
        }
    }
    
    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', function(e) {
        const sidebar = document.getElementById('sidebar');
        const toggle = document.getElementById('mobile-menu-toggle');
        
        if (window.innerWidth <= 991 && sidebar.classList.contains('active')) {
            if (!sidebar.contains(e.target) && !toggle.contains(e.target)) {
                closeMobileSidebar();
            }
        }
    });
    
    // Handle window resize
    window.addEventListener('resize', function() {
        if (window.innerWidth > 991) {
            closeMobileSidebar();
        }
    });

    // ==================== THEME TOGGLE ====================
    function toggleTheme() {
        const currentTheme = document.documentElement.getAttribute('data-bs-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-bs-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeToggle(newTheme);
    }

    function updateThemeToggle(theme) {
        const icon = document.getElementById('theme-icon');
        const text = document.getElementById('theme-text');
        if (theme === 'dark') {
            icon.className = 'fas fa-sun';
            text.textContent = 'Light Mode';
        } else {
            icon.className = 'fas fa-moon';
            text.textContent = 'Dark Mode';
        }
    }

    // ==================== INVENTORY MANAGEMENT ====================
    function initInventory() {
        if (inventory.length === 0) {
            inventory = [
                // DNA Central Ltd - Meats & Steaks (FILLET Category)
                { id: 'fillet-001', name: 'Whole Fillet', category: 'meat', unit: 'kg', cost: 25.00, minStock: 5, stock: 15, maxOrder: 0, meatCategory: 'FILLET' },
                { id: 'fillet-002', name: 'Fillet 250g', category: 'meat', unit: 'pc', cost: 8.50, minStock: 35, stock: 80, maxOrder: 0, meatCategory: 'FILLET' },
                { id: 'fillet-003', name: 'Flatten', category: 'meat', unit: 'pc', cost: 22.00, minStock: 15, stock: 40, maxOrder: 0, meatCategory: 'FILLET' },
                { id: 'fillet-004', name: 'Mince (Fillet)', category: 'meat', unit: 'kg', cost: 12.00, minStock: 20, stock: 50, maxOrder: 0, meatCategory: 'FILLET' },
                { id: 'fillet-005', name: 'Chateau', category: 'meat', unit: 'pc', cost: 28.00, minStock: 10, stock: 25, maxOrder: 0, meatCategory: 'FILLET' },
                { id: 'fillet-006', name: 'Arrow', category: 'meat', unit: 'pc', cost: 24.00, minStock: 8, stock: 20, maxOrder: 0, meatCategory: 'FILLET' },
                
                // DNA Central Ltd - SIRLOIN Category
                { id: 'sirloin-001', name: 'Whole Sirloin', category: 'meat', unit: 'kg', cost: 18.00, minStock: 5, stock: 15, maxOrder: 0, meatCategory: 'SIRLOIN' },
                { id: 'sirloin-002', name: 'Sirloin 300g', category: 'meat', unit: 'pc', cost: 7.50, minStock: 40, stock: 90, maxOrder: 0, meatCategory: 'SIRLOIN' },
                { id: 'sirloin-003', name: 'Sirloin 100g', category: 'meat', unit: 'pc', cost: 3.00, minStock: 35, stock: 80, maxOrder: 0, meatCategory: 'SIRLOIN' },
                { id: 'sirloin-004', name: 'Mince (Sirloin)', category: 'meat', unit: 'kg', cost: 10.00, minStock: 20, stock: 50, maxOrder: 0, meatCategory: 'SIRLOIN' },
                
                // DNA Central Ltd - RIBEYE Category
                { id: 'ribeye-001', name: 'Whole Ribeye', category: 'meat', unit: 'kg', cost: 20.00, minStock: 4, stock: 12, maxOrder: 0, meatCategory: 'RIBEYE' },
                { id: 'ribeye-002', name: 'Ribeye', category: 'meat', unit: 'pc', cost: 22.00, minStock: 18, stock: 45, maxOrder: 0, meatCategory: 'RIBEYE' },
                { id: 'ribeye-003', name: 'Mince (Ribeye)', category: 'meat', unit: 'kg', cost: 11.00, minStock: 17, stock: 45, maxOrder: 0, meatCategory: 'RIBEYE' },
                
                // DNA Central Ltd - RUMP Category
                { id: 'rump-001', name: 'Whole Rump', category: 'meat', unit: 'kg', cost: 15.00, minStock: 5, stock: 15, maxOrder: 0, meatCategory: 'RUMP' },
                { id: 'rump-002', name: 'Rump 200g', category: 'meat', unit: 'pc', cost: 4.50, minStock: 45, stock: 100, maxOrder: 0, meatCategory: 'RUMP' },
                { id: 'rump-003', name: 'Rump 300g', category: 'meat', unit: 'pc', cost: 6.50, minStock: 36, stock: 80, maxOrder: 0, meatCategory: 'RUMP' },
                { id: 'rump-004', name: 'Mince (Rump)', category: 'meat', unit: 'kg', cost: 9.00, minStock: 19, stock: 50, maxOrder: 0, meatCategory: 'RUMP' },
                
                // Additional DNA Central Steaks
                { id: 'steak-001', name: 'Fillet 250gr', category: 'meat', unit: 'pc', cost: 18.50, minStock: 20, stock: 45, maxOrder: 0 },
                { id: 'steak-002', name: 'Ribeye 300gr', category: 'meat', unit: 'pc', cost: 22.00, minStock: 15, stock: 35, maxOrder: 0 },
                { id: 'steak-003', name: 'Sirloin 300gr', category: 'meat', unit: 'pc', cost: 19.50, minStock: 18, stock: 40, maxOrder: 0 },
                { id: 'steak-004', name: 'Sirloin 100gr', category: 'meat', unit: 'pc', cost: 8.50, minStock: 25, stock: 50, maxOrder: 0 },
                { id: 'steak-005', name: 'Chateaubriand 600gr', category: 'meat', unit: 'pc', cost: 45.00, minStock: 5, stock: 12, maxOrder: 0 },
                { id: 'steak-006', name: 'Whole Rump Heart', category: 'meat', unit: 'kg', cost: 28.00, minStock: 8, stock: 20, maxOrder: 0 },
                { id: 'steak-007', name: 'Rump 300gr', category: 'meat', unit: 'pc', cost: 16.50, minStock: 15, stock: 35, maxOrder: 0 },
                { id: 'steak-008', name: 'Rump 200gr', category: 'meat', unit: 'pc', cost: 12.00, minStock: 20, stock: 45, maxOrder: 0 },
                { id: 'steak-009', name: 'Rump 130gr', category: 'meat', unit: 'pc', cost: 8.50, minStock: 25, stock: 55, maxOrder: 0 },
                { id: 'steak-010', name: 'Flatten Steak', category: 'meat', unit: 'pc', cost: 14.50, minStock: 15, stock: 30, maxOrder: 0 },
                { id: 'steak-011', name: 'Flat Iron by kg', category: 'meat', unit: 'kg', cost: 32.00, minStock: 5, stock: 15, maxOrder: 0 },
                { id: 'steak-012', name: 'Whole Tenderloin', category: 'meat', unit: 'kg', cost: 55.00, minStock: 3, stock: 10, maxOrder: 0 },
                { id: 'steak-013', name: 'Whole Ribeye', category: 'meat', unit: 'kg', cost: 48.00, minStock: 4, stock: 12, maxOrder: 0 },
                { id: 'steak-014', name: 'Whole Striploin', category: 'meat', unit: 'kg', cost: 42.00, minStock: 5, stock: 14, maxOrder: 0 },
                { id: 'steak-015', name: 'Beef for Burgers', category: 'meat', unit: 'kg', cost: 12.50, minStock: 20, stock: 50, maxOrder: 0 },
                { id: 'steak-016', name: 'Pulled Beef', category: 'meat', unit: 'kg', cost: 18.00, minStock: 10, stock: 25, maxOrder: 0 },
                { id: 'steak-017', name: 'Braised Beef', category: 'meat', unit: 'kg', cost: 16.50, minStock: 8, stock: 20, maxOrder: 0 },
                { id: 'steak-018', name: 'Bolognese', category: 'meat', unit: 'kg', cost: 11.00, minStock: 15, stock: 35, maxOrder: 0 },
                { id: 'steak-019', name: 'Beef Tartare', category: 'meat', unit: 'kg', cost: 35.00, minStock: 3, stock: 10, maxOrder: 0 },
                { id: 'steak-020', name: 'Meatballs', category: 'meat', unit: 'kg', cost: 10.50, minStock: 15, stock: 40, maxOrder: 0 },
                
                // Pork
                { id: 'pork-001', name: 'Pork Belly Roulade', category: 'meat', unit: 'kg', cost: 14.50, minStock: 8, stock: 20, maxOrder: 0 },
                { id: 'pork-002', name: 'Pork Crackling', category: 'meat', unit: 'kg', cost: 8.50, minStock: 5, stock: 15, maxOrder: 0 },
                { id: 'pork-003', name: 'Ribs', category: 'meat', unit: 'kg', cost: 12.00, minStock: 10, stock: 25, maxOrder: 0 },
                { id: 'pork-004', name: 'Ham Hock Terrine', category: 'meat', unit: 'kg', cost: 15.50, minStock: 5, stock: 12, maxOrder: 0 },
                { id: 'pork-005', name: 'Black Pudding Bon Bon', category: 'meat', unit: 'pc', cost: 2.50, minStock: 30, stock: 80, maxOrder: 0 },
                
                // Chicken
                { id: 'chicken-001', name: 'Chicken Skewer', category: 'meat', unit: 'pc', cost: 6.50, minStock: 25, stock: 60, maxOrder: 0 },
                { id: 'chicken-002', name: 'Chicken Kiev', category: 'meat', unit: 'pc', cost: 8.50, minStock: 20, stock: 45, maxOrder: 0 },
                { id: 'chicken-003', name: 'Duck Leg', category: 'meat', unit: 'pc', cost: 12.50, minStock: 10, stock: 25, maxOrder: 0 },
                
                // Seafood
                { id: 'seafood-001', name: 'Octopus by kg', category: 'meat', unit: 'kg', cost: 38.00, minStock: 3, stock: 10, maxOrder: 0 },
                { id: 'seafood-002', name: 'Lobster Bisque', category: 'soups', unit: 'L', cost: 18.50, minStock: 5, stock: 15, maxOrder: 0 },
                
                // Sunday Roast Items
                { id: 'roast-001', name: 'Sunday Roast Sirloin', category: 'meat', unit: 'kg', cost: 42.00, minStock: 5, stock: 15, maxOrder: 0 },
                { id: 'roast-002', name: 'Sunday Roast Parsnips', category: 'produce', unit: 'kg', cost: 3.50, minStock: 15, stock: 40, maxOrder: 0 },
                { id: 'roast-003', name: 'Sunday Roast Potatoes', category: 'produce', unit: 'kg', cost: 2.80, minStock: 25, stock: 60, maxOrder: 0 },
                { id: 'roast-004', name: 'Sunday Roast Yorkshire Puddings', category: 'prepared', unit: 'pc', cost: 0.80, minStock: 50, stock: 150, maxOrder: 0 },
                { id: 'roast-005', name: 'Sunday Roast Carrots', category: 'produce', unit: 'kg', cost: 2.20, minStock: 20, stock: 50, maxOrder: 0 },
                
                // Sauces & Dressings
                { id: 'sauce-001', name: 'Peppercorn Sauce', category: 'sauces', unit: 'L', cost: 8.50, minStock: 5, stock: 15, maxOrder: 0 },
                { id: 'sauce-002', name: 'Truffle Mayo', category: 'sauces', unit: 'L', cost: 22.00, minStock: 3, stock: 10, maxOrder: 0 },
                { id: 'sauce-003', name: 'Lemon Mayo', category: 'sauces', unit: 'L', cost: 9.50, minStock: 5, stock: 15, maxOrder: 0 },
                { id: 'sauce-004', name: 'Caesar Sauce', category: 'sauces', unit: 'L', cost: 10.50, minStock: 5, stock: 15, maxOrder: 0 },
                { id: 'sauce-005', name: 'Marie Rose', category: 'sauces', unit: 'L', cost: 9.00, minStock: 5, stock: 12, maxOrder: 0 },
                { id: 'sauce-006', name: 'Walnut Dressing', category: 'sauces', unit: 'L', cost: 15.50, minStock: 3, stock: 10, maxOrder: 0 },
                { id: 'sauce-007', name: 'Chilli Lemon Butter', category: 'sauces', unit: 'kg', cost: 12.50, minStock: 4, stock: 12, maxOrder: 0 },
                { id: 'sauce-008', name: 'Cauliflower & Hazelnut Sauce', category: 'sauces', unit: 'L', cost: 14.50, minStock: 4, stock: 12, maxOrder: 0 },
                { id: 'sauce-009', name: 'Leek Sauce', category: 'sauces', unit: 'L', cost: 11.50, minStock: 4, stock: 12, maxOrder: 0 },
                { id: 'sauce-010', name: 'Cheese Sauce', category: 'sauces', unit: 'L', cost: 10.00, minStock: 5, stock: 15, maxOrder: 0 },
                { id: 'sauce-011', name: 'Herb Oil', category: 'sauces', unit: 'L', cost: 18.50, minStock: 3, stock: 10, maxOrder: 0 },
                { id: 'sauce-012', name: 'Onion Puree', category: 'sauces', unit: 'kg', cost: 8.50, minStock: 5, stock: 15, maxOrder: 0 },
                { id: 'sauce-013', name: 'Beef Tartare Dressing', category: 'sauces', unit: 'L', cost: 16.50, minStock: 3, stock: 10, maxOrder: 0 },
                { id: 'sauce-014', name: 'Black Garlic & Yuzu Mayo', category: 'sauces', unit: 'L', cost: 24.50, minStock: 2, stock: 8, maxOrder: 0 },
                { id: 'sauce-015', name: 'Hot Honey Sauce', category: 'sauces', unit: 'L', cost: 14.00, minStock: 3, stock: 10, maxOrder: 0 },
                { id: 'sauce-016', name: 'Maple Mustard Dressing', category: 'sauces', unit: 'L', cost: 13.50, minStock: 4, stock: 12, maxOrder: 0 },
                { id: 'sauce-017', name: 'Pickled Liquer', category: 'sauces', unit: 'L', cost: 11.00, minStock: 4, stock: 12, maxOrder: 0 },
                { id: 'sauce-018', name: 'Spiced Carrot Puree', category: 'sauces', unit: 'kg', cost: 7.50, minStock: 6, stock: 18, maxOrder: 0 },
                { id: 'sauce-019', name: 'Cannellini Puree', category: 'sauces', unit: 'kg', cost: 6.50, minStock: 6, stock: 18, maxOrder: 0 },
                { id: 'sauce-020', name: 'Chilli Oil', category: 'sauces', unit: 'L', cost: 9.50, minStock: 5, stock: 15, maxOrder: 0 },
                { id: 'sauce-021', name: 'Chilli & Yuzu Sauce', category: 'sauces', unit: 'L', cost: 19.50, minStock: 3, stock: 10, maxOrder: 0 },
                { id: 'sauce-022', name: 'Porcini Sauce', category: 'sauces', unit: 'L', cost: 26.50, minStock: 2, stock: 8, maxOrder: 0 },
                { id: 'sauce-023', name: 'Beetroot Hummous', category: 'sauces', unit: 'kg', cost: 8.50, minStock: 5, stock: 15, maxOrder: 0 },
                { id: 'sauce-024', name: 'Market Gravy', category: 'sauces', unit: 'L', cost: 7.50, minStock: 8, stock: 25, maxOrder: 0 },
                { id: 'sauce-025', name: 'Walnut Jam', category: 'sauces', unit: 'kg', cost: 18.00, minStock: 3, stock: 10, maxOrder: 0 },
                { id: 'sauce-026', name: 'Mustard Mayo', category: 'sauces', unit: 'L', cost: 10.50, minStock: 5, stock: 15, maxOrder: 0 },
                { id: 'sauce-027', name: 'Red Wine Sauce', category: 'sauces', unit: 'L', cost: 12.50, minStock: 5, stock: 15, maxOrder: 0 },
                { id: 'sauce-028', name: 'Aji Amarillo Sauce', category: 'sauces', unit: 'L', cost: 21.50, minStock: 2, stock: 8, maxOrder: 0 },
                { id: 'sauce-029', name: 'Chicken Brine', category: 'sauces', unit: 'L', cost: 5.50, minStock: 10, stock: 30, maxOrder: 0 },
                { id: 'sauce-030', name: 'Hazelnut Gremolata', category: 'sauces', unit: 'kg', cost: 16.50, minStock: 3, stock: 10, maxOrder: 0 },
                { id: 'sauce-031', name: 'Tarragon Sauce', category: 'sauces', unit: 'L', cost: 13.50, minStock: 4, stock: 12, maxOrder: 0 },
                { id: 'sauce-032', name: 'Salsa For Fajitas', category: 'sauces', unit: 'L', cost: 8.50, minStock: 6, stock: 18, maxOrder: 0 },
                { id: 'sauce-033', name: 'Cauliflower Puree', category: 'sauces', unit: 'kg', cost: 7.50, minStock: 5, stock: 15, maxOrder: 0 },
                { id: 'sauce-034', name: 'Tahini Dressing', category: 'sauces', unit: 'L', cost: 14.50, minStock: 3, stock: 10, maxOrder: 0 },
                { id: 'sauce-035', name: 'Pistachio Dressing', category: 'sauces', unit: 'L', cost: 22.50, minStock: 2, stock: 8, maxOrder: 0 },
                { id: 'sauce-036', name: 'Burger Sauce', category: 'sauces', unit: 'L', cost: 9.50, minStock: 6, stock: 18, maxOrder: 0 },
                { id: 'sauce-037', name: 'Blue Cheese Sauce', category: 'sauces', unit: 'L', cost: 15.50, minStock: 4, stock: 12, maxOrder: 0 },
                { id: 'sauce-038', name: 'Pepper Coulis', category: 'sauces', unit: 'L', cost: 11.50, minStock: 4, stock: 12, maxOrder: 0 },
                { id: 'sauce-039', name: 'Chimitsuri Sauce', category: 'sauces', unit: 'L', cost: 18.50, minStock: 3, stock: 10, maxOrder: 0 },
                { id: 'sauce-040', name: 'Bone Marrow Gravy', category: 'sauces', unit: 'L', cost: 24.50, minStock: 2, stock: 8, maxOrder: 0 },
                { id: 'sauce-041', name: 'Saffron Sauce', category: 'sauces', unit: 'L', cost: 32.50, minStock: 2, stock: 6, maxOrder: 0 },
                { id: 'sauce-042', name: 'Celeriac Puree', category: 'sauces', unit: 'kg', cost: 8.50, minStock: 5, stock: 15, maxOrder: 0 },
                { id: 'sauce-043', name: 'Butternut Squash Puree', category: 'sauces', unit: 'kg', cost: 7.50, minStock: 5, stock: 15, maxOrder: 0 },
                { id: 'sauce-044', name: 'Sweet Potato Puree', category: 'sauces', unit: 'kg', cost: 7.00, minStock: 5, stock: 15, maxOrder: 0 },
                { id: 'sauce-045', name: 'Beetroot Puree', category: 'sauces', unit: 'kg', cost: 8.00, minStock: 5, stock: 15, maxOrder: 0 },
                { id: 'sauce-046', name: 'Parsnip Puree', category: 'sauces', unit: 'kg', cost: 7.50, minStock: 5, stock: 15, maxOrder: 0 },
                { id: 'sauce-047', name: 'Onion Garlic Confit', category: 'sauces', unit: 'kg', cost: 9.50, minStock: 5, stock: 15, maxOrder: 0 },
                { id: 'sauce-048', name: 'Tomato Marination', category: 'sauces', unit: 'kg', cost: 6.50, minStock: 6, stock: 18, maxOrder: 0 },
                { id: 'sauce-049', name: 'Chicken Marination', category: 'sauces', unit: 'kg', cost: 7.50, minStock: 6, stock: 18, maxOrder: 0 },
                { id: 'sauce-050', name: 'Tartar Sauce', category: 'sauces', unit: 'L', cost: 10.50, minStock: 5, stock: 15, maxOrder: 0 },
                { id: 'sauce-051', name: 'Lentils Stew', category: 'soups', unit: 'kg', cost: 8.50, minStock: 5, stock: 15, maxOrder: 0 },
                { id: 'sauce-052', name: 'Leek & Potato Soup', category: 'soups', unit: 'L', cost: 6.50, minStock: 8, stock: 25, maxOrder: 0 },
                { id: 'sauce-053', name: 'Onion Soup', category: 'soups', unit: 'L', cost: 6.00, minStock: 8, stock: 25, maxOrder: 0 },
                { id: 'sauce-054', name: 'Cream Sauce', category: 'sauces', unit: 'L', cost: 9.50, minStock: 5, stock: 15, maxOrder: 0 },
                { id: 'sauce-055', name: 'Champagne Sauce', category: 'sauces', unit: 'L', cost: 28.50, minStock: 2, stock: 8, maxOrder: 0 },
                
                // Prepared Items
                { id: 'prep-001', name: 'Altamura Bread', category: 'prepared', unit: 'pc', cost: 2.50, minStock: 30, stock: 80, maxOrder: 0 },
                { id: 'prep-002', name: 'Butter Blocks', category: 'prepared', unit: 'kg', cost: 8.50, minStock: 10, stock: 30, maxOrder: 0 },
                { id: 'prep-003', name: 'Truffle Croquettes', category: 'prepared', unit: 'pc', cost: 3.50, minStock: 25, stock: 70, maxOrder: 0 },
                { id: 'prep-004', name: 'Cauliflower Croquettes', category: 'prepared', unit: 'pc', cost: 2.80, minStock: 25, stock: 70, maxOrder: 0 },
                { id: 'prep-005', name: 'Aranchini', category: 'prepared', unit: 'pc', cost: 2.50, minStock: 30, stock: 80, maxOrder: 0 },
                { id: 'prep-006', name: 'Wellington', category: 'prepared', unit: 'pc', cost: 28.50, minStock: 5, stock: 15, maxOrder: 0 },
                { id: 'prep-007', name: 'Cottage Pie', category: 'prepared', unit: 'pc', cost: 12.50, minStock: 10, stock: 30, maxOrder: 0 },
                { id: 'prep-008', name: 'Lasagne', category: 'prepared', unit: 'pc', cost: 14.50, minStock: 10, stock: 30, maxOrder: 0 },
                { id: 'prep-009', name: 'Humita', category: 'prepared', unit: 'pc', cost: 6.50, minStock: 15, stock: 45, maxOrder: 0 },
                { id: 'prep-010', name: 'Goat Cheese Bon Bon', category: 'prepared', unit: 'pc', cost: 3.50, minStock: 25, stock: 70, maxOrder: 0 },
                { id: 'prep-011', name: 'Hazelnut Hummous', category: 'prepared', unit: 'kg', cost: 9.50, minStock: 5, stock: 15, maxOrder: 0 },
                { id: 'prep-012', name: 'Beetroot Wedge (Honey & Balsamic)', category: 'prepared', unit: 'kg', cost: 8.50, minStock: 5, stock: 15, maxOrder: 0 },
                { id: 'prep-013', name: 'Pave Potato', category: 'prepared', unit: 'kg', cost: 6.50, minStock: 8, stock: 25, maxOrder: 0 },
                { id: 'prep-014', name: 'Dauphinoise Potato', category: 'prepared', unit: 'kg', cost: 7.50, minStock: 8, stock: 25, maxOrder: 0 },
                { id: 'prep-015', name: 'Coleslaw', category: 'prepared', unit: 'kg', cost: 4.50, minStock: 10, stock: 30, maxOrder: 0 },
                { id: 'prep-016', name: 'Cheese Mix', category: 'prepared', unit: 'kg', cost: 18.50, minStock: 5, stock: 15, maxOrder: 0 },
                { id: 'prep-017', name: 'Croutons', category: 'prepared', unit: 'kg', cost: 5.50, minStock: 8, stock: 25, maxOrder: 0 },
                { id: 'prep-018', name: 'Buttered Breadcrumb', category: 'prepared', unit: 'kg', cost: 6.50, minStock: 8, stock: 25, maxOrder: 0 },
                { id: 'prep-019', name: 'Kiev Crumb', category: 'prepared', unit: 'kg', cost: 7.50, minStock: 6, stock: 20, maxOrder: 0 },
                { id: 'prep-020', name: 'Smoked Bacon', category: 'prepared', unit: 'kg', cost: 14.50, minStock: 5, stock: 15, maxOrder: 0 },
                { id: 'prep-021', name: 'Stuffed Meatballs', category: 'prepared', unit: 'pc', cost: 5.50, minStock: 15, stock: 45, maxOrder: 0 },
                { id: 'prep-022', name: 'Xmas Vegs Stuffed', category: 'prepared', unit: 'kg', cost: 8.50, minStock: 5, stock: 15, maxOrder: 0 },
                { id: 'prep-023', name: 'Steak Salt', category: 'prepared', unit: 'kg', cost: 12.50, minStock: 3, stock: 10, maxOrder: 0 },
                { id: 'prep-024', name: 'Fajitas Peppers', category: 'prepared', unit: 'kg', cost: 7.50, minStock: 6, stock: 20, maxOrder: 0 },
                
                // Desserts
                { id: 'dessert-001', name: 'Tiramisu', category: 'desserts', unit: 'portion', cost: 4.50, minStock: 20, stock: 60, maxOrder: 0 },
                { id: 'dessert-002', name: 'Sticky Toffee Pudding', category: 'desserts', unit: 'portion', cost: 5.00, minStock: 15, stock: 45, maxOrder: 0 },
                { id: 'dessert-003', name: 'Pavlova', category: 'desserts', unit: 'portion', cost: 5.50, minStock: 15, stock: 45, maxOrder: 0 },
                { id: 'dessert-004', name: 'Vegan Cheesecake', category: 'desserts', unit: 'portion', cost: 6.00, minStock: 12, stock: 35, maxOrder: 0 },
                { id: 'dessert-005', name: 'Vanilla Mousse', category: 'desserts', unit: 'portion', cost: 4.00, minStock: 20, stock: 60, maxOrder: 0 },
                { id: 'dessert-006', name: 'Gold Bar Cremeux', category: 'desserts', unit: 'portion', cost: 6.50, minStock: 12, stock: 35, maxOrder: 0 },
                { id: 'dessert-007', name: 'Brownie', category: 'desserts', unit: 'portion', cost: 4.50, minStock: 18, stock: 55, maxOrder: 0 },
                
                // Oils & Fats
                { id: 'oil-001', name: 'Rapeseed Frying Oil', category: 'oils', unit: 'L', cost: 4.50, minStock: 20, stock: 60, maxOrder: 0 },
                { id: 'oil-002', name: 'Parmezan Wheel by kg', category: 'dairy', unit: 'kg', cost: 28.50, minStock: 3, stock: 10, maxOrder: 0 },
                
                // Dry Goods
                { id: 'dry-001', name: 'Turkey', category: 'dry', unit: 'kg', cost: 12.50, minStock: 5, stock: 15, maxOrder: 0 },
                { id: 'dry-002', name: 'Turkey Stock', category: 'dry', unit: 'kg', cost: 8.50, minStock: 5, stock: 15, maxOrder: 0 }
            ];
            saveAllData();
        }
    }

    function renderStock() {
        const search = document.getElementById('stock-search')?.value.toLowerCase() || '';
        const category = document.getElementById('stock-category')?.value || 'all';
        const grid = document.getElementById('stock-grid');
        
        let filtered = inventory;
        if (search) filtered = filtered.filter(p => p.name.toLowerCase().includes(search));
        if (category !== 'all') filtered = filtered.filter(p => p.category === category);
        
        // Sort by stock level (lowest first)
        filtered.sort((a, b) => (a.stock / a.minStock) - (b.stock / b.minStock));
        
        let lowCount = 0;
        grid.innerHTML = filtered.map((product, index) => {
            const stockRatio = product.stock / product.minStock;
            const isLow = stockRatio <= 1;
            const isCritical = product.stock === 0;
            if (isLow) lowCount++;
            
            const statusClass = isCritical ? 'border-danger' : isLow ? 'border-warning' : 'border-success';
            const statusIcon = isCritical ? 'fa-times-circle text-danger' : isLow ? 'fa-exclamation-triangle text-warning' : 'fa-check-circle text-success';
            const stockPercent = Math.min(100, (product.stock / (product.minStock * 2)) * 100);
            
            return `
                <div class="col-md-4 col-lg-3 mb-4 card-entrance" style="animation-delay: ${index * 0.05}s;">
                    <div class="card product-card h-100 ${statusClass} hover-lift glass-card" style="border-width: 2px; border-radius: 16px;">
                        <div class="card-body" onclick="openEditProductModal('${product.id}')">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div class="bg-light rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                    <i class="fas fa-box ${isLow ? 'text-warning' : 'text-success'}"></i>
                                </div>
                                <div class="edit-hint"><i class="fas fa-pencil-alt"></i></div>
                            </div>
                            <h6 class="card-title fw-bold mb-1">${product.name}</h6>
                            <small class="text-muted text-uppercase" style="font-size: 0.7rem; letter-spacing: 0.5px;">${product.category}</small>
                            
                            <div class="mt-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="text-muted">Stock</span>
                                    <span class="fw-bold ${isLow ? 'text-danger' : ''}">${product.stock} ${product.unit}</span>
                                </div>
                                <div class="progress mb-2" style="height: 8px; border-radius: 4px;">
                                    <div class="progress-bar ${isCritical ? 'bg-danger' : isLow ? 'bg-warning' : 'bg-success'}" style="width: ${stockPercent}%; border-radius: 4px;"></div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">Min: ${product.minStock}</small>
                                    <small class="fw-bold">${product.cost.toFixed(2)}</small>
                                </div>
                                ${product.maxOrder > 0 ? `<small class="text-info"><i class="fas fa-info-circle me-1"></i>Max order: ${product.maxOrder}</small>` : ''}
                            </div>
                        </div>
                        <div class="card-footer bg-transparent border-0 pt-0">
                            <button onclick="event.stopPropagation(); showQRCode('${product.id}')" class="btn btn-sm btn-outline-primary w-100 fw-bold">
                                <i class="fas fa-qrcode me-1"></i>View QR Code
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        document.getElementById('stock-low-count').textContent = lowCount + ' items low';
    }

    function filterStock() {
        renderStock();
    }

    function openEditProductModal(productId) {
        const product = inventory.find(p => p.id === productId);
        if (!product) return;
        
        document.getElementById('edit-product-id').value = product.id;
        document.getElementById('edit-name').value = product.name;
        document.getElementById('edit-category').value = product.category;
        document.getElementById('edit-unit').value = product.unit;
        document.getElementById('edit-cost').value = product.cost;
        document.getElementById('edit-min').value = product.minStock;
        document.getElementById('edit-stock').value = product.stock;
        document.getElementById('edit-max').value = product.maxOrder || 0;
        document.getElementById('productModalLabel').textContent = 'Edit Product';
        document.getElementById('delete-product-btn').style.display = 'inline-block';
        
        new bootstrap.Modal(document.getElementById('productModal')).show();
    }

    function openAddProductModal() {
        document.getElementById('edit-product-id').value = '';
        document.getElementById('productForm').reset();
        document.getElementById('productModalLabel').textContent = 'Add New Product';
        document.getElementById('delete-product-btn').style.display = 'none';
        new bootstrap.Modal(document.getElementById('productModal')).show();
    }

    function saveProduct() {
        const id = document.getElementById('edit-product-id').value;
        const name = document.getElementById('edit-name').value;
        const category = document.getElementById('edit-category').value;
        const unit = document.getElementById('edit-unit').value;
        const cost = parseFloat(document.getElementById('edit-cost').value);
        const minStock = parseInt(document.getElementById('edit-min').value);
        const stock = parseInt(document.getElementById('edit-stock').value);
        const maxOrder = parseInt(document.getElementById('edit-max').value) || 0;
        
        if (id) {
            const index = inventory.findIndex(p => p.id === id);
            if (index > -1) {
                inventory[index] = { ...inventory[index], name, category, unit, cost, minStock, stock, maxOrder };
            }
        } else {
            const newId = 'prod-' + Date.now();
            inventory.push({ id: newId, name, category, unit, cost, minStock, stock, maxOrder });
        }
        
        saveAllData();
        renderStock();
        renderOrderItems();
        bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
        showToast('Product saved successfully', 'success');
    }

    function deleteProduct() {
        const id = document.getElementById('edit-product-id').value;
        if (!confirm('Are you sure you want to delete this product?')) return;
        
        inventory = inventory.filter(p => p.id !== id);
        saveAllData();
        renderStock();
        renderOrderItems();
        bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
        showToast('Product deleted', 'success');
    }


    // ==================== QR CODE FEATURES ====================
    let qrScanner = null;
    let scannedProductId = null;

    function showQRCode(productId) {
        const product = inventory.find(p => p.id === productId);
        if (!product) return;
        
        document.getElementById('qr-item-name').textContent = product.name;
        document.getElementById('qr-item-id').textContent = product.id;
        
        const qrContainer = document.getElementById('qrcode-display');
        qrContainer.innerHTML = '';
        
        new QRCode(qrContainer, {
            text: product.id,
            width: 200,
            height: 200,
            colorDark: '#1e3a5f',
            colorLight: '#ffffff',
            correctLevel: QRCode.CorrectLevel.M
        });
        
        new bootstrap.Modal(document.getElementById('qrDisplayModal')).show();
    }

    function printQRCode() {
        const printWindow = window.open('', '_blank');
        const productName = document.getElementById('qr-item-name').textContent;
        const productId = document.getElementById('qr-item-id').textContent;
        const qrImage = document.querySelector('#qrcode-display img').src;
        
        printWindow.document.write(`
            <html>
            <head><title>QR Code - ${productName}</title></head>
            <body style="text-align: center; padding: 20px; font-family: Arial;">
                <h2>${productName}</h2>
                <img src="${qrImage}" style="max-width: 300px;">
                <p style="font-size: 12px; color: #666;">${productId}</p>
                <scr"+"ipt>window.onload = function() { window.print(); window.close(); }<\/scr"+"ipt>
            </body>
            </html>
        `);
        printWindow.document.close();
    }

    function openQrScanner() {
        scannedProductId = null;
        document.getElementById('qr-result').classList.add('hidden');
        document.getElementById('qr-error').classList.add('hidden');
        
        new bootstrap.Modal(document.getElementById('qrScannerModal')).show();
        
        setTimeout(() => {
            qrScanner = new Html5Qrcode('qr-reader');
            qrScanner.start(
                { facingMode: 'environment' },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                onScanSuccess,
                onScanFailure
            );
        }, 500);
    }

    function stopQrScanner() {
        if (qrScanner) {
            qrScanner.stop().then(() => {
                qrScanner = null;
            }).catch(() => {});
        }
    }

    function onScanSuccess(decodedText) {
        const product = inventory.find(p => p.id === decodedText);
        
        if (product) {
            scannedProductId = product.id;
            document.getElementById('qr-item-details').innerHTML = `
                <div class="fw-bold">${product.name}</div>
                <div class="text-muted">${product.category} | Stock: ${product.stock} ${product.unit}</div>
                <div class="fw-bold text-success">${product.cost.toFixed(2)}</div>
            `;
            document.getElementById('qr-result').classList.remove('hidden');
            document.getElementById('qr-error').classList.add('hidden');
            stopQrScanner();
        } else {
            document.getElementById('qr-result').classList.add('hidden');
            document.getElementById('qr-error').classList.remove('hidden');
        }
    }

    function onScanFailure(error) {}

    function viewScannedItem() {
        bootstrap.Modal.getInstance(document.getElementById('qrScannerModal')).hide();
        if (scannedProductId) {
            openEditProductModal(scannedProductId);
        }
    }

    function quickAddStock() {
        if (!scannedProductId) return;
        
        const product = inventory.find(p => p.id === scannedProductId);
        if (product) {
            product.stock += 10;
            saveAllData();
            renderStock();
            showToast(`Added 10 ${product.unit} to ${product.name}`, 'success');
            bootstrap.Modal.getInstance(document.getElementById('qrScannerModal')).hide();
        }
    }

    // ==================== ORDER MANAGEMENT ====================
    function renderOrderItems() {
        const container = document.getElementById('order-items-container');
        const search = document.getElementById('order-search')?.value.toLowerCase() || '';
        
        let filtered = inventory.filter(p => p.stock > 0);
        if (search) filtered = filtered.filter(p => p.name.toLowerCase().includes(search));
        
        // Group by category
        const grouped = filtered.reduce((acc, product) => {
            if (!acc[product.category]) acc[product.category] = [];
            acc[product.category].push(product);
            return acc;
        }, {});
        
        let html = '';
        for (const [category, products] of Object.entries(grouped)) {
            html += `<h6 class="fw-bold text-muted text-uppercase mb-3 mt-4" style="font-size: 0.8rem; letter-spacing: 1px;">${category}</h6>`;
            html += '<div class="row g-3">';
            
            html += products.map(product => {
                const inCart = currentOrder.find(item => item.id === product.id);
                const cartQty = inCart ? inCart.qty : 0;
                const maxOrder = product.maxOrder || product.stock;
                const canAddMore = cartQty < maxOrder;
                const isMaxReached = cartQty >= maxOrder && maxOrder > 0;
                
                return `
                    <div class="col-md-6">
                        <div class="card order-item-card p-3 ${isMaxReached ? 'max-reached' : ''} hover-lift" style="border-radius: 12px; background: var(--card-bg); border: 1px solid var(--border-color);">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-bold">${product.name}</div>
                                    <small class="text-muted">${product.cost.toFixed(2)} / ${product.unit}</small>
                                    ${product.maxOrder > 0 ? `<small class="text-info d-block"><i class="fas fa-info-circle me-1"></i>Max: ${product.maxOrder}</small>` : ''}
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    ${cartQty > 0 ? `
                                        <button onclick="updateOrderQty('${product.id}', -1)" class="btn btn-sm btn-outline-danger fw-bold" style="width: 32px;">-</button>
                                        <span class="fw-bold px-2">${cartQty}</span>
                                    ` : ''}
                                    <button onclick="updateOrderQty('${product.id}', 1)" class="btn btn-sm btn-primary fw-bold" ${!canAddMore ? 'disabled' : ''} style="background: var(--gradient-primary); border: none; width: 32px;">+</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            html += '</div>';
        }
        
        container.innerHTML = html || '<p class="text-muted text-center py-5">No products available</p>';
    }

    function filterOrderItems() {
        renderOrderItems();
    }

    function updateOrderQty(productId, change) {
        const product = inventory.find(p => p.id === productId);
        if (!product) return;
        
        const existing = currentOrder.find(item => item.id === productId);
        const maxOrder = product.maxOrder || product.stock;
        
        if (existing) {
            existing.qty += change;
            if (existing.qty <= 0) {
                currentOrder = currentOrder.filter(item => item.id !== productId);
            }
        } else if (change > 0) {
            currentOrder.push({ id: productId, qty: 1, ...product });
        }
        
        renderOrderItems();
        renderOrderSummary();
    }

    function renderOrderSummary() {
        const container = document.getElementById('current-order-items');
        
        if (currentOrder.length === 0) {
            container.innerHTML = '<p class="text-muted text-center">Cart is empty</p>';
            document.getElementById('submit-order-btn').disabled = true;
        } else {
            container.innerHTML = currentOrder.map(item => `
                <div class="d-flex justify-content-between align-items-center mb-2 p-2 rounded-3" style="background: var(--bg-color);">
                    <div>
                        <div class="fw-bold small">${item.name}</div>
                        <small class="text-muted">${item.qty} x ${item.cost.toFixed(2)}</small>
                    </div>
                    <div class="fw-bold">${(item.qty * item.cost).toFixed(2)}</div>
                </div>
            `).join('');
            document.getElementById('submit-order-btn').disabled = false;
        }
        
        const subtotal = currentOrder.reduce((sum, item) => sum + (item.qty * item.cost), 0);
        const vat = subtotal * 0.2;
        const total = subtotal + vat;
        
        document.getElementById('order-subtotal').textContent = '' + subtotal.toFixed(2);
        document.getElementById('order-vat').textContent = '' + vat.toFixed(2);
        document.getElementById('order-total').textContent = '' + total.toFixed(2);
    }

    function clearOrder() {
        currentOrder = [];
        renderOrderItems();
        renderOrderSummary();
    }

    function processOrder() {
        if (currentOrder.length === 0) return;
        
        // Check stock availability
        for (const item of currentOrder) {
            const product = inventory.find(p => p.id === item.id);
            if (!product || product.stock < item.qty) {
                showToast(`Insufficient stock for ${product?.name || 'item'}`, 'error');
                return;
            }
        }
        
        // Deduct stock
        currentOrder.forEach(item => {
            const product = inventory.find(p => p.id === item.id);
            if (product) {
                product.stock -= item.qty;
            }
        });
        
        // Create order
        const subtotal = currentOrder.reduce((sum, item) => sum + (item.qty * item.cost), 0);
        const vat = subtotal * 0.2;
        const total = subtotal + vat;
        
        const order = {
            id: 'INV-' + Date.now(),
            invoiceNumber: 'CC-' + String(orders.length + 1).padStart(4, '0'),
            items: [...currentOrder],
            subtotal: subtotal,
            vat: vat,
            total: total,
            unit: currentUser.unit,
            userName: currentUser.name,
            date: new Date().toISOString(),
            taxWeek: currentTaxWeek,
            status: 'pending'
        };
        
        orders.push(order);
        saveAllData();
        
        // Auto-sync to Supabase if enabled
        if (autoSyncEnabled && supabaseClient) {
            syncToSupabase(false);
        }
        
        // Show invoice
        showInvoice(order);
        
        // Clear cart
        currentOrder = [];
        renderOrderItems();
        renderOrderSummary();
        renderStock();
        renderDeliveryTracker();
        updateDashboardStats();
        updateDashboardStockAlerts();
        
        logActivity('order', `Order placed: ${order.invoiceNumber} by ${currentUser.name} - ${total.toFixed(2)}`);
        showToast('Order submitted successfully!', 'success');
        createConfetti();
    }

    function showInvoice(order) {
        const modalContent = document.getElementById('invoice-content');
        modalContent.innerHTML = `
            <div style="background: var(--gradient-dark); color: white; padding: 30px;">
                <div class="text-center">
                    <h3 class="fw-bold mb-1">CC & LUCIA</h3>
                    <p class="mb-0 opacity-75">Central Kitchen Invoice</p>
                </div>
            </div>
            <div class="p-4" style="background: var(--card-bg); color: var(--text-dark);">
                <div class="row mb-4">
                    <div class="col-6">
                        <small class="text-muted">Invoice #</small>
                        <div class="fw-bold">${order.invoiceNumber}</div>
                    </div>
                    <div class="col-6 text-end">
                        <small class="text-muted">Date</small>
                        <div class="fw-bold">${new Date(order.date).toLocaleDateString('en-GB')}</div>
                    </div>
                </div>
                <div class="row mb-4">
                    <div class="col-6">
                        <small class="text-muted">Unit</small>
                        <div class="fw-bold">${order.unit}</div>
                    </div>
                    <div class="col-6 text-end">
                        <small class="text-muted">Tax Week</small>
                        <div class="fw-bold">Week ${order.taxWeek}</div>
                    </div>
                </div>
                <hr style="border-color: var(--border-color);">
                <table class="table table-borderless mb-4">
                    <thead>
                        <tr class="text-muted">
                            <th>Item</th>
                            <th class="text-end">Qty</th>
                            <th class="text-end">Price</th>
                            <th class="text-end">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${order.items.map(item => `
                            <tr>
                                <td>${item.name}</td>
                                <td class="text-end">${item.qty} ${item.unit}</td>
                                <td class="text-end">${item.cost.toFixed(2)}</td>
                                <td class="text-end fw-bold">${(item.qty * item.cost).toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <hr style="border-color: var(--border-color);">
                <div class="row">
                    <div class="col-6 offset-6">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Subtotal</span>
                            <span class="fw-bold">${order.subtotal.toFixed(2)}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">VAT (20%)</span>
                            <span class="fw-bold">${order.vat.toFixed(2)}</span>
                        </div>
                        <div class="d-flex justify-content-between fs-5">
                            <span class="fw-bold">Total</span>
                            <span class="fw-bold" style="color: var(--success-color);">${order.total.toFixed(2)}</span>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-4">
                    <span class="status-pill status-pending">Pending Delivery</span>
                </div>
            </div>
            <div class="p-3 border-top" style="border-color: var(--border-color) !important; background: var(--bg-color);">
                <button onclick="printInvoice()" class="btn btn-primary w-100 fw-bold hover-lift" style="background: var(--gradient-primary); border: none;">
                    <i class="fas fa-print me-2"></i> Print Invoice
                </button>
            </div>
        `;
        
        new bootstrap.Modal(document.getElementById('invoiceModal')).show();
    }

    function printInvoice() {
        const printContent = document.getElementById('invoice-content').innerHTML;
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
            <head>
                <title>Invoice</title>
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
                <style>body { font-family: 'Inter', sans-serif; }</style>
            </head>
            <body class="p-4">${printContent}</body>
            </html>
        `);
        printWindow.document.close();
        printWindow.print();
    }

    // ==================== DELIVERY TRACKER ====================
    function renderDeliveryTracker() {
        const tbody = document.getElementById('delivery-tbody');
        const pendingOrders = orders.filter(o => o.status === 'pending' || o.status === 'out_for_delivery').slice(0, 10);
        
        document.getElementById('pending-count').textContent = pendingOrders.length + ' Pending';
        
        tbody.innerHTML = pendingOrders.map(order => `
            <tr>
                <td><span class="fw-bold">${order.unit}</span></td>
                <td>${order.invoiceNumber}</td>
                <td>${new Date(order.date).toLocaleDateString('en-GB')}</td>
                <td class="fw-bold">${order.total.toFixed(2)}</td>
                <td><span class="badge bg-primary">Week ${order.taxWeek}</span></td>
                <td>${getStatusBadge(order.status)}</td>
                <td>
                    ${currentUser?.role === 'admin' ? `
                        <select onchange="updateOrderStatus('${order.id}', this.value)" class="form-select form-select-sm" style="min-width: 150px;">
                            <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="out_for_delivery" ${order.status === 'out_for_delivery' ? 'selected' : ''}>Out for Delivery</option>
                            <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>Completed</option>
                        </select>
                    ` : getStatusBadge(order.status)}
                </td>
            </tr>
        `).join('') || '<tr><td colspan="7" class="text-center text-muted py-4">No pending orders</td></tr>';
    }

    function getStatusBadge(status) {
        const badges = {
            pending: '<span class="status-pill status-pending"><i class="fas fa-clock me-1"></i>Pending</span>',
            out_for_delivery: '<span class="status-pill status-delivered"><i class="fas fa-truck me-1"></i>Out for Delivery</span>',
            completed: '<span class="status-pill status-delivered"><i class="fas fa-check me-1"></i>Completed</span>'
        };
        return badges[status] || status;
    }

    function updateOrderStatus(orderId, newStatus) {
        const order = orders.find(o => o.id === orderId);
        if (order) {
            order.status = newStatus;
            if (newStatus === 'completed') {
                order.completedAt = new Date().toISOString();
            }
            saveAllData();
            renderDeliveryTracker();
            renderAllOrders();
            updateDashboardStats();
            showToast(`Order ${order.invoiceNumber} marked as ${newStatus.replace(/_/g, ' ')}`, 'success');
            logActivity('order', `Order ${order.invoiceNumber} status updated to ${newStatus}`);
        }
    }

    // ==================== ALL ORDERS ====================
    function populateOrderWeekFilter() {
        const select = document.getElementById('order-week-filter');
        for (let i = 1; i <= 52; i++) {
            select.innerHTML += `<option value="${i}">Week ${i}</option>`;
        }
    }

    function renderAllOrders() {
        const weekFilter = document.getElementById('order-week-filter').value;
        const restaurantFilter = document.getElementById('order-restaurant-filter').value;
        const statusFilter = document.getElementById('order-status-filter').value;
        
        let filtered = [...orders];
        if (weekFilter !== 'all') filtered = filtered.filter(o => o.taxWeek === parseInt(weekFilter));
        if (restaurantFilter !== 'all') filtered = filtered.filter(o => o.unit === restaurantFilter);
        if (statusFilter !== 'all') filtered = filtered.filter(o => o.status === statusFilter);
        
        // Sort by date (newest first)
        filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        const tbody = document.getElementById('all-orders-body');
        tbody.innerHTML = filtered.map(order => `
            <tr>
                <td class="fw-bold">${order.invoiceNumber}</td>
                <td>${new Date(order.date).toLocaleDateString('en-GB')}</td>
                <td><span class="badge bg-info">${order.unit}</span></td>
                <td>${order.items.length} items</td>
                <td class="fw-bold">${order.total.toFixed(2)}</td>
                <td><span class="badge bg-primary">Week ${order.taxWeek}</span></td>
                <td>${getStatusBadge(order.status)}</td>
                <td>
                    <select onchange="updateOrderStatus('${order.id}', this.value)" class="form-select form-select-sm" style="min-width: 120px;">
                        <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                        <option value="out_for_delivery" ${order.status === 'out_for_delivery' ? 'selected' : ''}>Out for Delivery</option>
                        <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>Completed</option>
                    </select>
                </td>
            </tr>
        `).join('') || '<tr><td colspan="8" class="text-center text-muted py-4">No orders found</td></tr>';
        
        // Calculate total expenditure
        const totalExpenditure = filtered.reduce((sum, o) => sum + o.total, 0);
        document.getElementById('total-expenditure').textContent = '' + totalExpenditure.toFixed(2);
        
        // Update expenditure summary cards
        updateExpenditureSummary(filtered);
    }

    function updateExpenditureSummary(filteredOrders) {
        const container = document.getElementById('expenditure-summary');
        const byUnit = {};
        const byWeek = {};
        
        filteredOrders.forEach(order => {
            if (!byUnit[order.unit]) byUnit[order.unit] = 0;
            byUnit[order.unit] += order.total;
            
            if (!byWeek[order.taxWeek]) byWeek[order.taxWeek] = 0;
            byWeek[order.taxWeek] += order.total;
        });
        
        let html = '';
        
        // Unit breakdown
        html += '<div class="col-md-6"><div class="card border-0 shadow-sm glass-card" style="border-radius: 16px;"><div class="card-header bg-transparent py-3" style="border-bottom: 1px solid var(--border-color);"><h6 class="fw-bold mb-0">Expenditure by Unit</h6></div><div class="card-body">';
        for (const [unit, total] of Object.entries(byUnit).sort((a, b) => b[1] - a[1])) {
            html += `<div class="d-flex justify-content-between align-items-center mb-2"><span>${unit}</span><span class="fw-bold">${total.toFixed(2)}</span></div>`;
        }
        html += '</div></div></div>';
        
        // Week breakdown (top 5)
        html += '<div class="col-md-6"><div class="card border-0 shadow-sm glass-card" style="border-radius: 16px;"><div class="card-header bg-transparent py-3" style="border-bottom: 1px solid var(--border-color);"><h6 class="fw-bold mb-0">Top Spending Weeks</h6></div><div class="card-body">';
        const sortedWeeks = Object.entries(byWeek).sort((a, b) => b[1] - a[1]).slice(0, 5);
        for (const [week, total] of sortedWeeks) {
            html += `<div class="d-flex justify-content-between align-items-center mb-2"><span>Week ${week}</span><span class="fw-bold">${total.toFixed(2)}</span></div>`;
        }
        html += '</div></div></div>';
        
        container.innerHTML = html;
    }

    // ==================== ORDER HISTORY (RESTAURANT VIEW) ====================
    function renderOrderHistory() {
        const myOrders = orders.filter(o => o.unit === currentUser.unit).sort((a, b) => new Date(b.date) - new Date(a.date));
        
        // Group by tax week
        const byWeek = {};
        myOrders.forEach(order => {
            if (!byWeek[order.taxWeek]) byWeek[order.taxWeek] = [];
            byWeek[order.taxWeek].push(order);
        });
        
        // Update badges
        document.getElementById('total-weeks-badge').textContent = Object.keys(byWeek).length + ' Weeks';
        const totalSpent = myOrders.reduce((sum, o) => sum + o.total, 0);
        document.getElementById('total-spent-badge').textContent = '' + totalSpent.toFixed(2) + ' Total';
        
        // Render weekly spending cards
        const cardsContainer = document.getElementById('weekly-spending-cards');
        const sortedWeeks = Object.entries(byWeek).sort((a, b) => b[0] - a[0]);
        
        cardsContainer.innerHTML = sortedWeeks.map(([week, weekOrders]) => {
            const weekTotal = weekOrders.reduce((sum, o) => sum + o.total, 0);
            const isCurrentWeek = parseInt(week) === currentTaxWeek;
            return `
                <div class="col-md-4 col-lg-3">
                    <div class="card week-spending-card p-3 ${isCurrentWeek ? 'current-week' : ''} hover-lift" style="border-radius: 16px; background: var(--card-bg);">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="fw-bold">Tax Week ${week}</span>
                            ${isCurrentWeek ? '<span class="badge bg-warning text-dark">Current</span>' : ''}
                        </div>
                        <h4 class="fw-bold mb-1" style="color: var(--success-color);">${weekTotal.toFixed(2)}</h4>
                        <small class="text-muted">${weekOrders.length} orders</small>
                    </div>
                </div>
            `;
        }).join('') || '<div class="col-12 text-center text-muted py-4">No orders yet</div>';
        
        // Render individual orders
        const ordersContainer = document.getElementById('rest-orders-list');
        ordersContainer.innerHTML = myOrders.map(order => `
            <div class="p-3 border-bottom" style="border-color: var(--border-color) !important; cursor: pointer;" onclick="showInvoiceById('${order.id}')">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-bold">${order.invoiceNumber}</div>
                        <small class="text-muted">${new Date(order.date).toLocaleDateString('en-GB')} | ${order.items.length} items</small>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold">${order.total.toFixed(2)}</div>
                        ${getStatusBadge(order.status)}
                    </div>
                </div>
            </div>
        `).join('') || '<div class="text-center text-muted py-4">No orders yet</div>';
    }

    function showInvoiceById(orderId) {
        const order = orders.find(o => o.id === orderId);
        if (order) showInvoice(order);
    }

    // ==================== RESTAURANT STOCK VIEW ====================
    function renderRestStock() {
        const container = document.getElementById('rest-stock-container');
        
        // Group by category
        const grouped = inventory.reduce((acc, product) => {
            if (!acc[product.category]) acc[product.category] = [];
            acc[product.category].push(product);
            return acc;
        }, {});
        
        let html = '<div class="row">';
        for (const [category, products] of Object.entries(grouped)) {
            html += `
                <div class="col-md-6 mb-4">
                    <div class="card border-0 shadow-sm glass-card" style="border-radius: 16px;">
                        <div class="card-header bg-transparent py-3" style="border-bottom: 1px solid var(--border-color);">
                            <h6 class="fw-bold mb-0 text-uppercase" style="font-size: 0.85rem; letter-spacing: 1px;">${category}</h6>
                        </div>
                        <div class="card-body">
                            ${products.map(product => {
                                const isLow = product.stock <= product.minStock;
                                const isOut = product.stock === 0;
                                return `
                                    <div class="d-flex justify-content-between align-items-center mb-3 p-2 rounded-3 ${isLow ? 'bg-danger bg-opacity-10' : ''}">
                                        <div>
                                            <div class="fw-bold ${isOut ? 'text-decoration-line-through text-muted' : ''}">${product.name}</div>
                                            <small class="text-muted">${product.unit}</small>
                                        </div>
                                        <div class="text-end">
                                            <span class="fw-bold ${isLow ? 'text-danger' : ''}">${product.stock}</span>
                                            <small class="text-muted">/ ${product.minStock} min</small>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        html += '</div>';
        
        container.innerHTML = html;
    }

    // ==================== ANALYTICS ====================
    function switchAnalyticsTab(tab) {
        document.querySelectorAll('#analyticsTabs .nav-link').forEach(l => l.classList.remove('active'));
        document.getElementById(tab + '-tab-btn').classList.add('active');
        
        document.querySelectorAll('.analytics-tab-content').forEach(c => c.classList.add('hidden'));
        document.getElementById(tab + '-analytics-content').classList.remove('hidden');
        
        if (tab === 'meat') renderMeatAnalysis();
        if (tab === 'buyers') renderBuyersAnalysis();
    }

    // ==================== MENU COST ====================
    function switchMenuCostTab(tab) {
        document.querySelectorAll('#menuCostTabs .nav-link').forEach(l => l.classList.remove('active'));
        document.getElementById(tab + '-tab-btn').classList.add('active');
        
        document.querySelectorAll('.menu-cost-tab-content').forEach(c => c.classList.add('hidden'));
        document.getElementById(tab + '-content').classList.remove('hidden');
        
        if (tab === 'ingredients') renderIngredientsList();
        if (tab === 'recipe') renderRecipesList();
        if (tab === 'menu-cost') renderMenuEngineeringMatrix();
    }

    // ==================== MENU COST FUNCTIONS ====================
    
    // Menu Cost Data Storage
    let menuCostIngredients = JSON.parse(localStorage.getItem('menuCostIngredients')) || [];
    let menuCostRecipes = JSON.parse(localStorage.getItem('menuCostRecipes')) || [];
    let abTests = JSON.parse(localStorage.getItem('abTests')) || [];
    let currentRecipeIngredients = [];

    // ==================== CSV IMPORT FUNCTIONS ====================
    
    // CSV Template download for ingredients
    function downloadIngredientCSVTemplate() {
        const headers = ['name', 'category', 'unit', 'cost', 'wastage', 'supplier', 'allergens'];
        const sampleData = [
            ['Chicken Breast', 'meat', 'kg', '6.80', '5', 'Sysco', ''],
            ['Salmon Fillet', 'meat', 'kg', '14.20', '3', 'Brakes', 'fish'],
            ['Mozzarella', 'dairy', 'kg', '7.50', '2', 'Bidfood', 'dairy'],
            ['Mixed Salad', 'produce', 'kg', '2.50', '8', 'Local Farm', ''],
            ['Flour', 'dry', 'kg', '1.20', '0', 'Sysco', 'gluten']
        ];
        
        let csv = headers.join(',') + '\n';
        sampleData.forEach(row => {
            csv += row.join(',') + '\n';
        });
        
        downloadCSV(csv, 'ingredients_template.csv');
        showToast('Ingredient CSV template downloaded', 'success');
    }
    
    // CSV Template download for recipes
    function downloadRecipeCSVTemplate() {
        const headers = ['recipe_name', 'category', 'portions', 'ingredient_name', 'ingredient_qty', 'labor_cost', 'target_gp'];
        const sampleData = [
            ['Grilled Salmon', 'main', '1', 'Salmon Fillet', '0.2', '2.50', '70'],
            ['Grilled Salmon', 'main', '1', 'Mixed Salad', '0.1', '2.50', '70'],
            ['Grilled Salmon', 'main', '1', 'Olive Oil', '0.02', '2.50', '70'],
            ['Chicken Curry', 'main', '1', 'Chicken Breast', '0.25', '3.00', '68'],
            ['Chicken Curry', 'main', '1', 'Curry Paste', '0.05', '3.00', '68']
        ];
        
        let csv = headers.join(',') + '\n';
        sampleData.forEach(row => {
            csv += row.join(',') + '\n';
        });
        
        downloadCSV(csv, 'recipes_template.csv');
        showToast('Recipe CSV template downloaded', 'success');
    }
    
    // Helper function to download CSV
    function downloadCSV(csvContent, filename) {
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    // Parse CSV content
    function parseCSV(csvText) {
        const lines = csvText.trim().split('\n');
        const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/"/g, ''));
        const results = [];
        
        for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            
            // Handle quoted values with commas
            const values = [];
            let current = '';
            let inQuotes = false;
            
            for (let char of line) {
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    values.push(current.trim().replace(/"/g, ''));
                    current = '';
                } else {
                    current += char;
                }
            }
            values.push(current.trim().replace(/"/g, ''));
            
            const row = {};
            headers.forEach((header, index) => {
                row[header] = values[index] || '';
            });
            results.push(row);
        }
        
        return results;
    }
    
    // Import ingredients from CSV
    function importIngredientsCSV(input) {
        const file = input.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const csvData = parseCSV(e.target.result);
                let imported = 0;
                let skipped = 0;
                
                csvData.forEach(row => {
                    const name = row.name || row.ingredient || row.product;
                    const category = row.category || row.type || 'other';
                    const unit = row.unit || row.uom || 'pcs';
                    const cost = parseFloat(row.cost || row.price || row.unit_cost) || 0;
                    const wastage = parseFloat(row.wastage || row.waste || row.loss) || 0;
                    const supplier = row.supplier || row.vendor || '';
                    
                    // Parse allergens
                    let allergens = [];
                    const allergenField = row.allergens || row.allergen || '';
                    if (allergenField) {
                        allergens = allergenField.split(/[,;]/).map(a => a.trim().toLowerCase()).filter(a => a);
                    }
                    
                    if (!name || cost <= 0) {
                        skipped++;
                        return;
                    }
                    
                    // Check if ingredient already exists
                    const existing = menuCostIngredients.find(i => i.name.toLowerCase() === name.toLowerCase());
                    if (existing) {
                        // Update existing
                        existing.category = category;
                        existing.unit = unit;
                        existing.cost = cost;
                        existing.wastage = wastage;
                        existing.effectiveCost = cost / (1 - (wastage / 100));
                        existing.supplier = supplier;
                        existing.allergens = allergens;
                    } else {
                        // Add new
                        menuCostIngredients.push({
                            id: Date.now() + Math.random(),
                            name,
                            category,
                            unit,
                            cost,
                            wastage,
                            effectiveCost: cost / (1 - (wastage / 100)),
                            supplier,
                            allergens,
                            createdAt: new Date().toISOString()
                        });
                    }
                    imported++;
                });
                
                localStorage.setItem('menuCostIngredients', JSON.stringify(menuCostIngredients));
                renderIngredientsList();
                updateMenuCostStats();
                
                showToast(`Imported ${imported} ingredients, skipped ${skipped}`, imported > 0 ? 'success' : 'warning');
                
            } catch (error) {
                showToast('Error parsing CSV: ' + error.message, 'error');
                console.error('CSV Import Error:', error);
            }
            
            // Reset input
            input.value = '';
        };
        
        reader.readAsText(file);
    }
    
    // Import recipes from CSV
    function importRecipesCSV(input) {
        const file = input.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const csvData = parseCSV(e.target.result);
                
                // Group by recipe name
                const recipeGroups = {};
                csvData.forEach(row => {
                    const recipeName = row.recipe_name || row.recipe || row.name;
                    if (!recipeName) return;
                    
                    if (!recipeGroups[recipeName]) {
                        recipeGroups[recipeName] = {
                            name: recipeName,
                            category: row.category || 'main',
                            portions: parseInt(row.portions) || 1,
                            laborCost: parseFloat(row.labor_cost || row.labor) || 0,
                            targetGP: parseFloat(row.target_gp || row.gp || row.target) || 70,
                            ingredients: []
                        };
                    }
                    
                    const ingredientName = row.ingredient_name || row.ingredient;
                    const ingredientQty = parseFloat(row.ingredient_qty || row.qty || row.quantity) || 0;
                    
                    if (ingredientName && ingredientQty > 0) {
                        recipeGroups[recipeName].ingredients.push({
                            name: ingredientName,
                            qty: ingredientQty
                        });
                    }
                });
                
                let imported = 0;
                let skipped = 0;
                
                Object.values(recipeGroups).forEach(recipeData => {
                    if (recipeData.ingredients.length === 0) {
                        skipped++;
                        return;
                    }
                    
                    // Match ingredients from database
                    const matchedIngredients = [];
                    let totalIngredientCost = 0;
                    let totalWastageCost = 0;
                    
                    recipeData.ingredients.forEach(ing => {
                        const dbIngredient = menuCostIngredients.find(i => 
                            i.name.toLowerCase().includes(ing.name.toLowerCase()) ||
                            ing.name.toLowerCase().includes(i.name.toLowerCase())
                        );
                        
                        if (dbIngredient) {
                            const lineCost = dbIngredient.effectiveCost * ing.qty;
                            const wastageCost = lineCost * (dbIngredient.wastage / 100);
                            matchedIngredients.push({
                                ...dbIngredient,
                                qty: ing.qty,
                                lineCost: lineCost
                            });
                            totalIngredientCost += lineCost;
                            totalWastageCost += wastageCost;
                        }
                    });
                    
                    if (matchedIngredients.length === 0) {
                        skipped++;
                        return;
                    }
                    
                    const totalCost = totalIngredientCost + totalWastageCost + recipeData.laborCost;
                    const costPerPortion = totalCost / recipeData.portions;
                    const sellPrice = costPerPortion / (1 - (recipeData.targetGP / 100));
                    const projectedGP = ((sellPrice - costPerPortion) / sellPrice * 100).toFixed(1);
                    
                    // Check if recipe exists
                    const existing = menuCostRecipes.find(r => r.name.toLowerCase() === recipeData.name.toLowerCase());
                    
                    const recipe = {
                        id: existing ? existing.id : Date.now() + Math.random(),
                        name: recipeData.name,
                        category: recipeData.category,
                        portions: recipeData.portions,
                        ingredients: matchedIngredients,
                        ingredientCost: totalIngredientCost,
                        wastageCost: totalWastageCost,
                        laborCost: recipeData.laborCost,
                        totalCost: totalCost,
                        costPerPortion: costPerPortion,
                        sellPrice: sellPrice,
                        projectedGP: projectedGP,
                        version: existing ? (existing.version + 1) : 1,
                        createdAt: existing ? existing.createdAt : new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    if (existing) {
                        const index = menuCostRecipes.findIndex(r => r.id === existing.id);
                        menuCostRecipes[index] = recipe;
                    } else {
                        menuCostRecipes.push(recipe);
                    }
                    imported++;
                });
                
                localStorage.setItem('menuCostRecipes', JSON.stringify(menuCostRecipes));
                renderRecipesList();
                updateMenuCostStats();
                
                showToast(`Imported ${imported} recipes, skipped ${skipped}`, imported > 0 ? 'success' : 'warning');
                
            } catch (error) {
                showToast('Error parsing CSV: ' + error.message, 'error');
                console.error('CSV Import Error:', error);
            }
            
            // Reset input
            input.value = '';
        };
        
        reader.readAsText(file);
    }

    // ==================== BULK IMPORT WITH PREVIEW (LIKE STOCK) ====================
    
    let ingredientCSVPreviewData = [];
    let recipeCSVPreviewData = [];
    
    function openIngredientBulkImportModal() {
        ingredientCSVPreviewData = [];
        document.getElementById('ingredient-csv-upload').value = '';
        document.getElementById('ingredient-csv-preview-container').classList.add('hidden');
        document.getElementById('import-ingredients-btn').disabled = true;
        document.getElementById('ingredient-csv-import-status').innerHTML = '';
        const modal = new bootstrap.Modal(document.getElementById('ingredientBulkImportModal'));
        modal.show();
    }
    
    function openRecipeBulkImportModal() {
        recipeCSVPreviewData = [];
        document.getElementById('recipe-csv-upload').value = '';
        document.getElementById('recipe-csv-preview-container').classList.add('hidden');
        document.getElementById('import-recipes-btn').disabled = true;
        document.getElementById('recipe-csv-import-status').innerHTML = '';
        const modal = new bootstrap.Modal(document.getElementById('recipeBulkImportModal'));
        modal.show();
    }
    
    function previewIngredientCSV() {
        const fileInput = document.getElementById('ingredient-csv-upload');
        const file = fileInput.files[0];
        
        if (!file) {
            document.getElementById('ingredient-csv-preview-container').classList.add('hidden');
            document.getElementById('import-ingredients-btn').disabled = true;
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                ingredientCSVPreviewData = parseCSV(e.target.result);
                
                if (ingredientCSVPreviewData.length === 0) {
                    document.getElementById('ingredient-csv-import-status').innerHTML = 
                        '<div class="alert alert-warning">No valid data found in CSV file.</div>';
                    document.getElementById('ingredient-csv-preview-container').classList.add('hidden');
                    document.getElementById('import-ingredients-btn').disabled = true;
                    return;
                }
                
                // Validate required columns
                const firstRow = ingredientCSVPreviewData[0];
                if (!firstRow.name && !firstRow.ingredient && !firstRow.product) {
                    document.getElementById('ingredient-csv-import-status').innerHTML = 
                        '<div class="alert alert-danger">CSV must have a "name" column. Please check the template.</div>';
                    document.getElementById('import-ingredients-btn').disabled = true;
                    return;
                }
                
                // Show preview
                document.getElementById('ingredient-csv-row-count').textContent = ingredientCSVPreviewData.length;
                
                const tbody = document.getElementById('ingredient-csv-preview-body');
                tbody.innerHTML = ingredientCSVPreviewData.slice(0, 10).map(row => {
                    const name = row.name || row.ingredient || row.product || '-';
                    const category = row.category || row.type || 'other';
                    const unit = row.unit || row.uom || 'pcs';
                    const cost = parseFloat(row.cost || row.price || row.unit_cost) || 0;
                    const wastage = parseFloat(row.wastage || row.waste || row.loss) || 0;
                    const allergens = row.allergens || row.allergen || '-';
                    return `
                        <tr>
                            <td>${name}</td>
                            <td>${category}</td>
                            <td>${unit}</td>
                            <td>${cost.toFixed(2)}</td>
                            <td>${wastage}%</td>
                            <td>${allergens}</td>
                        </tr>
                    `;
                }).join('');
                
                if (ingredientCSVPreviewData.length > 10) {
                    tbody.innerHTML += `<tr><td colspan="6" class="text-center text-muted">... and ${ingredientCSVPreviewData.length - 10} more</td></tr>`;
                }
                
                document.getElementById('ingredient-csv-preview-container').classList.remove('hidden');
                document.getElementById('import-ingredients-btn').disabled = false;
                document.getElementById('ingredient-csv-import-status').innerHTML = 
                    `<div class="alert alert-success">Ready to import ${ingredientCSVPreviewData.length} ingredients.</div>`;
                
            } catch (error) {
                document.getElementById('ingredient-csv-import-status').innerHTML = 
                    `<div class="alert alert-danger">Error reading CSV: ${error.message}</div>`;
                document.getElementById('import-ingredients-btn').disabled = true;
            }
        };
        
        reader.readAsText(file);
    }
    
    function previewRecipeCSV() {
        const fileInput = document.getElementById('recipe-csv-upload');
        const file = fileInput.files[0];
        
        if (!file) {
            document.getElementById('recipe-csv-preview-container').classList.add('hidden');
            document.getElementById('import-recipes-btn').disabled = true;
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const csvData = parseCSV(e.target.result);
                
                if (csvData.length === 0) {
                    document.getElementById('recipe-csv-import-status').innerHTML = 
                        '<div class="alert alert-warning">No valid data found in CSV file.</div>';
                    document.getElementById('recipe-csv-preview-container').classList.add('hidden');
                    document.getElementById('import-recipes-btn').disabled = true;
                    return;
                }
                
                // Group by recipe name
                const recipeGroups = {};
                csvData.forEach(row => {
                    const recipeName = row.recipe_name || row.recipe || row.name;
                    if (!recipeName) return;
                    
                    if (!recipeGroups[recipeName]) {
                        recipeGroups[recipeName] = {
                            name: recipeName,
                            category: row.category || 'main',
                            portions: parseInt(row.portions) || 1,
                            laborCost: parseFloat(row.labor_cost || row.labor) || 0,
                            targetGP: parseFloat(row.target_gp || row.gp || row.target) || 70,
                            ingredients: []
                        };
                    }
                    
                    const ingredientName = row.ingredient_name || row.ingredient;
                    const ingredientQty = parseFloat(row.ingredient_qty || row.qty || row.quantity) || 0;
                    
                    if (ingredientName && ingredientQty > 0) {
                        recipeGroups[recipeName].ingredients.push({
                            name: ingredientName,
                            qty: ingredientQty
                        });
                    }
                });
                
                recipeCSVPreviewData = Object.values(recipeGroups);
                
                if (recipeCSVPreviewData.length === 0) {
                    document.getElementById('recipe-csv-import-status').innerHTML = 
                        '<div class="alert alert-warning">No valid recipes found in CSV file.</div>';
                    document.getElementById('recipe-csv-preview-container').classList.add('hidden');
                    document.getElementById('import-recipes-btn').disabled = true;
                    return;
                }
                
                // Show preview
                document.getElementById('recipe-csv-row-count').textContent = recipeCSVPreviewData.length;
                
                const tbody = document.getElementById('recipe-csv-preview-body');
                tbody.innerHTML = recipeCSVPreviewData.slice(0, 10).map(recipe => {
                    const ingredientCount = recipe.ingredients.length;
                    const matchedCount = recipe.ingredients.filter(ing => {
                        return menuCostIngredients.some(dbIng => 
                            dbIng.name.toLowerCase().includes(ing.name.toLowerCase()) ||
                            ing.name.toLowerCase().includes(dbIng.name.toLowerCase())
                        );
                    }).length;
                    const matchClass = matchedCount === ingredientCount ? 'text-success' : (matchedCount > 0 ? 'text-warning' : 'text-danger');
                    
                    return `
                        <tr>
                            <td>${recipe.name}</td>
                            <td>${recipe.category}</td>
                            <td>${recipe.portions}</td>
                            <td class="${matchClass}">${matchedCount}/${ingredientCount} matched</td>
                            <td>${recipe.laborCost.toFixed(2)}</td>
                            <td>${recipe.targetGP}%</td>
                        </tr>
                    `;
                }).join('');
                
                if (recipeCSVPreviewData.length > 10) {
                    tbody.innerHTML += `<tr><td colspan="6" class="text-center text-muted">... and ${recipeCSVPreviewData.length - 10} more</td></tr>`;
                }
                
                document.getElementById('recipe-csv-preview-container').classList.remove('hidden');
                document.getElementById('import-recipes-btn').disabled = false;
                document.getElementById('recipe-csv-import-status').innerHTML = 
                    `<div class="alert alert-success">Ready to import ${recipeCSVPreviewData.length} recipes.</div>`;
                
            } catch (error) {
                document.getElementById('recipe-csv-import-status').innerHTML = 
                    `<div class="alert alert-danger">Error reading CSV: ${error.message}</div>`;
                document.getElementById('import-recipes-btn').disabled = true;
            }
        };
        
        reader.readAsText(file);
    }
    
    function importIngredientsFromPreview() {
        if (ingredientCSVPreviewData.length === 0) return;
        
        let imported = 0;
        let skipped = 0;
        
        ingredientCSVPreviewData.forEach(row => {
            const name = row.name || row.ingredient || row.product;
            const category = row.category || row.type || 'other';
            const unit = row.unit || row.uom || 'pcs';
            const cost = parseFloat(row.cost || row.price || row.unit_cost) || 0;
            const wastage = parseFloat(row.wastage || row.waste || row.loss) || 0;
            const supplier = row.supplier || row.vendor || '';
            
            let allergens = [];
            const allergenField = row.allergens || row.allergen || '';
            if (allergenField) {
                allergens = allergenField.split(/[,;]/).map(a => a.trim().toLowerCase()).filter(a => a);
            }
            
            if (!name || cost <= 0) {
                skipped++;
                return;
            }
            
            const existing = menuCostIngredients.find(i => i.name.toLowerCase() === name.toLowerCase());
            if (existing) {
                existing.category = category;
                existing.unit = unit;
                existing.cost = cost;
                existing.wastage = wastage;
                existing.effectiveCost = cost / (1 - (wastage / 100));
                existing.supplier = supplier;
                existing.allergens = allergens;
            } else {
                menuCostIngredients.push({
                    id: Date.now() + Math.random(),
                    name,
                    category,
                    unit,
                    cost,
                    wastage,
                    effectiveCost: cost / (1 - (wastage / 100)),
                    supplier,
                    allergens,
                    createdAt: new Date().toISOString()
                });
            }
            imported++;
        });
        
        localStorage.setItem('menuCostIngredients', JSON.stringify(menuCostIngredients));
        renderIngredientsList();
        updateMenuCostStats();
        
        showToast(`Imported ${imported} ingredients, skipped ${skipped}`, imported > 0 ? 'success' : 'warning');
        
        bootstrap.Modal.getInstance(document.getElementById('ingredientBulkImportModal')).hide();
    }
    
    function importRecipesFromPreview() {
        if (recipeCSVPreviewData.length === 0) return;
        
        let imported = 0;
        let skipped = 0;
        
        recipeCSVPreviewData.forEach(recipeData => {
            if (recipeData.ingredients.length === 0) {
                skipped++;
                return;
            }
            
            const matchedIngredients = [];
            let totalIngredientCost = 0;
            let totalWastageCost = 0;
            
            recipeData.ingredients.forEach(ing => {
                const dbIngredient = menuCostIngredients.find(i => 
                    i.name.toLowerCase().includes(ing.name.toLowerCase()) ||
                    ing.name.toLowerCase().includes(i.name.toLowerCase())
                );
                
                if (dbIngredient) {
                    const lineCost = dbIngredient.effectiveCost * ing.qty;
                    const wastageCost = lineCost * (dbIngredient.wastage / 100);
                    matchedIngredients.push({
                        ...dbIngredient,
                        qty: ing.qty,
                        lineCost: lineCost
                    });
                    totalIngredientCost += lineCost;
                    totalWastageCost += wastageCost;
                }
            });
            
            if (matchedIngredients.length === 0) {
                skipped++;
                return;
            }
            
            const totalCost = totalIngredientCost + totalWastageCost + recipeData.laborCost;
            const costPerPortion = totalCost / recipeData.portions;
            const sellPrice = costPerPortion / (1 - (recipeData.targetGP / 100));
            const projectedGP = ((sellPrice - costPerPortion) / sellPrice * 100).toFixed(1);
            
            const existing = menuCostRecipes.find(r => r.name.toLowerCase() === recipeData.name.toLowerCase());
            
            const recipe = {
                id: existing ? existing.id : Date.now() + Math.random(),
                name: recipeData.name,
                category: recipeData.category,
                portions: recipeData.portions,
                ingredients: matchedIngredients,
                ingredientCost: totalIngredientCost,
                wastageCost: totalWastageCost,
                laborCost: recipeData.laborCost,
                totalCost: totalCost,
                costPerPortion: costPerPortion,
                sellPrice: sellPrice,
                projectedGP: projectedGP,
                version: existing ? (existing.version + 1) : 1,
                createdAt: existing ? existing.createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            if (existing) {
                const index = menuCostRecipes.findIndex(r => r.id === existing.id);
                menuCostRecipes[index] = recipe;
            } else {
                menuCostRecipes.push(recipe);
            }
            imported++;
        });
        
        localStorage.setItem('menuCostRecipes', JSON.stringify(menuCostRecipes));
        renderRecipesList();
        updateMenuCostStats();
        
        showToast(`Imported ${imported} recipes, skipped ${skipped}`, imported > 0 ? 'success' : 'warning');
        
        bootstrap.Modal.getInstance(document.getElementById('recipeBulkImportModal')).hide();
    }

    function openAddIngredientModal() {
        const modal = new bootstrap.Modal(document.getElementById('addIngredientModal'));
        modal.show();
    }

    function getSelectedAllergens() {
        const allergenList = ['gluten', 'dairy', 'eggs', 'fish', 'shellfish', 'nuts', 'peanuts', 'soya', 'sesame', 'sulphites', 'mustard', 'celery', 'lupin', 'molluscs'];
        return allergenList.filter(a => document.getElementById(`allergen-${a}`)?.checked);
    }

    function setSelectedAllergens(allergens) {
        const allergenList = ['gluten', 'dairy', 'eggs', 'fish', 'shellfish', 'nuts', 'peanuts', 'soya', 'sesame', 'sulphites', 'mustard', 'celery', 'lupin', 'molluscs'];
        allergenList.forEach(a => {
            const checkbox = document.getElementById(`allergen-${a}`);
            if (checkbox) checkbox.checked = allergens && allergens.includes(a);
        });
    }

    function saveIngredient() {
        const name = document.getElementById('ingredient-name').value;
        const category = document.getElementById('ingredient-category').value;
        const unit = document.getElementById('ingredient-unit').value;
        const cost = parseFloat(document.getElementById('ingredient-cost').value) || 0;
        const wastage = parseFloat(document.getElementById('ingredient-wastage').value) || 0;
        const supplier = document.getElementById('ingredient-supplier').value;
        const allergens = getSelectedAllergens();
        const editId = document.getElementById('addIngredientForm').dataset.editId;

        if (!name || !unit || cost <= 0) {
            showToast('Please fill in all required fields', 'error');
            return;
        }

        const effectiveCost = cost / (1 - (wastage / 100));
        
        if (editId) {
            // Update existing ingredient
            const index = menuCostIngredients.findIndex(i => i.id == editId);
            if (index !== -1) {
                menuCostIngredients[index] = {
                    ...menuCostIngredients[index],
                    name,
                    category,
                    unit,
                    cost,
                    allergens,
                    wastage,
                    effectiveCost,
                    supplier,
                    updatedAt: new Date().toISOString()
                };
                showToast('Ingredient updated successfully!', 'success');
            }
            delete document.getElementById('addIngredientForm').dataset.editId;
        } else {
            // Create new ingredient
            const ingredient = {
                id: Date.now(),
                name,
                category,
                unit,
                cost,
                wastage,
                effectiveCost,
                supplier,
                allergens,
                createdAt: new Date().toISOString()
            };
            menuCostIngredients.push(ingredient);
            showToast('Ingredient saved successfully!', 'success');
        }

        localStorage.setItem('menuCostIngredients', JSON.stringify(menuCostIngredients));
        
        bootstrap.Modal.getInstance(document.getElementById('addIngredientModal')).hide();
        document.getElementById('addIngredientForm').reset();
        
        renderIngredientsList();
        updateMenuCostStats();
    }

    function renderIngredientsList() {
        const tbody = document.getElementById('ingredients-table-body');
        
        if (menuCostIngredients.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-5 text-muted">
                        <i class="fas fa-carrot fa-3x mb-3 opacity-25"></i>
                        <p>No ingredients added yet</p>
                        <button class="btn btn-primary fw-bold" onclick="openAddIngredientModal()" style="background: var(--gradient-primary); border: none;"><i class="fas fa-plus me-2"></i> Add First Ingredient</button>
                    </td>
                </tr>`;
            return;
        }

        tbody.innerHTML = menuCostIngredients.map(ing => {
            const trend = Math.random() > 0.5 ? 'up' : 'down';
            const trendColor = trend === 'up' ? 'text-danger' : 'text-success';
            const trendIcon = trend === 'up' ? 'fa-arrow-up' : 'fa-arrow-down';
            
            // Format allergens
            let allergenBadges = '';
            if (ing.allergens && ing.allergens.length > 0) {
                allergenBadges = ing.allergens.map(a => {
                    const allergenIcons = {
                        'gluten': 'fa-bread-slice',
                        'dairy': 'fa-cheese',
                        'eggs': 'fa-egg',
                        'fish': 'fa-fish',
                        'shellfish': 'fa-shrimp',
                        'nuts': 'fa-seedling',
                        'peanuts': 'fa-leaf',
                        'soya': 'fa-bean',
                        'sesame': 'fa-circle',
                        'sulphites': 'fa-wine-bottle',
                        'mustard': 'fa-pepper-hot',
                        'celery': 'fa-carrot',
                        'lupin': 'fa-spa',
                        'molluscs': 'fa-water'
                    };
                    const icon = allergenIcons[a] || 'fa-exclamation-circle';
                    return `<span class="badge bg-warning text-dark me-1" title="${a}"><i class="fas ${icon}"></i></span>`;
                }).join('');
            } else {
                allergenBadges = '<span class="text-muted">-</span>';
            }
            
            return `
                <tr>
                    <td class="ps-4 fw-semibold">${ing.name}</td>
                    <td><span class="badge bg-light text-dark">${ing.category}</span></td>
                    <td class="text-center">${allergenBadges}</td>
                    <td class="text-end">${ing.cost.toFixed(2)} / ${ing.unit}</td>
                    <td class="text-end">${ing.wastage}%</td>
                    <td class="text-end fw-bold" style="color: var(--accent-color);">${ing.effectiveCost.toFixed(2)}</td>
                    <td class="text-center"><i class="fas ${trendIcon} ${trendColor}"></i></td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-primary" onclick="editIngredient(${ing.id})"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline-danger ms-1" onclick="deleteIngredient(${ing.id})"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function deleteIngredient(id) {
        if (!confirm('Delete this ingredient?')) return;
        menuCostIngredients = menuCostIngredients.filter(i => i.id !== id);
        localStorage.setItem('menuCostIngredients', JSON.stringify(menuCostIngredients));
        renderIngredientsList();
        updateMenuCostStats();
        showToast('Ingredient deleted', 'success');
    }

    function editIngredient(id) {
        const ingredient = menuCostIngredients.find(i => i.id === id);
        if (!ingredient) return;
        
        document.getElementById('ingredient-name').value = ingredient.name;
        document.getElementById('ingredient-category').value = ingredient.category;
        document.getElementById('ingredient-unit').value = ingredient.unit;
        document.getElementById('ingredient-cost').value = ingredient.cost;
        document.getElementById('ingredient-wastage').value = ingredient.wastage;
        document.getElementById('ingredient-supplier').value = ingredient.supplier || '';
        
        // Set allergen checkboxes
        setSelectedAllergens(ingredient.allergens || []);
        
        // Store the ID being edited
        document.getElementById('addIngredientForm').dataset.editId = id;
        
        const modal = new bootstrap.Modal(document.getElementById('addIngredientModal'));
        modal.show();
    }

    function viewRecipe(id) {
        const recipe = menuCostRecipes.find(r => r.id === id);
        if (!recipe) return;
        
        let ingredientsList = recipe.ingredients.map(ing => 
            `<li class="list-group-item d-flex justify-content-between">
                <span>${ing.name} - ${ing.qty} ${ing.unit}</span>
                <span class="fw-bold">${ing.lineCost.toFixed(2)}</span>
            </li>`
        ).join('');
        
        showToast(`Recipe: ${recipe.name} - ${recipe.projectedGP}% GP`, 'info');
    }

    function duplicateRecipe(id) {
        const recipe = menuCostRecipes.find(r => r.id === id);
        if (!recipe) return;
        
        const newRecipe = {
            ...recipe,
            id: Date.now(),
            name: recipe.name + ' (Copy)',
            version: 1,
            createdAt: new Date().toISOString()
        };
        
        menuCostRecipes.push(newRecipe);
        localStorage.setItem('menuCostRecipes', JSON.stringify(menuCostRecipes));
        renderRecipesList();
        updateMenuCostStats();
        showToast('Recipe duplicated', 'success');
    }

    function openRecipeBuilder() {
        const modal = new bootstrap.Modal(document.getElementById('recipeBuilderModal'));
        modal.show();
        
        // Populate ingredient select
        const select = document.getElementById('recipe-ingredient-select');
        select.innerHTML = '<option value="" selected disabled>Select ingredient...</option>' + 
            menuCostIngredients.map(ing => `<option value="${ing.id}" data-unit="${ing.unit}" data-cost="${ing.effectiveCost}">${ing.name} (${ing.effectiveCost.toFixed(2)}/${ing.unit})</option>`).join('');
        
        currentRecipeIngredients = [];
        renderRecipeIngredients();
        updateBuilderCosting();
    }

    document.getElementById('recipe-ingredient-select')?.addEventListener('change', function() {
        const option = this.options[this.selectedIndex];
        document.getElementById('recipe-ingredient-unit').textContent = option.dataset.unit || '-';
    });

    function addIngredientToRecipe() {
        const select = document.getElementById('recipe-ingredient-select');
        const qtyInput = document.getElementById('recipe-ingredient-qty');
        
        if (!select.value || !qtyInput.value || qtyInput.value <= 0) {
            showToast('Please select an ingredient and enter quantity', 'warning');
            return;
        }

        const option = select.options[select.selectedIndex];
        const ingredient = menuCostIngredients.find(i => i.id == select.value);
        const qty = parseFloat(qtyInput.value);
        
        currentRecipeIngredients.push({
            ...ingredient,
            qty,
            lineCost: ingredient.effectiveCost * qty
        });
        
        qtyInput.value = '';
        select.value = '';
        document.getElementById('recipe-ingredient-unit').textContent = '-';
        
        renderRecipeIngredients();
        updateBuilderCosting();
    }

    function renderRecipeIngredients() {
        const container = document.getElementById('recipe-ingredients-list');
        document.getElementById('recipe-ingredient-count').textContent = `${currentRecipeIngredients.length} items`;
        
        if (currentRecipeIngredients.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-hand-pointer fa-2x mb-2 opacity-25"></i>
                    <p class="mb-0">Select ingredients above to build your recipe</p>
                </div>`;
            return;
        }

        container.innerHTML = currentRecipeIngredients.map((ing, index) => `
            <div class="d-flex justify-content-between align-items-center p-3 border-bottom" style="border-color: var(--border-color) !important;">
                <div>
                    <span class="fw-semibold">${ing.name}</span>
                    <small class="text-muted d-block">${ing.qty} ${ing.unit}  ${ing.effectiveCost.toFixed(2)}</small>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <span class="fw-bold" style="color: var(--accent-color);">${ing.lineCost.toFixed(2)}</span>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeRecipeIngredient(${index})"><i class="fas fa-times"></i></button>
                </div>
            </div>
        `).join('');
    }

    function removeRecipeIngredient(index) {
        currentRecipeIngredients.splice(index, 1);
        renderRecipeIngredients();
        updateBuilderCosting();
    }

    function updateBuilderCosting() {
        const ingredientCost = currentRecipeIngredients.reduce((sum, ing) => sum + ing.lineCost, 0);
        const wastageCost = currentRecipeIngredients.reduce((sum, ing) => sum + (ing.lineCost * (ing.wastage / 100)), 0);
        const laborCost = parseFloat(document.getElementById('builder-labor-cost')?.value) || 0;
        const portions = parseInt(document.getElementById('recipe-portions')?.value) || 1;
        const targetGP = parseFloat(document.getElementById('builder-target-gp')?.value) || 70;
        
        const totalCost = ingredientCost + wastageCost + laborCost;
        const costPerPortion = totalCost / portions;
        const sellPrice = costPerPortion / (1 - (targetGP / 100));
        const projectedGP = ((sellPrice - costPerPortion) / sellPrice * 100).toFixed(1);
        
        document.getElementById('builder-ingredient-cost').textContent = `${ingredientCost.toFixed(2)}`;
        document.getElementById('builder-wastage-cost').textContent = `${wastageCost.toFixed(2)}`;
        document.getElementById('builder-total-cost').textContent = `${totalCost.toFixed(2)}`;
        document.getElementById('builder-cost-per-portion').textContent = `${costPerPortion.toFixed(2)}`;
        document.getElementById('builder-sell-price').textContent = `${sellPrice.toFixed(2)}`;
        document.getElementById('builder-projected-gp').textContent = `${projectedGP}%`;
    }

    function saveRecipe() {
        const name = document.getElementById('recipe-name').value;
        const category = document.getElementById('recipe-category').value;
        const portions = parseInt(document.getElementById('recipe-portions').value) || 1;
        
        if (!name) {
            showToast('Please enter a recipe name', 'warning');
            return;
        }
        if (currentRecipeIngredients.length === 0) {
            showToast('Please add at least one ingredient', 'warning');
            return;
        }

        const ingredientCost = currentRecipeIngredients.reduce((sum, ing) => sum + ing.lineCost, 0);
        const wastageCost = currentRecipeIngredients.reduce((sum, ing) => sum + (ing.lineCost * (ing.wastage / 100)), 0);
        const laborCost = parseFloat(document.getElementById('builder-labor-cost')?.value) || 0;
        const targetGP = parseFloat(document.getElementById('builder-target-gp')?.value) || 70;
        
        const totalCost = ingredientCost + wastageCost + laborCost;
        const costPerPortion = totalCost / portions;
        const sellPrice = costPerPortion / (1 - (targetGP / 100));
        const projectedGP = ((sellPrice - costPerPortion) / sellPrice * 100).toFixed(1);

        const recipe = {
            id: Date.now(),
            name,
            category,
            portions,
            ingredients: [...currentRecipeIngredients],
            ingredientCost,
            wastageCost,
            laborCost,
            totalCost,
            costPerPortion,
            sellPrice,
            projectedGP,
            version: 1,
            createdAt: new Date().toISOString()
        };

        menuCostRecipes.push(recipe);
        localStorage.setItem('menuCostRecipes', JSON.stringify(menuCostRecipes));
        
        bootstrap.Modal.getInstance(document.getElementById('recipeBuilderModal')).hide();
        
        renderRecipesList();
        updateMenuCostStats();
        showToast('Recipe saved successfully!', 'success');
    }

    function renderRecipesList() {
        const tbody = document.getElementById('recipes-table-body');
        
        if (menuCostRecipes.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-5 text-muted">
                        <i class="fas fa-book-open fa-3x mb-3 opacity-25"></i>
                        <p>No recipes created yet</p>
                        <button class="btn btn-primary fw-bold" onclick="openRecipeBuilder()" style="background: var(--gradient-primary); border: none;"><i class="fas fa-plus me-2"></i> Create First Recipe</button>
                    </td>
                </tr>`;
            return;
        }

        tbody.innerHTML = menuCostRecipes.map(recipe => {
            const gpClass = recipe.projectedGP >= 70 ? 'text-success' : (recipe.projectedGP >= 60 ? 'text-warning' : 'text-danger');
            return `
                <tr>
                    <td class="ps-4 fw-semibold">${recipe.name}</td>
                    <td><span class="badge bg-light text-dark">${recipe.category}</span></td>
                    <td class="text-end">${recipe.costPerPortion.toFixed(2)}</td>
                    <td class="text-end">${recipe.sellPrice.toFixed(2)}</td>
                    <td class="text-center fw-bold ${gpClass}">${recipe.projectedGP}%</td>
                    <td class="text-center"><span class="badge bg-secondary">v${recipe.version}</span></td>
                    <td class="text-center">-</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-primary" onclick="viewRecipe(${recipe.id})"><i class="fas fa-eye"></i></button>
                        <button class="btn btn-sm btn-outline-success ms-1" onclick="duplicateRecipe(${recipe.id})"><i class="fas fa-copy"></i></button>
                        <button class="btn btn-sm btn-outline-danger ms-1" onclick="deleteRecipe(${recipe.id})"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function filterRecipes(category) {
        const rows = document.querySelectorAll('#recipes-table-body tr');
        rows.forEach(row => {
            if (category === 'all') {
                row.style.display = '';
            } else {
                const catCell = row.querySelector('td:nth-child(2)');
                if (catCell) {
                    const rowCat = catCell.textContent.toLowerCase();
                    row.style.display = rowCat.includes(category) ? '' : 'none';
                }
            }
        });
    }

    function deleteRecipe(id) {
        if (!confirm('Delete this recipe?')) return;
        menuCostRecipes = menuCostRecipes.filter(r => r.id !== id);
        localStorage.setItem('menuCostRecipes', JSON.stringify(menuCostRecipes));
        renderRecipesList();
        updateMenuCostStats();
        showToast('Recipe deleted', 'success');
    }

    function runAutoCategorization() {
        const stars = menuCostRecipes.filter(r => r.projectedGP >= 70);
        const puzzles = menuCostRecipes.filter(r => r.projectedGP >= 70 && r.projectedGP < 70);
        const plowhorses = menuCostRecipes.filter(r => r.projectedGP < 70 && r.projectedGP >= 60);
        const dogs = menuCostRecipes.filter(r => r.projectedGP < 60);

        document.getElementById('stars-count').textContent = stars.length;
        document.getElementById('puzzles-count').textContent = puzzles.length;
        document.getElementById('plowhorses-count').textContent = plowhorses.length;
        document.getElementById('dogs-count').textContent = dogs.length;

        renderMatrixList('stars-list', stars);
        renderMatrixList('puzzles-list', puzzles);
        renderMatrixList('plowhorses-list', plowhorses);
        renderMatrixList('dogs-list', dogs);

        showToast(`Auto-categorization complete: ${stars.length} Stars, ${puzzles.length} Puzzles, ${plowhorses.length} Plow Horses, ${dogs.length} Dogs`, 'success');
    }

    function renderMatrixList(elementId, recipes) {
        const container = document.getElementById(elementId);
        if (recipes.length === 0) {
            container.innerHTML = '<div class="text-center text-muted py-3"><small>No items in this category</small></div>';
            return;
        }
        container.innerHTML = recipes.map(r => `
            <div class="d-flex justify-content-between align-items-center p-2 mb-2 rounded-3" style="background: var(--card-bg);">
                <span class="fw-semibold small">${r.name}</span>
                <span class="badge bg-light text-dark">${r.projectedGP}% GP</span>
            </div>
        `).join('');
    }

    function startNewABTest() {
        if (menuCostRecipes.length === 0) {
            showToast('Create at least one recipe first', 'warning');
            return;
        }
        
        const modal = new bootstrap.Modal(document.getElementById('abTestModal'));
        modal.show();
        
        const select = document.getElementById('ab-base-recipe');
        select.innerHTML = '<option value="" selected disabled>Choose a recipe...</option>' + 
            menuCostRecipes.map(r => `<option value="${r.id}" data-cost="${r.costPerPortion}" data-gp="${r.projectedGP}">${r.name} (${r.costPerPortion.toFixed(2)})</option>`).join('');
    }

    function loadRecipeVariants() {
        const select = document.getElementById('ab-base-recipe');
        const option = select.options[select.selectedIndex];
        const cost = parseFloat(option.dataset.cost) || 0;
        const gp = option.dataset.gp || 0;
        
        document.getElementById('ab-variant-a-cost').textContent = `${cost.toFixed(2)}`;
        document.getElementById('ab-variant-a-gp').textContent = `${gp}%`;
        document.getElementById('ab-variant-b-cost').value = cost.toFixed(2);
        
        calculateABComparison();
    }

    function calculateABComparison() {
        const aCost = parseFloat(document.getElementById('ab-variant-a-cost').textContent.replace('', '')) || 0;
        const bCost = parseFloat(document.getElementById('ab-variant-b-cost').value) || 0;
        const aGP = parseFloat(document.getElementById('ab-variant-a-gp').textContent) || 0;
        const bGP = parseFloat(document.getElementById('ab-variant-b-gp').value) || 70;
        
        const costDiff = bCost - aCost;
        const gpDiff = bGP - aGP;
        const projectedSavings = (aCost - bCost) * 100; // Assuming 100 portions
        
        document.getElementById('ab-cost-diff').textContent = costDiff >= 0 ? `+${costDiff.toFixed(2)}` : `-${Math.abs(costDiff).toFixed(2)}`;
        document.getElementById('ab-cost-diff').className = costDiff > 0 ? 'fw-bold fs-5 text-danger' : 'fw-bold fs-5 text-success';
        document.getElementById('ab-gp-improvement').textContent = gpDiff >= 0 ? `+${gpDiff.toFixed(1)}%` : `${gpDiff.toFixed(1)}%`;
        document.getElementById('ab-gp-improvement').className = gpDiff > 0 ? 'fw-bold fs-5 text-success' : 'fw-bold fs-5 text-danger';
        document.getElementById('ab-projected-savings').textContent = projectedSavings >= 0 ? `${projectedSavings.toFixed(0)}` : `-${Math.abs(projectedSavings).toFixed(0)}`;
    }

    function saveABTest() {
        const name = document.getElementById('ab-test-name').value;
        const baseRecipeId = document.getElementById('ab-base-recipe').value;
        
        if (!name || !baseRecipeId) {
            showToast('Please fill in test name and select a recipe', 'warning');
            return;
        }

        const baseRecipe = menuCostRecipes.find(r => r.id == baseRecipeId);
        const bCost = parseFloat(document.getElementById('ab-variant-b-cost').value) || 0;
        const bGP = parseFloat(document.getElementById('ab-variant-b-gp').value) || 70;
        const notes = document.getElementById('ab-test-notes').value;

        const test = {
            id: Date.now(),
            name,
            baseRecipeId,
            baseRecipeName: baseRecipe.name,
            variantA: { cost: baseRecipe.costPerPortion, gp: baseRecipe.projectedGP },
            variantB: { cost: bCost, gp: bGP },
            notes,
            status: 'active',
            createdAt: new Date().toISOString()
        };

        abTests.push(test);
        localStorage.setItem('abTests', JSON.stringify(abTests));
        
        bootstrap.Modal.getInstance(document.getElementById('abTestModal')).hide();
        
        renderABTestsList();
        updateMenuCostStats();
        showToast('A/B Test started successfully!', 'success');
    }

    function renderABTestsList() {
        const container = document.getElementById('active-ab-tests');
        const activeTests = abTests.filter(t => t.status === 'active');
        
        if (activeTests.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-vial fa-2x mb-2 opacity-25"></i>
                    <p class="mb-0">No active tests</p>
                    <small>Create a test to compare recipe variants</small>
                </div>`;
            return;
        }

        container.innerHTML = activeTests.map(test => `
            <div class="card border-0 mb-2" style="border-radius: 8px; background: var(--card-bg);">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="fw-bold mb-1">${test.name}</h6>
                            <small class="text-muted">Base: ${test.baseRecipeName}</small>
                        </div>
                        <span class="badge bg-success">Active</span>
                    </div>
                    <div class="row mt-2 text-center">
                        <div class="col-6">
                            <small class="text-muted d-block">Variant A</small>
                            <span class="fw-bold">${test.variantA.cost.toFixed(2)}</span>
                        </div>
                        <div class="col-6">
                            <small class="text-muted d-block">Variant B</small>
                            <span class="fw-bold">${test.variantB.cost.toFixed(2)}</span>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function updateMenuCostStats() {
        document.getElementById('total-ingredients-count').textContent = menuCostIngredients.length;
        document.getElementById('total-recipes-count').textContent = menuCostRecipes.length;
        document.getElementById('sub-recipes-count').textContent = menuCostRecipes.filter(r => r.category === 'sauce' || r.category === 'base').length;
        document.getElementById('ab-tests-count').textContent = abTests.filter(t => t.status === 'active').length;
        
        const avgGP = menuCostRecipes.length > 0 
            ? (menuCostRecipes.reduce((sum, r) => sum + parseFloat(r.projectedGP), 0) / menuCostRecipes.length).toFixed(1)
            : 0;
        document.getElementById('avg-recipe-gp').textContent = avgGP + '%';
    }

    function renderMenuEngineeringMatrix() {
        // Matrix is rendered when auto-categorize is run
    }

    // Initialize Menu Cost on page load
    document.addEventListener('DOMContentLoaded', function() {
        updateMenuCostStats();
        
        // Real-time costing event listeners
        const laborInput = document.getElementById('builder-labor-cost');
        const targetGPInput = document.getElementById('builder-target-gp');
        const portionsInput = document.getElementById('recipe-portions');
        
        if (laborInput) laborInput.addEventListener('input', updateBuilderCosting);
        if (targetGPInput) targetGPInput.addEventListener('input', updateBuilderCosting);
        if (portionsInput) portionsInput.addEventListener('input', updateBuilderCosting);
    });

    function previousAnalyticsWeek() {
        if (currentAnalyticsWeek > 1) {
            currentAnalyticsWeek--;
            updateTaxWeekDisplay();
            loadAnalyticsData();
        }
    }

    function nextAnalyticsWeek() {
        if (currentAnalyticsWeek < 52) {
            currentAnalyticsWeek++;
            updateTaxWeekDisplay();
            loadAnalyticsData();
        }
    }

    function loadAnalyticsData() {
        const data = weeklyData[currentAnalyticsWeek] || {};
        document.getElementById('meat-sales-input').value = data.meatSales || '';
        document.getElementById('dessert-sales-input').value = data.dessertSales || '';
        document.getElementById('purchases-input').value = data.purchases || '';
        document.getElementById('wastage-input').value = data.wastage || '';
        
        // Update KPI cards
        updateAnalyticsKPICards();
        
        // Update date range display
        const range = getTaxWeekDateRange(currentAnalyticsWeek);
        document.getElementById('analytics-date-range').textContent = 
            `${range.start.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })} - ${range.end.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })}`;
    }
    
    function updateAnalyticsKPICards() {
        const data = weeklyData[currentAnalyticsWeek] || {};
        const netIncome = (data.meatSales || 0) + (data.dessertSales || 0);
        const grossProfit = netIncome - (data.purchases || 0) - (data.wastage || 0);
        const wastagePercent = data.purchases > 0 ? ((data.wastage || 0) / data.purchases) * 100 : 0;
        
        document.getElementById('kpi-net-income').textContent = '' + netIncome.toFixed(2);
        document.getElementById('kpi-purchases').textContent = '' + (data.purchases || 0).toFixed(2);
        document.getElementById('kpi-gp').textContent = '' + grossProfit.toFixed(2);
        document.getElementById('kpi-wastage').textContent = '' + (data.wastage || 0).toFixed(2);
        
        document.getElementById('wastage-bar').style.width = Math.min(wastagePercent, 100) + '%';
        document.getElementById('wastage-percent').textContent = wastagePercent.toFixed(1) + '% of purchases';
    }

    function updateWeeklyData() {
        const meatSales = parseFloat(document.getElementById('meat-sales-input').value) || 0;
        const dessertSales = parseFloat(document.getElementById('dessert-sales-input').value) || 0;
        const purchases = parseFloat(document.getElementById('purchases-input').value) || 0;
        const wastage = parseFloat(document.getElementById('wastage-input').value) || 0;
        
        const netIncome = meatSales + dessertSales;
        const gp = netIncome - purchases - wastage;
        
        document.getElementById('calculated-gp').textContent = '' + gp.toFixed(2);
        
        // Update KPI cards
        updateAnalyticsKPICards();
        
        // Update weekly table
        renderWeeklyTable();
    }

    function saveAnalyticsData() {
        const data = {
            meatSales: parseFloat(document.getElementById('meat-sales-input').value) || 0,
            dessertSales: parseFloat(document.getElementById('dessert-sales-input').value) || 0,
            purchases: parseFloat(document.getElementById('purchases-input').value) || 0,
            wastage: parseFloat(document.getElementById('wastage-input').value) || 0,
            updatedAt: new Date().toISOString()
        };
        
        weeklyData[currentAnalyticsWeek] = data;
        saveAllData();
        updateWeeklyTable();
        updateDashboardStats();
        showToast('Weekly data saved successfully', 'success');
    }

    function renderMeatAnalysis() {
        const tbody = document.getElementById('meat-analysis-table-body');
        const meatProducts = inventory.filter(p => p.category === 'meat');
        
        const data = meatData[currentAnalyticsWeek] || {};
        
        // Group products by meatCategory
        const categories = ['FILLET', 'SIRLOIN', 'RIBEYE', 'RUMP'];
        let html = '';
        
        categories.forEach(category => {
            const categoryProducts = meatProducts.filter(p => p.meatCategory === category);
            if (categoryProducts.length === 0) return;
            
            // Add category header
            html += `<tr class="category-header"><td colspan="6" class="ps-4 py-2">${category}</td></tr>`;
            
            // Add products in this category
            html += categoryProducts.map(product => {
                const itemData = data[product.id] || { amount: 0, wastage: 0 };
                const value = itemData.amount * product.cost;
                const wastagePercent = value > 0 ? ((itemData.wastage / value) * 100).toFixed(1) : 0;
                
                return `
                    <tr>
                        <td class="ps-4 fw-bold">${product.name}</td>
                        <td class="text-end">${product.cost.toFixed(2)}</td>
                        <td class="text-end">
                            <input type="number" class="form-control form-control-sm meat-input" value="${itemData.amount || ''}" 
                                onchange="updateMeatItem('${product.id}', 'amount', this.value)" placeholder="0">
                        </td>
                        <td class="text-end fw-bold">${value.toFixed(2)}</td>
                        <td class="text-end">
                            <input type="number" class="form-control form-control-sm meat-input" value="${itemData.wastage || ''}" 
                                onchange="updateMeatItem('${product.id}', 'wastage', this.value)" placeholder="0">
                        </td>
                        <td class="text-end ${wastagePercent > 10 ? 'text-danger fw-bold' : ''}">${wastagePercent}%</td>
                    </tr>
                `;
            }).join('');
        });
        
        // Add other meat products without meatCategory
        const otherProducts = meatProducts.filter(p => !p.meatCategory);
        if (otherProducts.length > 0) {
            html += `<tr class="category-header"><td colspan="6" class="ps-4 py-2">OTHER MEATS</td></tr>`;
            html += otherProducts.map(product => {
                const itemData = data[product.id] || { amount: 0, wastage: 0 };
                const value = itemData.amount * product.cost;
                const wastagePercent = value > 0 ? ((itemData.wastage / value) * 100).toFixed(1) : 0;
                
                return `
                    <tr>
                        <td class="ps-4 fw-bold">${product.name}</td>
                        <td class="text-end">${product.cost.toFixed(2)}</td>
                        <td class="text-end">
                            <input type="number" class="form-control form-control-sm meat-input" value="${itemData.amount || ''}" 
                                onchange="updateMeatItem('${product.id}', 'amount', this.value)" placeholder="0">
                        </td>
                        <td class="text-end fw-bold">${value.toFixed(2)}</td>
                        <td class="text-end">
                            <input type="number" class="form-control form-control-sm meat-input" value="${itemData.wastage || ''}" 
                                onchange="updateMeatItem('${product.id}', 'wastage', this.value)" placeholder="0">
                        </td>
                        <td class="text-end ${wastagePercent > 10 ? 'text-danger fw-bold' : ''}">${wastagePercent}%</td>
                    </tr>
                `;
            }).join('');
        }
        
        tbody.innerHTML = html;
        updateMeatTotals();
        renderMeatCategoryCards();
    }
    
    function renderMeatCategoryCards() {
        const container = document.getElementById('meat-category-cards');
        if (!container) return;
        
        const data = meatData[currentAnalyticsWeek] || {};
        const categories = ['FILLET', 'SIRLOIN', 'RIBEYE', 'RUMP'];
        const categoryColors = {
            'FILLET': 'danger',
            'SIRLOIN': 'primary',
            'RIBEYE': 'warning',
            'RUMP': 'success'
        };
        
        let html = '';
        categories.forEach(category => {
            const categoryProducts = inventory.filter(p => p.meatCategory === category);
            let categoryTotal = 0;
            let categoryWastage = 0;
            
            categoryProducts.forEach(product => {
                const itemData = data[product.id] || { amount: 0, wastage: 0 };
                categoryTotal += (itemData.amount || 0) * product.cost;
                categoryWastage += itemData.wastage || 0;
            });
            
            const wastagePercent = categoryTotal > 0 ? ((categoryWastage / categoryTotal) * 100).toFixed(1) : 0;
            const color = categoryColors[category];
            
            html += `
                <div class="col-md-3">
                    <div class="card border-${color} hover-lift" style="border-left: 4px solid var(--${color === 'danger' ? 'danger' : color === 'primary' ? 'primary' : color === 'warning' ? 'warning' : 'success'}-color); border-radius: 12px;">
                        <div class="card-body">
                            <h6 class="text-${color} fw-bold text-uppercase" style="font-size: 0.8rem;">${category}</h6>
                            <h4 class="mb-1">${categoryTotal.toFixed(2)}</h4>
                            <small class="text-muted">Purchases</small>
                            <div class="mt-2">
                                <small class="text-${wastagePercent > 10 ? 'danger' : 'muted'}">Wastage: ${wastagePercent}%</small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }

    function updateMeatItem(productId, field, value) {
        if (!meatData[currentAnalyticsWeek]) meatData[currentAnalyticsWeek] = {};
        if (!meatData[currentAnalyticsWeek][productId]) meatData[currentAnalyticsWeek][productId] = {};
        meatData[currentAnalyticsWeek][productId][field] = parseFloat(value) || 0;
        renderMeatAnalysis();
    }

    function updateMeatTotals() {
        const data = meatData[currentAnalyticsWeek] || {};
        let totalPurchases = 0;
        let totalWastage = 0;
        
        Object.entries(data).forEach(([productId, itemData]) => {
            const product = inventory.find(p => p.id === productId);
            if (product) {
                totalPurchases += (itemData.amount || 0) * product.cost;
                totalWastage += itemData.wastage || 0;
            }
        });
        
        document.getElementById('meat-total-purchases').textContent = '' + totalPurchases.toFixed(2);
        document.getElementById('meat-total-wastage').textContent = '' + totalWastage.toFixed(2);
        const wastagePercent = totalPurchases > 0 ? ((totalWastage / totalPurchases) * 100).toFixed(1) : 0;
        document.getElementById('meat-total-wastage-percent').textContent = wastagePercent + '%';
    }

    function saveMeatData() {
        saveAllData();
        showToast('Meat analysis data saved', 'success');
    }

    function renderBuyersAnalysis() {
        const tbody = document.getElementById('buyers-analysis-table-body');
        const data = buyersData[currentAnalyticsWeek] || {};
        
        // Get invoice data for this week
        const weekOrders = orders.filter(o => o.taxWeek === currentAnalyticsWeek && o.status === 'completed');
        const invoiceData = {};
        
        weekOrders.forEach(order => {
            const unitKey = order.unit.toLowerCase().replace(/\s+/g, '');
            order.items.forEach(item => {
                if (!invoiceData[item.id]) {
                    invoiceData[item.id] = { ccYork: 0, luciaYork: 0, ccManchester: 0, ccLeeds: 0, luciaBeverley: 0 };
                }
                if (invoiceData[item.id][unitKey] !== undefined) {
                    invoiceData[item.id][unitKey] += item.qty;
                }
            });
        });
        
        // Update invoice count badge
        const invoiceCount = weekOrders.length;
        const invoiceCountEl = document.getElementById('buyers-invoice-count');
        if (invoiceCountEl) invoiceCountEl.textContent = invoiceCount;
        
        // Show/hide sync box
        const syncBox = document.getElementById('buyers-invoice-sync-box');
        if (syncBox) syncBox.classList.toggle('hidden', invoiceCount === 0);
        
        tbody.innerHTML = inventory.map(product => {
            const productData = data[product.id] || { ccYork: 0, luciaYork: 0, ccManchester: 0, ccLeeds: 0, luciaBeverley: 0 };
            const invData = invoiceData[product.id] || { ccYork: 0, luciaYork: 0, ccManchester: 0, ccLeeds: 0, luciaBeverley: 0 };
            const totalQty = Object.values(productData).reduce((a, b) => a + (parseInt(b) || 0), 0);
            const totalValue = totalQty * product.cost;
            
            return `
                <tr>
                    <td class="ps-4 fw-bold">${product.name}</td>
                    <td class="text-end">${product.cost.toFixed(2)}</td>
                    <td class="text-end">
                        <input type="number" class="form-control form-control-sm buyer-input" value="${productData.ccYork || ''}" 
                            onchange="updateBuyerData('${product.id}', 'ccYork', this.value)">
                        ${invData.ccYork > 0 ? `<small class="text-success">Inv: ${invData.ccYork}</small>` : ''}
                    </td>
                    <td class="text-end">
                        <input type="number" class="form-control form-control-sm buyer-input" value="${productData.luciaYork || ''}" 
                            onchange="updateBuyerData('${product.id}', 'luciaYork', this.value)">
                        ${invData.luciaYork > 0 ? `<small class="text-success">Inv: ${invData.luciaYork}</small>` : ''}
                    </td>
                    <td class="text-end">
                        <input type="number" class="form-control form-control-sm buyer-input" value="${productData.ccManchester || ''}" 
                            onchange="updateBuyerData('${product.id}', 'ccManchester', this.value)">
                        ${invData.ccManchester > 0 ? `<small class="text-success">Inv: ${invData.ccManchester}</small>` : ''}
                    </td>
                    <td class="text-end">
                        <input type="number" class="form-control form-control-sm buyer-input" value="${productData.ccLeeds || ''}" 
                            onchange="updateBuyerData('${product.id}', 'ccLeeds', this.value)">
                        ${invData.ccLeeds > 0 ? `<small class="text-success">Inv: ${invData.ccLeeds}</small>` : ''}
                    </td>
                    <td class="text-end">
                        <input type="number" class="form-control form-control-sm buyer-input" value="${productData.luciaBeverley || ''}" 
                            onchange="updateBuyerData('${product.id}', 'luciaBeverley', this.value)">
                        ${invData.luciaBeverley > 0 ? `<small class="text-success">Inv: ${invData.luciaBeverley}</small>` : ''}
                    </td>
                    <td class="text-end fw-bold">${totalQty}</td>
                    <td class="text-end fw-bold text-success">${totalValue.toFixed(2)}</td>
                </tr>
            `;
        }).join('');
        
        updateBuyerTotals();
        renderBuyerSummaryCards();
    }
    
    function renderBuyerSummaryCards() {
        const container = document.getElementById('buyer-summary-cards');
        if (!container) return;
        
        const data = buyersData[currentAnalyticsWeek] || {};
        const buyers = [
            { key: 'ccYork', name: 'CC YORK', color: 'primary' },
            { key: 'luciaYork', name: 'LUCIA YORK', color: 'info' },
            { key: 'ccManchester', name: 'CC MANCHESTER', color: 'warning' },
            { key: 'ccLeeds', name: 'CC LEEDS', color: 'success' },
            { key: 'luciaBeverley', name: 'LUCIA BEVERLEY', color: 'danger' }
        ];
        
        let html = '';
        buyers.forEach(buyer => {
            let totalQty = 0;
            let totalValue = 0;
            
            Object.entries(data).forEach(([productId, productData]) => {
                const product = inventory.find(p => p.id === productId);
                if (product && productData[buyer.key]) {
                    totalQty += parseInt(productData[buyer.key]) || 0;
                    totalValue += (parseInt(productData[buyer.key]) || 0) * product.cost;
                }
            });
            
            html += `
                <div class="col-md-4 col-lg-2">
                    <div class="card border-${buyer.color} hover-lift" style="border-left: 4px solid; border-radius: 12px;">
                        <div class="card-body text-center">
                            <h6 class="text-${buyer.color} fw-bold text-uppercase" style="font-size: 0.75rem;">${buyer.name}</h6>
                            <h4 class="mb-1">${totalQty}</h4>
                            <small class="text-muted">items</small>
                            <div class="mt-2">
                                <span class="fw-bold text-success">${totalValue.toFixed(0)}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }

    function syncBuyersFromInvoices() {
        const weekOrders = orders.filter(o => o.taxWeek === currentAnalyticsWeek && o.status === 'completed');
        
        if (weekOrders.length === 0) {
            showToast('No completed invoices for this week', 'info');
            return;
        }
        
        if (!buyersData[currentAnalyticsWeek]) buyersData[currentAnalyticsWeek] = {};
        
        weekOrders.forEach(order => {
            const unitKey = order.unit.toLowerCase().replace(/\s+/g, '');
            order.items.forEach(item => {
                if (!buyersData[currentAnalyticsWeek][item.id]) {
                    buyersData[currentAnalyticsWeek][item.id] = { ccYork: 0, luciaYork: 0, ccManchester: 0, ccLeeds: 0, luciaBeverley: 0 };
                }
                if (buyersData[currentAnalyticsWeek][item.id][unitKey] !== undefined) {
                    buyersData[currentAnalyticsWeek][item.id][unitKey] += item.qty;
                }
            });
        });
        
        saveAllData();
        renderBuyersAnalysis();
        showToast(`Synced ${weekOrders.length} invoices to buyer analysis`, 'success');
        logActivity('sync', `Synced ${weekOrders.length} invoices to buyer analysis for week ${currentAnalyticsWeek}`);
    }

    function updateBuyerData(productId, buyer, value) {
        if (!buyersData[currentAnalyticsWeek]) buyersData[currentAnalyticsWeek] = {};
        if (!buyersData[currentAnalyticsWeek][productId]) buyersData[currentAnalyticsWeek][productId] = {};
        buyersData[currentAnalyticsWeek][productId][buyer] = parseInt(value) || 0;
        renderBuyersAnalysis();
    }

    function updateBuyerTotals() {
        const data = buyersData[currentAnalyticsWeek] || {};
        const totals = { ccYork: 0, luciaYork: 0, ccManchester: 0, ccLeeds: 0, luciaBeverley: 0 };
        let grandTotalQty = 0;
        let grandTotalValue = 0;
        
        Object.entries(data).forEach(([productId, productData]) => {
            const product = inventory.find(p => p.id === productId);
            if (product) {
                Object.entries(productData).forEach(([buyer, qty]) => {
                    if (totals[buyer] !== undefined) {
                        totals[buyer] += parseInt(qty) || 0;
                        grandTotalQty += parseInt(qty) || 0;
                        grandTotalValue += (parseInt(qty) || 0) * product.cost;
                    }
                });
            }
        });
        
        document.getElementById('total-cc-york').textContent = totals.ccYork;
        document.getElementById('total-lucia-york').textContent = totals.luciaYork;
        document.getElementById('total-cc-manchester').textContent = totals.ccManchester;
        document.getElementById('total-cc-leeds').textContent = totals.ccLeeds;
        document.getElementById('total-lucia-beverley').textContent = totals.luciaBeverley;
        document.getElementById('grand-total-qty').textContent = grandTotalQty;
        document.getElementById('grand-total-value').textContent = '' + grandTotalValue.toFixed(2);
    }

    function saveBuyersData() {
        saveAllData();
        showToast('Buyer data saved', 'success');
    }

    // ==================== ADD/REMOVE PRODUCTS IN ANALYTICS ====================
    
    // Open Add Meat Product Modal
    function openAddMeatProductModal() {
        document.getElementById('addMeatProductForm').reset();
        new bootstrap.Modal(document.getElementById('addMeatProductModal')).show();
    }
    
    // Add Meat Product
    function addMeatProduct() {
        const name = document.getElementById('meat-product-name').value.trim();
        const meatCategory = document.getElementById('meat-product-category').value;
        const unit = document.getElementById('meat-product-unit').value.trim();
        const cost = parseFloat(document.getElementById('meat-product-cost').value) || 0;
        const minStock = parseInt(document.getElementById('meat-product-min').value) || 0;
        const stock = parseInt(document.getElementById('meat-product-stock').value) || 0;
        
        if (!name || !unit || cost <= 0) {
            showToast('Please fill in all required fields with valid values', 'error');
            return;
        }
        
        // Check if product with same name already exists
        const existingProduct = inventory.find(p => p.name.toLowerCase() === name.toLowerCase());
        if (existingProduct) {
            showToast('A product with this name already exists', 'error');
            return;
        }
        
        const newProduct = {
            id: 'meat-' + Date.now(),
            name: name,
            category: 'meat',
            meatCategory: meatCategory,
            unit: unit,
            cost: cost,
            minStock: minStock,
            stock: stock,
            maxOrder: 0
        };
        
        inventory.push(newProduct);
        saveAllData();
        
        bootstrap.Modal.getInstance(document.getElementById('addMeatProductModal')).hide();
        renderMeatAnalysis();
        renderStock();
        renderOrderItems();
        showToast('Meat product added successfully!', 'success');
        logActivity('product', `Added new meat product: ${name}`);
    }
    
    // Open Remove Meat Product Modal
    function openRemoveMeatProductModal() {
        const select = document.getElementById('remove-meat-product-select');
        select.innerHTML = '<option value="" selected disabled>Choose a product...</option>';
        
        const meatProducts = inventory.filter(p => p.category === 'meat');
        if (meatProducts.length === 0) {
            showToast('No meat products to remove', 'warning');
            return;
        }
        
        meatProducts.forEach(product => {
            const option = document.createElement('option');
            option.value = product.id;
            option.textContent = `${product.name} (${product.meatCategory || 'Other'}) - ${product.cost.toFixed(2)}`;
            select.appendChild(option);
        });
        
        new bootstrap.Modal(document.getElementById('removeMeatProductModal')).show();
    }
    
    // Remove Meat Product
    function removeMeatProduct() {
        const productId = document.getElementById('remove-meat-product-select').value;
        
        if (!productId) {
            showToast('Please select a product to remove', 'error');
            return;
        }
        
        const product = inventory.find(p => p.id === productId);
        if (!product) {
            showToast('Product not found', 'error');
            return;
        }
        
        if (!confirm(`Are you sure you want to remove "${product.name}"? This action cannot be undone.`)) {
            return;
        }
        
        inventory = inventory.filter(p => p.id !== productId);
        saveAllData();
        
        bootstrap.Modal.getInstance(document.getElementById('removeMeatProductModal')).hide();
        renderMeatAnalysis();
        renderStock();
        renderOrderItems();
        showToast('Product removed successfully', 'success');
        logActivity('product', `Removed meat product: ${product.name}`);
    }
    
    // Open Add Buyer Product Modal
    function openAddBuyerProductModal() {
        document.getElementById('addBuyerProductForm').reset();
        new bootstrap.Modal(document.getElementById('addBuyerProductModal')).show();
    }
    
    // Add Buyer Product
    function addBuyerProduct() {
        const name = document.getElementById('buyer-product-name').value.trim();
        const category = document.getElementById('buyer-product-category').value;
        const unit = document.getElementById('buyer-product-unit').value.trim();
        const cost = parseFloat(document.getElementById('buyer-product-cost').value) || 0;
        const minStock = parseInt(document.getElementById('buyer-product-min').value) || 0;
        const stock = parseInt(document.getElementById('buyer-product-stock').value) || 0;
        
        if (!name || !unit || cost <= 0) {
            showToast('Please fill in all required fields with valid values', 'error');
            return;
        }
        
        // Check if product with same name already exists
        const existingProduct = inventory.find(p => p.name.toLowerCase() === name.toLowerCase());
        if (existingProduct) {
            showToast('A product with this name already exists', 'error');
            return;
        }
        
        const newProduct = {
            id: 'prod-' + Date.now(),
            name: name,
            category: category,
            unit: unit,
            cost: cost,
            minStock: minStock,
            stock: stock,
            maxOrder: 0
        };
        
        inventory.push(newProduct);
        saveAllData();
        
        bootstrap.Modal.getInstance(document.getElementById('addBuyerProductModal')).hide();
        renderBuyersAnalysis();
        renderStock();
        renderOrderItems();
        showToast('Product added successfully!', 'success');
        logActivity('product', `Added new product for buyers: ${name}`);
    }
    
    // Open Remove Buyer Product Modal
    function openRemoveBuyerProductModal() {
        const select = document.getElementById('remove-buyer-product-select');
        select.innerHTML = '<option value="" selected disabled>Choose a product...</option>';
        
        if (inventory.length === 0) {
            showToast('No products to remove', 'warning');
            return;
        }
        
        inventory.forEach(product => {
            const option = document.createElement('option');
            option.value = product.id;
            option.textContent = `${product.name} (${product.category}) - ${product.cost.toFixed(2)}`;
            select.appendChild(option);
        });
        
        new bootstrap.Modal(document.getElementById('removeBuyerProductModal')).show();
    }
    
    // Remove Buyer Product
    function removeBuyerProduct() {
        const productId = document.getElementById('remove-buyer-product-select').value;
        
        if (!productId) {
            showToast('Please select a product to remove', 'error');
            return;
        }
        
        const product = inventory.find(p => p.id === productId);
        if (!product) {
            showToast('Product not found', 'error');
            return;
        }
        
        if (!confirm(`Are you sure you want to remove "${product.name}"? This action cannot be undone.`)) {
            return;
        }
        
        inventory = inventory.filter(p => p.id !== productId);
        saveAllData();
        
        bootstrap.Modal.getInstance(document.getElementById('removeBuyerProductModal')).hide();
        renderBuyersAnalysis();
        renderStock();
        renderOrderItems();
        showToast('Product removed successfully', 'success');
        logActivity('product', `Removed product: ${product.name}`);
    }

    function toggleAutoSync() {
        const enabled = document.getElementById('auto-sync-check').checked;
        if (enabled) {
            syncMeatSalesFromInvoices();
        }
    }

    function syncMeatSalesFromInvoices() {
        const weekOrders = orders.filter(o => o.taxWeek === currentAnalyticsWeek && o.status === 'completed');
        const meatSales = weekOrders.reduce((sum, o) => {
            const meatItems = o.items.filter(i => {
                const product = inventory.find(p => p.id === i.id);
                return product && product.category === 'meat';
            });
            return sum + meatItems.reduce((s, i) => s + (i.qty * i.cost), 0);
        }, 0);
        
        document.getElementById('meat-sales-input').value = meatSales.toFixed(2);
        document.getElementById('meat-sync-status').textContent = 'Synced from invoices';
        document.getElementById('meat-sync-status').classList.add('text-success');
        updateWeeklyData();
    }

    // ==================== WEEKLY TABLE ====================
    function renderWeeklyTable() {
        const thead = document.getElementById('weekly-table-header');
        const tbody = document.getElementById('weekly-table-body');
        
        // Update current week display
        document.getElementById('weekly-summary-week').textContent = currentAnalyticsWeek;
        
        // Show 10 weeks around current week (or all 52 if preferred)
        const startWeek = Math.max(1, currentAnalyticsWeek - 4);
        const endWeek = Math.min(52, currentAnalyticsWeek + 5);
        const displayWeeks = [];
        for (let i = startWeek; i <= endWeek; i++) {
            displayWeeks.push(i);
        }
        
        // Build header
        let headerHtml = '<th class="bg-primary text-white" style="position: sticky; left: 0; z-index: 10; min-width: 140px;">Metric</th>';
        displayWeeks.forEach(week => {
            headerHtml += `<th class="text-center ${week === currentAnalyticsWeek ? 'current-week' : ''}">W${week}</th>`;
        });
        thead.innerHTML = headerHtml;
        
        // Build rows with connected analytics data
        const metrics = [
            { 
                key: 'netIncome', 
                label: 'Net Income', 
                format: (data) => {
                    const netIncome = (data.meatSales || 0) + (data.dessertSales || 0);
                    return '' + netIncome.toFixed(0);
                }
            },
            { 
                key: 'purchases', 
                label: 'Purchases', 
                format: (data) => '' + (data.purchases || 0).toFixed(0)
            },
            { 
                key: 'gp', 
                label: 'Gross Profit', 
                format: (data) => {
                    const netIncome = (data.meatSales || 0) + (data.dessertSales || 0);
                    const gp = netIncome - (data.purchases || 0) - (data.wastage || 0);
                    return '' + gp.toFixed(0);
                }
            },
            { 
                key: 'wastage', 
                label: 'Wastage', 
                format: (data) => '' + (data.wastage || 0).toFixed(0)
            }
        ];
        
        tbody.innerHTML = metrics.map(metric => `
            <tr>
                <td class="fw-bold bg-light" style="position: sticky; left: 0; z-index: 5;">${metric.label}</td>
                ${displayWeeks.map(week => {
                    const data = weeklyData[week] || {};
                    return `<td class="text-center ${week === currentAnalyticsWeek ? 'current-week' : ''}">${metric.format(data)}</td>`;
                }).join('')}
            </tr>
        `).join('');
    }

    // ==================== RECIPES ====================
    function initRecipes() {
        if (recipes.length === 0) {
            recipes = [
                { id: 'recipe-001', name: 'Margherita Pizza', category: 'Pizza', cost: 3.50, sellPrice: 12.00 },
                { id: 'recipe-002', name: 'Pepperoni Pizza', category: 'Pizza', cost: 4.20, sellPrice: 14.00 },
                { id: 'recipe-003', name: 'Chicken Alfredo', category: 'Pasta', cost: 5.50, sellPrice: 16.00 },
                { id: 'recipe-004', name: 'Spaghetti Bolognese', category: 'Pasta', cost: 4.80, sellPrice: 15.00 }
            ];
            saveAllData();
        }
    }

    function renderRecipes() {
        const tbody = document.getElementById('recipe-table-body');
        tbody.innerHTML = recipes.map(recipe => {
            const gp = ((recipe.sellPrice - recipe.cost) / recipe.sellPrice * 100).toFixed(1);
            const gpClass = gp >= 70 ? 'text-success' : gp >= 65 ? 'text-warning' : 'text-danger';
            return `
                <tr>
                    <td class="fw-bold">${recipe.name}</td>
                    <td><span class="badge bg-light text-dark">${recipe.category}</span></td>
                    <td>${recipe.cost.toFixed(2)}</td>
                    <td>${recipe.sellPrice.toFixed(2)}</td>
                    <td class="fw-bold ${gpClass}">${gp}%</td>
                    <td>
                        <button onclick="editRecipe('${recipe.id}')" class="btn btn-sm btn-outline-primary"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteRecipe('${recipe.id}')" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function calculateGP() {
        const cost = parseFloat(document.getElementById('gp-cost').value) || 0;
        const sell = parseFloat(document.getElementById('gp-sell').value) || 0;
        
        if (sell > 0) {
            const gp = ((sell - cost) / sell * 100).toFixed(1);
            const resultEl = document.getElementById('gp-result');
            resultEl.textContent = gp + '%';
            resultEl.className = 'mb-0 fw-bold ' + (gp >= 70 ? 'text-success' : gp >= 65 ? 'text-warning' : 'text-danger');
        } else {
            document.getElementById('gp-result').textContent = '0%';
        }
    }

    function editRecipe(id) {
        showToast('Recipe editing coming soon', 'info');
    }

    function deleteRecipe(id) {
        if (!confirm('Delete this recipe?')) return;
        recipes = recipes.filter(r => r.id !== id);
        saveAllData();
        renderRecipes();
        showToast('Recipe deleted', 'success');
    }


    // ==================== MESSAGES ====================
    function sendMessage() {
        const subject = document.getElementById('msg-subject').value.trim();
        const body = document.getElementById('msg-body').value.trim();
        const urgent = document.getElementById('msg-urgent').checked;
        
        if (!subject || !body) {
            showToast('Please enter subject and message', 'error');
            return;
        }
        
        const message = {
            id: 'msg-' + Date.now(),
            from: currentUser.name,
            fromUnit: currentUser.unit || 'Admin',
            subject,
            body,
            urgent,
            read: false,
            date: new Date().toISOString()
        };
        
        messages.push(message);
        saveAllData();
        
        document.getElementById('msg-subject').value = '';
        document.getElementById('msg-body').value = '';
        document.getElementById('msg-urgent').checked = false;
        
        renderRestMessages();
        showToast('Message sent successfully', 'success');
        logActivity('message', `Message sent: "${subject}" from ${currentUser.name}`);
    }

    function renderMessages() {
        const container = document.getElementById('messages-container');
        const unreadCount = messages.filter(m => !m.read).length;
        
        document.getElementById('message-badge').textContent = unreadCount;
        document.getElementById('message-badge').classList.toggle('hidden', unreadCount === 0);
        document.getElementById('total-messages-count').textContent = messages.length + ' Total';
        document.getElementById('delete-read-btn').style.display = messages.some(m => m.read) ? 'inline-block' : 'none';
        
        if (messages.length === 0) {
            container.innerHTML = '<div class="text-center text-muted py-5">No messages</div>';
            return;
        }
        
        container.innerHTML = messages.slice().reverse().map(msg => `
            <div class="card mb-3 hover-lift ${msg.read ? 'opacity-75' : ''} ${msg.urgent ? 'border-danger' : ''} glass-card" style="border-radius: 16px; border-left: 4px solid ${msg.urgent ? 'var(--danger-color)' : msg.read ? 'var(--success-color)' : 'var(--primary-color)'};">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="d-flex align-items-center gap-2 mb-2">
                                ${msg.urgent ? '<span class="badge bg-danger"><i class="fas fa-exclamation-circle me-1"></i>URGENT</span>' : ''}
                                ${!msg.read ? '<span class="badge bg-primary">NEW</span>' : ''}
                                <span class="badge bg-light text-dark">${msg.fromUnit}</span>
                            </div>
                            <h6 class="fw-bold mb-1">${msg.subject}</h6>
                            <small class="text-muted">From: ${msg.from} | ${new Date(msg.date).toLocaleString('en-GB')}</small>
                        </div>
                        <div class="btn-group">
                            ${!msg.read ? `<button onclick="markMessageRead('${msg.id}')" class="btn btn-sm btn-outline-success"><i class="fas fa-check"></i></button>` : ''}
                            <button onclick="deleteMessage('${msg.id}')" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <hr style="border-color: var(--border-color);">
                    <p class="mb-0">${msg.body}</p>
                </div>
            </div>
        `).join('');
    }

    function renderRestMessages() {
        const container = document.getElementById('rest-messages-list');
        const myMessages = messages.filter(m => m.from === currentUser.name || m.fromUnit === currentUser.unit);
        
        if (myMessages.length === 0) {
            container.innerHTML = '<div class="text-center text-muted py-4">No messages yet</div>';
            return;
        }
        
        container.innerHTML = myMessages.slice().reverse().map(msg => `
            <div class="card mb-3 ${msg.urgent ? 'border-danger' : ''} glass-card" style="border-radius: 16px;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            ${msg.urgent ? '<span class="badge bg-danger mb-2"><i class="fas fa-exclamation-circle me-1"></i>URGENT</span>' : ''}
                            <h6 class="fw-bold mb-1">${msg.subject}</h6>
                            <small class="text-muted">${new Date(msg.date).toLocaleString('en-GB')}</small>
                        </div>
                        <span class="badge ${msg.read ? 'bg-success' : 'bg-primary'}">${msg.read ? 'Read' : 'Sent'}</span>
                    </div>
                    <hr style="border-color: var(--border-color);">
                    <p class="mb-0">${msg.body}</p>
                </div>
            </div>
        `).join('');
    }

    function markMessageRead(id) {
        const msg = messages.find(m => m.id === id);
        if (msg) {
            msg.read = true;
            saveAllData();
            renderMessages();
        }
    }

    function deleteMessage(id) {
        if (!confirm('Delete this message?')) return;
        messages = messages.filter(m => m.id !== id);
        saveAllData();
        renderMessages();
    }

    function deleteAllReadMessages() {
        if (!confirm('Delete all read messages?')) return;
        messages = messages.filter(m => !m.read);
        saveAllData();
        renderMessages();
        showToast('Read messages deleted', 'success');
    }

    // ==================== ACTIVITY LOG ====================
    function logActivity(type, description) {
        const entry = {
            id: 'log-' + Date.now(),
            type,
            description,
            timestamp: new Date().toISOString(),
            user: currentUser?.name || 'System'
        };
        activityLog.push(entry);
        // Keep only last 100 entries
        if (activityLog.length > 100) activityLog = activityLog.slice(-100);
        saveAllData();
        renderActivityLog();
    }

    function renderActivityLog() {
        const container = document.getElementById('activity-log-container');
        
        if (activityLog.length === 0) {
            container.innerHTML = '<div class="text-center text-muted py-5">No activity recorded yet</div>';
            return;
        }
        
        container.innerHTML = activityLog.slice().reverse().map(log => `
            <div class="activity-log-item ${log.type}">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <span class="fw-bold">${log.description}</span>
                        <small class="text-muted d-block">by ${log.user}</small>
                    </div>
                    <small class="text-muted">${new Date(log.timestamp).toLocaleString('en-GB')}</small>
                </div>
            </div>
        `).join('');
    }

    function clearActivityLog() {
        if (!confirm('Clear all activity logs?')) return;
        activityLog = [];
        saveAllData();
        renderActivityLog();
        showToast('Activity log cleared', 'success');
    }

    // ==================== DASHBOARD STATS ====================
    function updateDashboardStats() {
        // Stock alerts
        const lowStock = inventory.filter(p => p.stock <= p.minStock);
        const criticalStock = inventory.filter(p => p.stock === 0);
        document.getElementById('dash-stock-alerts-count').textContent = lowStock.length;
        
        const alertsDetails = document.getElementById('stock-alerts-details');
        if (lowStock.length === 0) {
            alertsDetails.innerHTML = '<small class="text-muted">All stock levels healthy</small>';
        } else {
            alertsDetails.innerHTML = lowStock.slice(0, 3).map(p => `
                <div class="stock-alert-item ${p.stock === 0 ? 'stock-alert-critical' : 'stock-alert-warning'}">
                    <i class="fas fa-${p.stock === 0 ? 'times-circle' : 'exclamation-triangle'}"></i>
                    ${p.name}: ${p.stock}/${p.minStock} ${p.unit}
                </div>
            `).join('');
        }
        
        document.getElementById('stock-alerts-summary').innerHTML = `
            <span class="${criticalStock.length > 0 ? 'text-danger' : lowStock.length > 0 ? 'text-warning' : 'text-success'}">
                <i class="fas fa-${criticalStock.length > 0 ? 'times-circle' : lowStock.length > 0 ? 'exclamation-triangle' : 'check-circle'} me-1"></i>
                ${criticalStock.length > 0 ? `${criticalStock.length} out of stock` : lowStock.length > 0 ? `${lowStock.length} items low` : 'All stock healthy'}
            </span>
        `;
        
        // Net income from completed orders
        const completedOrders = orders.filter(o => o.status === 'completed');
        const totalIncome = completedOrders.reduce((sum, o) => sum + o.total, 0);
        document.getElementById('dash-net-income').textContent = '' + totalIncome.toFixed(2);
        
        // GP calculation
        const weeklyNetIncome = Object.values(weeklyData).reduce((sum, w) => sum + (w.meatSales || 0) + (w.dessertSales || 0), 0);
        const weeklyPurchases = Object.values(weeklyData).reduce((sum, w) => sum + (w.purchases || 0), 0);
        const weeklyWastage = Object.values(weeklyData).reduce((sum, w) => sum + (w.wastage || 0), 0);
        const gp = weeklyNetIncome - weeklyPurchases - weeklyWastage;
        const gpPercent = weeklyNetIncome > 0 ? ((gp / weeklyNetIncome) * 100).toFixed(1) : 0;
        document.getElementById('dash-gp').textContent = gpPercent + '%';
        
        // GP variance
        const targetGP = 72;
        const variance = (gpPercent - targetGP).toFixed(1);
        const varianceEl = document.getElementById('gp-target-variance');
        varianceEl.innerHTML = `
            <i class="fas fa-${variance >= 0 ? 'arrow-up text-success' : 'arrow-down text-danger'} me-1"></i>
            ${variance >= 0 ? '+' : ''}${variance}% vs Target (${targetGP}%)
        `;
        
        updateDashboardPrepSummary();
        renderTopProductsByBuyers();
    }

    // ==================== TOP PRODUCTS BY BUYERS ====================
    function renderTopProductsByBuyers() {
        const tbody = document.getElementById('top-products-table-body');
        if (!tbody) return;
        
        // Aggregate product quantities from all orders
        const productStats = {};
        const units = ['CC YORK', 'LUCIA YORK', 'CC MANCHESTER', 'CC LEEDS', 'LUCIA BEVERLEY'];
        
        orders.forEach(order => {
            if (!order.items || !Array.isArray(order.items)) return;
            
            order.items.forEach(item => {
                const productName = item.name || item.productName || 'Unknown';
                const unit = order.unit || order.restaurant || 'Unknown';
                const qty = parseFloat(item.qty) || parseFloat(item.quantity) || 0;
                const price = parseFloat(item.price) || parseFloat(item.unitPrice) || 0;
                
                if (!productStats[productName]) {
                    productStats[productName] = {
                        name: productName,
                        unit: item.unit || 'pcs',
                        byUnit: {},
                        totalQty: 0,
                        totalValue: 0
                    };
                }
                
                if (!productStats[productName].byUnit[unit]) {
                    productStats[productName].byUnit[unit] = 0;
                }
                productStats[productName].byUnit[unit] += qty;
                productStats[productName].totalQty += qty;
                productStats[productName].totalValue += qty * price;
            });
        });
        
        // Sort by total quantity and take top 5
        const topProducts = Object.values(productStats)
            .sort((a, b) => b.totalQty - a.totalQty)
            .slice(0, 5);
        
        if (topProducts.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-4 text-muted">
                        <i class="fas fa-shopping-cart fa-2x mb-2 opacity-25"></i>
                        <p class="mb-0">No order data available yet</p>
                        <small>Data will appear when orders are placed</small>
                    </td>
                </tr>`;
            return;
        }
        
        // Product icons mapping
        const productIcons = {
            'chicken': { icon: 'fa-drumstick-bite', color: 'text-danger' },
            'salmon': { icon: 'fa-fish', color: 'text-info' },
            'fish': { icon: 'fa-fish', color: 'text-info' },
            'beef': { icon: 'fa-drumstick-bite', color: 'text-danger' },
            'pork': { icon: 'fa-drumstick-bite', color: 'text-danger' },
            'salad': { icon: 'fa-leaf', color: 'text-success' },
            'lettuce': { icon: 'fa-leaf', color: 'text-success' },
            'tomato': { icon: 'fa-apple-alt', color: 'text-danger' },
            'cheese': { icon: 'fa-cheese', color: 'text-warning' },
            'mozzarella': { icon: 'fa-cheese', color: 'text-warning' },
            'bread': { icon: 'fa-bread-slice', color: '' },
            'pasta': { icon: 'fa-utensils', color: 'text-primary' },
            'rice': { icon: 'fa-seedling', color: 'text-success' },
            'potato': { icon: 'fa-circle', color: 'text-warning' }
        };
        
        function getProductIcon(name) {
            const lowerName = name.toLowerCase();
            for (const [key, value] of Object.entries(productIcons)) {
                if (lowerName.includes(key)) return value;
            }
            return { icon: 'fa-box', color: 'text-muted' };
        }
        
        tbody.innerHTML = topProducts.map(product => {
            const iconData = getProductIcon(product.name);
            const iconStyle = iconData.color ? `class="${iconData.color}"` : 'style="color: #d4a574;"';
            
            const unitQtys = units.map(u => {
                const qty = product.byUnit[u] || 0;
                return `<td class="text-center">${qty > 0 ? qty + ' ' + product.unit : '-'}</td>`;
            }).join('');
            
            return `
                <tr>
                    <td class="ps-4 fw-semibold"><i class="fas ${iconData.icon} me-2" ${iconStyle}></i>${product.name}</td>
                    ${unitQtys}
                    <td class="text-end fw-bold">${product.totalQty} ${product.unit}</td>
                    <td class="text-end text-success fw-bold">${product.totalValue.toFixed(2)}</td>
                </tr>
            `;
        }).join('');
    }

    // ==================== SMART ALERTS ====================
    function generateSmartAlerts() {
        const alerts = [];
        const today = new Date();
        const dayOfWeek = today.getDay(); // 0 = Sunday, 1 = Monday, etc.
        
        // 1. Stock Level Alerts - Check for low stock items
        const lowStockItems = stock.filter(item => {
            const current = parseFloat(item.current) || 0;
            const min = parseFloat(item.min) || 0;
            return current < min;
        });
        
        if (lowStockItems.length > 0) {
            const itemNames = lowStockItems.slice(0, 3).map(i => i.name).join(', ');
            const moreCount = lowStockItems.length > 3 ? ` +${lowStockItems.length - 3} more` : '';
            alerts.push({
                type: 'danger',
                icon: 'fa-exclamation-triangle',
                title: 'Low Stock Alert',
                message: `${itemNames}${moreCount} below minimum level`,
                detail: 'Order required to avoid stockout',
                action: 'View Stock'
            });
        }
        
        // 2. Weekend Demand Prediction (Friday check)
        if (dayOfWeek === 5) { // Friday
            // Find most ordered items from previous weekends
            const weekendOrders = orders.filter(o => {
                const orderDate = new Date(o.timestamp || o.date);
                const orderDay = orderDate.getDay();
                return orderDay === 0 || orderDay === 6; // Saturday or Sunday
            });
            
            if (weekendOrders.length > 0) {
                const weekendProducts = {};
                weekendOrders.forEach(order => {
                    (order.items || []).forEach(item => {
                        const name = item.name || item.productName;
                        weekendProducts[name] = (weekendProducts[name] || 0) + (parseFloat(item.qty) || 0);
                    });
                });
                
                const topWeekendItem = Object.entries(weekendProducts)
                    .sort((a, b) => b[1] - a[1])[0];
                
                if (topWeekendItem) {
                    alerts.push({
                        type: 'warning',
                        icon: 'fa-boxes',
                        title: 'Weekend Demand Alert',
                        message: `Increase ${topWeekendItem[0]} stock by 20%`,
                        detail: 'Based on previous weekend demand patterns',
                        action: 'Adjust Order'
                    });
                }
            }
        }
        
        // 3. Slow Moving Stock Alert
        const slowMoving = stock.filter(item => {
            const current = parseFloat(item.current) || 0;
            const max = parseFloat(item.max) || 0;
            return max > 0 && (current / max) > 0.8;
        });
        
        if (slowMoving.length > 0) {
            const item = slowMoving[0];
            alerts.push({
                type: 'info',
                icon: 'fa-chart-line',
                title: 'Slow Moving Stock',
                message: `${item.name} at ${Math.round((parseFloat(item.current) / parseFloat(item.max)) * 100)}% capacity`,
                detail: 'Consider running a promotion to clear excess stock',
                action: 'View Details'
            });
        }
        
        // 4. Tuesday Low Demand Prediction (for prep)
        if (dayOfWeek === 2) { // Tuesday
            const tuesdayOrders = orders.filter(o => {
                const orderDate = new Date(o.timestamp || o.date);
                return orderDate.getDay() === 2;
            });
            
            const otherDayOrders = orders.filter(o => {
                const orderDate = new Date(o.timestamp || o.date);
                const d = orderDate.getDay();
                return d >= 1 && d <= 4 && d !== 2; // Mon, Wed, Thu
            });
            
            if (tuesdayOrders.length > 0 && otherDayOrders.length > 0) {
                const tuesdayAvg = tuesdayOrders.reduce((sum, o) => sum + (o.items?.length || 0), 0) / tuesdayOrders.length;
                const otherAvg = otherDayOrders.reduce((sum, o) => sum + (o.items?.length || 0), 0) / otherDayOrders.length;
                
                if (tuesdayAvg < otherAvg * 0.8) {
                    const reduction = Math.round((1 - tuesdayAvg / otherAvg) * 100);
                    alerts.push({
                        type: 'info',
                        icon: 'fa-utensils',
                        title: 'Prep Alert',
                        message: `Reduce prep quantities by ${reduction}% today`,
                        detail: 'Tuesday typically has lower demand than other weekdays',
                        action: 'View Prep'
                    });
                }
            }
        }
        
        // 5. High Value Order Alert
        const recentHighValueOrders = orders.filter(o => {
            const orderTotal = (o.items || []).reduce((sum, item) => {
                return sum + ((parseFloat(item.qty) || 0) * (parseFloat(item.price) || 0));
            }, 0);
            return orderTotal > 500; // Orders over 500
        }).slice(0, 1);
        
        if (recentHighValueOrders.length > 0) {
            const order = recentHighValueOrders[0];
            const total = (order.items || []).reduce((sum, item) => {
                return sum + ((parseFloat(item.qty) || 0) * (parseFloat(item.price) || 0));
            }, 0);
            alerts.push({
                type: 'success',
                icon: 'fa-pound-sign',
                title: 'High Value Order',
                message: `${total.toFixed(0)} order from ${order.restaurant || order.unit || 'Unknown'}`,
                detail: 'Large order received - ensure adequate stock',
                action: 'View Order'
            });
        }
        
        // 6. GP Target Alert
        const currentGP = calculateCurrentGP();
        const targetGP = 70;
        if (currentGP < targetGP - 5) {
            alerts.push({
                type: 'warning',
                icon: 'fa-percentage',
                title: 'GP Alert',
                message: `Current GP (${currentGP.toFixed(1)}%) below target`,
                detail: `Target is ${targetGP}% - review pricing or costs`,
                action: 'Review Menu'
            });
        }
        
        renderSmartAlerts(alerts);
    }

    function renderSmartAlerts(alerts) {
        const container = document.getElementById('smart-alerts-container');
        const countBadge = document.getElementById('smart-alerts-count');
        
        if (!container) return;
        
        // Update count
        if (countBadge) {
            countBadge.textContent = `${alerts.length} Active`;
        }
        
        if (alerts.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-check-circle fa-2x mb-2 text-success"></i>
                    <p class="mb-0">No alerts at the moment</p>
                    <small>Everything looks good!</small>
                </div>`;
            return;
        }
        
        const alertColors = {
            danger: { bg: 'alert-danger', iconBg: 'bg-danger' },
            warning: { bg: 'alert-warning', iconBg: 'bg-warning' },
            info: { bg: 'alert-info', iconBg: 'bg-info' },
            success: { bg: 'alert-success', iconBg: 'bg-success' }
        };
        
        container.innerHTML = alerts.map((alert, index) => {
            const colors = alertColors[alert.type] || alertColors.info;
            const isLast = index === alerts.length - 1;
            return `
                <div class="alert ${colors.bg} ${isLast ? 'mb-0' : 'mb-3'}" style="border-radius: 12px; border: none;">
                    <div class="d-flex align-items-start gap-3">
                        <div class="${colors.iconBg} bg-opacity-25 rounded-circle p-2">
                            <i class="fas ${alert.icon} text-${alert.type}"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="fw-bold mb-1">${alert.title}</h6>
                            <p class="mb-1">${alert.message}</p>
                            <small class="text-muted"><i class="fas fa-info-circle me-1"></i>${alert.detail}</small>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function calculateCurrentGP() {
        const revenue = orders.reduce((sum, o) => {
            return sum + (o.items || []).reduce((itemSum, item) => {
                return itemSum + ((parseFloat(item.qty) || 0) * (parseFloat(item.price) || 0));
            }, 0);
        }, 0);
        
        // Estimate cost at 32% of revenue (typical food cost)
        const estimatedCost = revenue * 0.32;
        return revenue > 0 ? ((revenue - estimatedCost) / revenue * 100) : 68;
    }

    function updateDashboardStockAlerts() {
        updateDashboardStats();
        generateSmartAlerts();
    }

    // ==================== SUPABASE CLOUD SYNC ====================
    function loadSupabaseConfig() {
        const config = localStorage.getItem('supabaseConfig');
        if (config) {
            supabaseConfig = JSON.parse(config);
            document.getElementById('supabase-url').value = supabaseConfig.url || '';
            document.getElementById('supabase-key').value = supabaseConfig.key || '';
            initSupabase();
        }
    }

    function initSupabase() {
        if (supabaseConfig && supabaseConfig.url && supabaseConfig.key) {
            supabaseClient = supabase.createClient(supabaseConfig.url, supabaseConfig.key);
        }
    }

    
    function saveSupabaseConfig() {
        const url = document.getElementById('supabase-url').value.trim();
        const key = document.getElementById('supabase-key').value.trim();

        if (!url || !key) {
            showToast('Please enter both Supabase URL and API Key', 'error');
            return;
        }

        supabaseConfig = { url, key };
        localStorage.setItem('supabaseConfig', JSON.stringify(supabaseConfig));
        initSupabase();
        showToast('Supabase configuration saved', 'success');
        updateSyncStatus();
    }

    async function testSupabaseConnection() {
        if (!supabaseClient) {
            showToast('Please save configuration first', 'error');
            return;
        }

        showLoading(true);
        try {
            const { data, error } = await supabaseClient.from('sync_data').select('id').limit(1);
            if (error && error.code !== '42P01') {
                throw error;
            }
            showToast('Connection successful!', 'success');
            addSyncLog('Connection test successful');
        } catch (error) {
            showToast('Connection failed: ' + error.message, 'error');
            addSyncLog('Connection test failed: ' + error.message);
        } finally {
            showLoading(false);
        }
    }

    async function syncToSupabase(showToastMsg = true) {
        if (!supabaseClient) {
            if (showToastMsg) showToast('Please configure Supabase first', 'error');
            return;
        }

        showLoading(true);
        updateSyncStatus('syncing');

        const data = {
            inventory,
            orders,
            messages,
            weeklyData,
            meatData,
            buyersData,
            recipes,
            activityLog,
            prepSheets,
            prepTemplates,
            users,
            lastSync: new Date().toISOString()
        };

        try {
            const { error } = await supabaseClient
                .from('sync_data')
                .upsert({ 
                    id: 1, 
                    data: data,
                    updated_at: new Date().toISOString()
                }, { onConflict: 'id' });

            if (error) throw error;

            lastSyncTime = new Date().toISOString();
            saveAllData();
            updateSyncInfo();
            updateSyncStatus('synced');
            if (showToastMsg) showToast('Data synced to cloud successfully!', 'success');
            addSyncLog('Upload successful');
            logActivity('sync', 'Data uploaded to Supabase');
        } catch (error) {
            updateSyncStatus('error');
            if (showToastMsg) showToast('Sync failed: ' + error.message, 'error');
            addSyncLog('Upload failed: ' + error.message);
        } finally {
            showLoading(false);
        }
    }

    async function syncFromSupabase(showToastMsg = true) {
        if (!supabaseClient) {
            if (showToastMsg) showToast('Please configure Supabase first', 'error');
            return;
        }

        showLoading(true);
        updateSyncStatus('syncing');

        try {
            const { data: result, error } = await supabaseClient
                .from('sync_data')
                .select('data')
                .eq('id', 1)
                .single();

            if (error) throw error;

            if (result && result.data) {
                const data = result.data;

                if (data.inventory) inventory = data.inventory;
                if (data.orders) orders = data.orders;
                if (data.messages) messages = data.messages;
                if (data.weeklyData) weeklyData = data.weeklyData;
                if (data.meatData) meatData = data.meatData;
                if (data.buyersData) buyersData = data.buyersData;
                if (data.recipes) recipes = data.recipes;
                if (data.activityLog) activityLog = data.activityLog;
                if (data.prepSheets) prepSheets = data.prepSheets;
                if (data.prepTemplates) prepTemplates = data.prepTemplates;
                if (data.users) users = data.users;

                saveAllData();
                renderStock();
                renderDeliveryTracker();
                renderMessages();
                updateDashboardStats();
                updatePrepStats();
            }

            lastSyncTime = new Date().toISOString();
            updateSyncInfo();
            updateSyncStatus('synced');
            if (showToastMsg) showToast('Data downloaded from cloud!', 'success');
            addSyncLog('Download successful');
            logActivity('sync', 'Data downloaded from Supabase');
        } catch (error) {
            updateSyncStatus('error');
            if (showToastMsg) showToast('Download failed: ' + error.message, 'error');
            addSyncLog('Download failed: ' + error.message);
        } finally {
            showLoading(false);
        }
    }

    async function mergeSupabaseData() {
        if (!supabaseClient) {
            showToast('Please configure Supabase first', 'error');
            return;
        }

        showLoading(true);
        updateSyncStatus('syncing');

        try {
            const { data: result, error } = await supabaseClient
                .from('sync_data')
                .select('data')
                .eq('id', 1)
                .single();

            if (error) throw error;

            if (result && result.data) {
                const cloudData = result.data;

                if (cloudData) {
                    if (cloudData.orders) {
                        const localOrderIds = new Set(orders.map(o => o.id));
                        const newOrders = cloudData.orders.filter(o => !localOrderIds.has(o.id));
                        orders = [...orders, ...newOrders];
                    }

                    if (cloudData.messages) {
                        const localMsgIds = new Set(messages.map(m => m.id));
                        const newMessages = cloudData.messages.filter(m => !localMsgIds.has(m.id));
                        messages = [...messages, ...newMessages];
                    }

                    if (cloudData.prepSheets) {
                        Object.entries(cloudData.prepSheets).forEach(([date, sheet]) => {
                            if (!prepSheets[date]) {
                                prepSheets[date] = sheet;
                            } else {
                                const localItemIds = new Set(prepSheets[date].items.map(i => i.id));
                                const newItems = sheet.items.filter(i => !localItemIds.has(i.id));
                                prepSheets[date].items = [...prepSheets[date].items, ...newItems];
                            }
                        });
                    }

                    saveAllData();
                    renderStock();
                    renderDeliveryTracker();
                    renderMessages();
                    updateDashboardStats();
                    updatePrepStats();
                }

                lastSyncTime = new Date().toISOString();
                updateSyncInfo();
                updateSyncStatus('synced');
                showToast('Data merged successfully!', 'success');
                addSyncLog('Merge successful');
                logActivity('sync', 'Data merged from Supabase');
            } else {
                throw new Error('Merge failed');
            }
        } catch (error) {
            updateSyncStatus('error');
            showToast('Merge failed: ' + error.message, 'error');
            addSyncLog('Merge failed: ' + error.message);
        } finally {
            showLoading(false);
        }
    }

    function toggleAutoSyncSupabase() {
        autoSyncEnabled = document.getElementById('auto-sync-toggle').checked;
        localStorage.setItem('autoSyncEnabled', autoSyncEnabled);

        if (autoSyncEnabled) {
            startAutoSync();
            showToast('Auto-sync enabled', 'success');
        } else {
            stopAutoSync();
            showToast('Auto-sync disabled', 'info');
        }
    }


    function toggleStartupSync() {
        startupSyncEnabled = document.getElementById('startup-sync-toggle').checked;
        localStorage.setItem('startupSyncEnabled', startupSyncEnabled);
    }

    function startAutoSync() {
        if (autoSyncInterval) clearInterval(autoSyncInterval);
        autoSyncInterval = setInterval(() => {
            if (supabaseClient) {
                syncToSupabase(false);
            }
        }, 5 * 60 * 1000); // Every 5 minutes
    }

    function stopAutoSync() {
        if (autoSyncInterval) {
            clearInterval(autoSyncInterval);
            autoSyncInterval = null;
        }
    }

    function updateSyncInfo() {
        const lastSyncEl = document.getElementById('last-sync-time');
        if (lastSyncTime) {
            lastSyncEl.textContent = new Date(lastSyncTime).toLocaleString('en-GB');
        } else {
            lastSyncEl.textContent = 'Never';
        }
        
        // Calculate data size
        const dataSize = JSON.stringify({ inventory, orders, messages, weeklyData, prepSheets }).length;
        document.getElementById('data-size').textContent = (dataSize / 1024).toFixed(2) + ' KB';
        
        // Update toggle states
        document.getElementById('auto-sync-toggle').checked = autoSyncEnabled;
        document.getElementById('startup-sync-toggle').checked = startupSyncEnabled;
    }

    function addSyncLog(message) {
        const logContainer = document.getElementById('sync-log');
        const timestamp = new Date().toLocaleTimeString('en-GB');
        const entry = document.createElement('div');
        entry.className = 'mb-1';
        entry.innerHTML = `<span class="text-muted">[${timestamp}]</span> ${message}`;
        logContainer.insertBefore(entry, logContainer.firstChild);
    }

    function updateSyncStatus(status) {
        const indicator = document.getElementById('sync-status');
        const text = document.getElementById('sync-text');
        
        indicator.className = 'sync-status-indicator';
        
        if (!supabaseClient) {
            indicator.classList.add('offline');
            text.textContent = 'Local Only';
        } else if (status === 'syncing') {
            indicator.classList.add('syncing');
            text.textContent = 'Syncing...';
        } else if (status === 'synced') {
            indicator.classList.add('synced');
            text.textContent = 'Synced';
        } else if (status === 'error') {
            indicator.classList.add('error');
            text.textContent = 'Sync Error';
        } else {
            indicator.classList.add(lastSyncTime ? 'synced' : 'offline');
            text.textContent = lastSyncTime ? 'Synced' : 'Local Only';
        }
    }

    // ==================== BULK CSV IMPORT/EXPORT ====================
    let csvPreviewData = [];

    function openBulkImportModal() {
        csvPreviewData = [];
        document.getElementById('csv-upload').value = '';
        document.getElementById('csv-preview-container').classList.add('hidden');
        document.getElementById('import-csv-btn').disabled = true;
        document.getElementById('csv-import-status').innerHTML = '';
        new bootstrap.Modal(document.getElementById('bulkImportModal')).show();
    }

    function downloadCSVTemplate() {
        const template = 'name,category,unit,cost,minStock,stock,maxOrder\n' +
            'Chicken Breast,meat,kg,8.50,10,25,0\n' +
            'Beef Mince,meat,kg,7.20,8,15,0\n' +
            'Tomatoes,produce,kg,2.50,15,30,0\n' +
            'Olive Oil,oils,L,12.00,3,8,0\n' +
            'Tomato Sauce,sauces,L,3.50,5,12,0';
        
        const blob = new Blob([template], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'product-import-template.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast('Template downloaded', 'success');
    }

    function previewCSV() {
        const fileInput = document.getElementById('csv-upload');
        const file = fileInput.files[0];
        
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            const lines = text.split('\n').filter(line => line.trim());
            
            if (lines.length < 2) {
                showToast('CSV file is empty or invalid', 'error');
                return;
            }
            
            // Parse header
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
            const requiredFields = ['name', 'category', 'unit', 'cost', 'minstock', 'stock'];
            const missingFields = requiredFields.filter(f => !headers.includes(f));
            
            if (missingFields.length > 0) {
                showToast('Missing required columns: ' + missingFields.join(', '), 'error');
                return;
            }
            
            // Parse data rows
            csvPreviewData = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                if (values.length < 6) continue;
                
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                
                csvPreviewData.push({
                    name: row.name,
                    category: row.category,
                    unit: row.unit,
                    cost: parseFloat(row.cost) || 0,
                    minStock: parseInt(row.minstock) || 0,
                    stock: parseInt(row.stock) || 0,
                    maxOrder: parseInt(row.maxorder) || 0
                });
            }
            
            // Show preview
            document.getElementById('csv-row-count').textContent = csvPreviewData.length;
            const tbody = document.getElementById('csv-preview-body');
            tbody.innerHTML = csvPreviewData.slice(0, 10).map(item => `
                <tr>
                    <td>${item.name}</td>
                    <td><span class="badge bg-light text-dark">${item.category}</span></td>
                    <td>${item.unit}</td>
                    <td>${item.cost.toFixed(2)}</td>
                    <td>${item.minStock}</td>
                    <td>${item.stock}</td>
                    <td>${item.maxOrder || 'Unlimited'}</td>
                </tr>
            `).join('');
            
            if (csvPreviewData.length > 10) {
                tbody.innerHTML += `<tr><td colspan="7" class="text-center text-muted">... and ${csvPreviewData.length - 10} more</td></tr>`;
            }
            
            document.getElementById('csv-preview-container').classList.remove('hidden');
            document.getElementById('import-csv-btn').disabled = false;
        };
        
        reader.readAsText(file);
    }

    function importCSV() {
        if (csvPreviewData.length === 0) {
            showToast('No data to import', 'error');
            return;
        }
        
        let importedCount = 0;
        let updatedCount = 0;
        
        csvPreviewData.forEach(item => {
            // Check if product already exists
            const existingIndex = inventory.findIndex(p => p.name.toLowerCase() === item.name.toLowerCase());
            
            if (existingIndex > -1) {
                // Update existing product
                inventory[existingIndex] = {
                    ...inventory[existingIndex],
                    category: item.category,
                    unit: item.unit,
                    cost: item.cost,
                    minStock: item.minStock,
                    stock: item.stock,
                    maxOrder: item.maxOrder
                };
                updatedCount++;
            } else {
                // Add new product
                const newProduct = {
                    id: 'prod-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                    name: item.name,
                    category: item.category,
                    unit: item.unit,
                    cost: item.cost,
                    minStock: item.minStock,
                    stock: item.stock,
                    maxOrder: item.maxOrder
                };
                inventory.push(newProduct);
                importedCount++;
            }
        });
        
        saveAllData();
        renderStock();
        renderOrderItems();
        
        const statusEl = document.getElementById('csv-import-status');
        statusEl.innerHTML = `
            <div class="alert alert-success" style="border-radius: 12px;">
                <i class="fas fa-check-circle me-2"></i>
                <strong>Import Complete!</strong> ${importedCount} new products added, ${updatedCount} products updated.
            </div>
        `;
        
        document.getElementById('import-csv-btn').disabled = true;
        
        showToast(`Imported ${importedCount} new, updated ${updatedCount} products`, 'success');
        logActivity('import', `Bulk CSV import: ${importedCount} new, ${updatedCount} updated`);
    }

    function exportFilteredCSV() {
        const search = document.getElementById('stock-search')?.value.toLowerCase() || '';
        const category = document.getElementById('stock-category')?.value || 'all';
        
        let filtered = [...inventory];
        if (search) filtered = filtered.filter(p => p.name.toLowerCase().includes(search));
        if (category !== 'all') filtered = filtered.filter(p => p.category === category);
        
        if (filtered.length === 0) {
            showToast('No products to export with current filters', 'warning');
            return;
        }
        
        let csv = 'name,category,unit,cost,minStock,stock,maxOrder\n';
        filtered.forEach(p => {
            csv += `"${p.name}",${p.category},${p.unit},${p.cost},${p.minStock},${p.stock},${p.maxOrder || 0}\n`;
        });
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        
        const filterSuffix = category !== 'all' ? `-${category}` : '';
        const searchSuffix = search ? `-search-${search.substring(0, 10)}` : '';
        a.download = `inventory-export${filterSuffix}${searchSuffix}-${new Date().toISOString().split('T')[0]}.csv`;
        
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast(`${filtered.length} products exported to CSV`, 'success');
        logActivity('export', `Filtered CSV export: ${filtered.length} products`);
    }

    // ==================== EXPORT FUNCTIONS ====================
    function exportData() {
        const data = {
            inventory,
            orders,
            messages,
            weeklyData,
            meatData,
            buyersData,
            recipes,
            activityLog,
            prepSheets,
            prepTemplates,
            exportDate: new Date().toISOString()
        };
        
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `cc-lucia-backup-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast('Backup downloaded successfully', 'success');
        logActivity('export', 'Full data backup exported');
    }

    // ==================== ADVANCED ANALYTICS DASHBOARD ====================
    let revenueCostChart = null;
    function exportToCSV(type) {
        let csv = '';
        let filename = '';
        
        if (type === 'orders') {
            csv = 'Invoice #,Date,Unit,Items,Subtotal,VAT,Total,Tax Week,Status\n';
            orders.forEach(o => {
                csv += `${o.invoiceNumber},${new Date(o.date).toLocaleDateString('en-GB')},${o.unit},${o.items.length},${o.subtotal.toFixed(2)},${o.vat.toFixed(2)},${o.total.toFixed(2)},${o.taxWeek},${o.status}\n`;
            });
            filename = 'orders.csv';
        } else if (type === 'inventory') {
            csv = 'Name,Category,Unit,Cost,Min Stock,Current Stock\n';
            inventory.forEach(p => {
                csv += `${p.name},${p.category},${p.unit},${p.cost},${p.minStock},${p.stock}\n`;
            });
            filename = 'inventory.csv';
        } else if (type === 'analytics') {
            csv = 'Week,Net Income,Purchases,Wastage,Gross Profit\n';
            for (let i = 1; i <= 52; i++) {
                const data = weeklyData[i] || {};
                const netIncome = (data.meatSales || 0) + (data.dessertSales || 0);
                const gp = netIncome - (data.purchases || 0) - (data.wastage || 0);
                csv += `${i},${netIncome.toFixed(2)},${(data.purchases || 0).toFixed(2)},${(data.wastage || 0).toFixed(2)},${gp.toFixed(2)}\n`;
            }
            filename = 'analytics.csv';
        }
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `cc-lucia-${filename}`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast(`${type} exported to CSV`, 'success');
    }

    // ==================== UTILITY FUNCTIONS ====================
    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast-item ${type}`;
        
        const icons = {
            success: 'check-circle',
            error: 'exclamation-circle',
            warning: 'exclamation-triangle',
            info: 'info-circle',
            prep: 'utensils',
            ai: 'brain'
        };
        
        toast.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas fa-${icons[type] || 'info-circle'} me-2"></i>
                <span>${message}</span>
            </div>
        `;
        
        container.appendChild(toast);
        
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(100%)';
            setTimeout(() => toast.remove(), 300);
        }, 4000);
    }

    function showLoading(show) {
        document.getElementById('loading').style.display = show ? 'flex' : 'none';
    }

    function createConfetti() {
        const colors = ['#ff6b35', '#f7931e', '#10b981', '#3b82f6', '#ec4899'];
        for (let i = 0; i < 50; i++) {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.cssText = `
                position: fixed;
                width: 10px;
                height: 10px;
                background: ${colors[Math.floor(Math.random() * colors.length)]};
                left: ${Math.random() * 100}vw;
                animation-duration: ${2 + Math.random() * 2}s;
                z-index: 9999;
                border-radius: ${Math.random() > 0.5 ? '50%' : '0'};
            `;
            document.body.appendChild(confetti);
            setTimeout(() => confetti.remove(), 4000);
        }
    }
    </script>

</body>
</html>